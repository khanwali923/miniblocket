<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Miniblocket</title>
  <style>
    :root {
      --primary: #0ea5e9;
      --danger: #ef4444;
      --success: #10b981;
      --bg: #f8fafc;
      --text: #0f172a;
      --border: #e2e8f0;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, -apple-system, sans-serif; }
    
    body { background: var(--bg); color: var(--text); overflow-x: hidden; max-width: 100vw; }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    .hidden { display: none !important; }
    
    /* Nav */
    nav { background: white; border-bottom: 1px solid var(--border); padding: 15px 0; position: sticky; top: 0; z-index: 100; }
    .nav { display: flex; justify-content: space-between; align-items: center; }
    .brand { cursor: pointer; font-weight: 800; font-size: 20px; display: flex; align-items: center; gap: 10px; }
    .logo { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), #8b5cf6); color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    
    .btn { padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-soft { background: #f1f5f9; border: 1px solid var(--border); }
    .btn-danger { background: #fee2e2; color: #991b1b; }
    .btn-success { background: var(--success); color: white; }
    .btn-warning { background: #fef3c7; color: #92400e; }
    
    .avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #fb923c, #ec4899); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; cursor: pointer; touch-action: manipulation; }
    
    /* Layout */
    .page { display: none; padding: 20px 0; min-height: calc(100vh - 80px); }
    .page.active { display: block; }
    
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
    
    .card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); cursor: pointer; transition: transform 0.2s; border: 1px solid var(--border); touch-action: manipulation; }
    .card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.12); }
    .card.sold { opacity: 0.6; filter: grayscale(0.8); pointer-events: none; position: relative; }
    .card.sold::after { content: 'S√ÖLD'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); background: var(--danger); color: white; padding: 10px 30px; font-weight: 900; font-size: 24px; border-radius: 8px; }
    .card.pending { opacity: 0.7; }
    
    .card-img { width: 100%; height: 200px; object-fit: cover; background: #f1f5f9; }
    .card-body { padding: 16px; }
    .card-title { font-weight: 700; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .card-price { color: var(--primary); font-weight: 800; font-size: 18px; }
    .card-meta { display: flex; justify-content: space-between; margin-top: 12px; font-size: 14px; color: #64748b; align-items: center; }
    
    .badge-pending { position: absolute; top: 10px; right: 10px; background: #f59e0b; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; }
    .badge-sold { background: var(--danger); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; display: inline-block; margin-bottom: 8px; }
    .badge-active { background: var(--success); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; display: inline-block; margin-bottom: 8px; }
    
    .fav-btn { position: absolute; top: 10px; right: 10px; width: 36px; height: 36px; border-radius: 50%; border: none; background: white; cursor: pointer; font-size: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 5; touch-action: manipulation; transition: all 0.2s; }
    .fav-btn:hover { transform: scale(1.1); }
    .fav-btn.active { background: #fee2e2; }
    
    /* Forms */
    input, select, textarea { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 12px; font-size: 16px; margin-bottom: 12px; touch-action: manipulation; }
    input:focus, select:focus { border-color: var(--primary); outline: none; }
    
    .search-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
    .search-bar input, .search-bar select { flex: 1; min-width: 200px; margin-bottom: 0; }
    
    .cats { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 20px; -webkit-overflow-scrolling: touch; }
    .cat { padding: 10px 20px; border: 2px solid var(--border); border-radius: 20px; background: white; cursor: pointer; white-space: nowrap; font-weight: 600; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
    .cat.active { background: var(--primary); color: white; border-color: var(--primary); }
    
    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal.show { display: flex; }
    .modal-box { background: white; border-radius: 20px; width: 100%; max-width: 800px; max-height: 90vh; overflow: auto; }
    .modal-head { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; z-index: 10; }
    .modal-body { padding: 20px; }
    
    .close-btn { width: 36px; height: 36px; border-radius: 50%; border: none; background: #f1f5f9; cursor: pointer; font-size: 20px; touch-action: manipulation; }
    
    /* Profile */
    .profile-grid { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
    @media (max-width: 768px) { .profile-grid { grid-template-columns: 1fr; } }
    
    .panel { background: white; border-radius: 16px; border: 1px solid var(--border); overflow: hidden; }
    .panel-header { padding: 20px; background: linear-gradient(135deg, #e0f2fe, #fce7f3); }
    .panel-body { padding: 20px; }
    
    .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px 0; }
    .stat-box { text-align: center; padding: 16px; background: #f8fafc; border-radius: 12px; }
    .stat-num { font-size: 24px; font-weight: 800; color: var(--primary); }
    .stat-label { font-size: 12px; color: #64748b; text-transform: uppercase; margin-top: 4px; }
    
    .tab-bar { display: flex; background: #f1f5f9; padding: 6px; border-radius: 12px; margin-bottom: 20px; }
    .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 600; color: #64748b; touch-action: manipulation; }
    .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    
    .list-item { display: flex; gap: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); align-items: center; touch-action: manipulation; }
    .list-item:hover { border-color: var(--primary); }
    .item-thumb { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; background: #e2e8f0; flex-shrink: 0; }
    .item-content { flex: 1; }
    .item-title { font-weight: 700; margin-bottom: 4px; }
    .item-meta { font-size: 14px; color: #64748b; }
    .item-actions { display: flex; gap: 8px; margin-top: 8px; }
    
    /* Chat */
    .chat-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; }
    .chat-overlay.show { display: block; }
    .chat-panel { display: none; position: fixed; top: 0; right: 0; height: 100vh; width: 100%; max-width: 450px; background: white; z-index: 201; box-shadow: -10px 0 30px rgba(0,0,0,0.2); }
    .chat-panel.show { display: flex; flex-direction: column; }
    .chat-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .chat-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .chat-conv { padding: 16px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; gap: 12px; position: relative; touch-action: manipulation; }
    .chat-conv:hover { background: #f8fafc; }
    .chat-conv.active { background: #e0f2fe; border-left: 4px solid var(--primary); }
    .delete-conv { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); opacity: 0; cursor: pointer; padding: 5px; touch-action: manipulation; }
    .chat-conv:hover .delete-conv { opacity: 1; }
    .chat-main { flex: 1; display: flex; flex-direction: column; position: relative; }
    
    .chat-product-info {
      background: #f8fafc;
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .chat-product-info:hover { background: #e0f2fe; }
    .chat-product-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; flex-shrink: 0; border: 1px solid var(--border); }
    .chat-product-details { flex: 1; min-width: 0; }
    .chat-product-title { font-weight: 700; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
    .chat-product-price { color: var(--primary); font-weight: 700; font-size: 14px; }
    .chat-product-label { font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; background: #f8fafc; -webkit-overflow-scrolling: touch; }
    .msg { max-width: 80%; padding: 12px 16px; border-radius: 16px; line-height: 1.4; word-break: break-word; }
    .msg.sent { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
    .msg.received { background: white; border: 1px solid var(--border); align-self: flex-start; border-bottom-left-radius: 4px; }
    .msg-time { font-size: 11px; opacity: 0.7; margin-top: 4px; }
    .chat-input { padding: 16px; border-top: 1px solid var(--border); display: flex; gap: 12px; background: white; }
    .chat-input input { flex: 1; margin-bottom: 0; }
    .send-btn { width: 44px; height: 44px; border-radius: 50%; border: none; background: var(--primary); color: white; cursor: pointer; font-size: 18px; touch-action: manipulation; flex-shrink: 0; }
    
    /* Admin */
    .admin-badge { background: var(--danger); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 800; margin-left: 10px; }
    .admin-nav { display: flex; flex-direction: column; gap: 8px; }
    .admin-nav-item { padding: 12px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #64748b; display: flex; justify-content: space-between; align-items: center; touch-action: manipulation; }
    .admin-nav-item:hover, .admin-nav-item.active { background: var(--primary); color: white; }
    .count-badge { background: var(--danger); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
    
    .status-badge-small { font-size: 11px; padding: 4px 8px; border-radius: 12px; font-weight: 700; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-active { background: #d1fae5; color: #065f46; }
    .status-sold { background: #fee2e2; color: #991b1b; }
    
    /* Image preview */
    .img-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 10px 0; }
    .img-preview { aspect-ratio: 1; border-radius: 8px; overflow: hidden; position: relative; border: 1px solid var(--border); }
    .img-preview img { width: 100%; height: 100%; object-fit: cover; }
    .remove-img { position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; border-radius: 50%; border: none; background: rgba(255,255,255,0.9); cursor: pointer; color: var(--danger); font-weight: 700; touch-action: manipulation; }
    
    .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
    .file-input-wrapper input[type=file] { position: absolute; left: -9999px; }
    .file-input-label { display: block; padding: 12px; background: #f1f5f9; border: 2px dashed var(--border); border-radius: 12px; text-align: center; cursor: pointer; margin-bottom: 12px; }
    .file-input-label:hover { border-color: var(--primary); background: #e0f2fe; }
    
    /* Toast */
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #0f172a; color: white; padding: 14px 28px; border-radius: 12px; font-weight: 600; z-index: 3000; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none; max-width: 90%; text-align: center; }
    .toast.show { display: block; animation: slideUp 0.3s; }
    @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
    
    .menu-dropdown { position: absolute; top: 60px; right: 20px; background: white; border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); min-width: 200px; overflow: hidden; z-index: 150; }
    .menu-item { padding: 14px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 600; touch-action: manipulation; }
    .menu-item:hover { background: #f8fafc; color: var(--primary); }
    .menu-divider { border-top: 1px solid var(--border); margin: 4px 0; }

    @media (max-width: 768px) {
      .container { padding: 0 12px; }
      body { font-size: 16px; }
      
      .nav { flex-wrap: wrap; gap: 8px; }
      .brand span { font-size: 16px; }
      .brand { gap: 8px; }
      .logo { width: 36px; height: 36px; font-size: 18px; }
      
      .search-bar { flex-direction: column; gap: 10px; }
      .search-bar input, .search-bar select { min-width: 100%; width: 100%; margin-bottom: 0; }
      
      .cats { gap: 8px; padding: 8px 0; margin-bottom: 16px; }
      .cat { padding: 8px 14px; font-size: 14px; }
      
      .grid { grid-template-columns: 1fr; gap: 16px; }
      .card-img { height: 240px; }
      
      .modal { padding: 0; align-items: flex-end; }
      .modal-box { max-width: 100%; max-height: 95vh; border-radius: 20px 20px 0 0; width: 100%; }
      
      #productModal .modal-body { grid-template-columns: 1fr; gap: 16px; max-height: calc(95vh - 80px); overflow-y: auto; }
      
      #modalImg { height: 250px; }
      #modalThumbs { flex-wrap: nowrap; overflow-x: auto; gap: 8px; padding-bottom: 8px; -webkit-overflow-scrolling: touch; }
      
      #sellModal .modal-body > div[style*="grid-template-columns"] { grid-template-columns: 1fr !important; }
      #authModal .modal-box { margin: 0 10px; max-width: 100%; }
      
      .chat-panel { max-width: 100%; width: 100%; }
      .chat-conv { padding: 12px; }
      .chat-conv.active { border-left: none; border-right: 4px solid var(--primary); }
      .chat-header { padding: 12px 16px; }
      
      .chat-product-info { padding: 10px 12px; }
      .chat-product-img { width: 44px; height: 44px; }
      .chat-product-title { font-size: 13px; }
      .chat-product-price { font-size: 13px; }
      
      .profile-grid { gap: 16px; }
      .panel-body { padding: 16px; }
      .panel-header { padding: 16px; height: 80px; }
      
      .stat-grid { grid-template-columns: repeat(3, 1fr); gap: 8px; }
      .stat-box { padding: 12px 4px; }
      .stat-num { font-size: 20px; }
      .stat-label { font-size: 10px; }
      
      .list-item { flex-wrap: wrap; gap: 12px; padding: 12px; }
      .item-thumb { width: 60px; height: 60px; }
      .item-actions { width: 100%; margin-top: 8px; justify-content: flex-start; }
      .item-actions .btn { flex: 1; justify-content: center; }
      
      .admin-nav-item { padding: 14px 12px; font-size: 14px; }
      .img-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
      
      .btn { padding: 12px 16px; min-height: 44px; }
      .tab-btn { padding: 12px 8px; font-size: 14px; }
      .menu-dropdown { right: 10px; left: 10px; min-width: auto; top: 70px; }
      
      #reportModal .modal-box, #deleteModal .modal-box { margin: 0 10px; }
      #modalActions { flex-direction: column; width: 100%; }
      #modalActions .btn { width: 100%; justify-content: center; }
      #ownerActions .btn { width: 100%; margin-bottom: 8px; }
      #sellBtn { padding: 8px 12px; font-size: 14px; }
    }

    @media (max-width: 380px) {
      .card-img { height: 200px; }
      .nav { padding: 10px 0; }
      .btn { padding: 10px 14px; font-size: 14px; }
      .brand span { font-size: 14px; }
      .stat-label { font-size: 9px; }
      .badge-pending { font-size: 11px; padding: 4px 8px; }
      .modal-head h3 { font-size: 18px; }
      .chat-product-img { width: 40px; height: 40px; }
      .chat-product-title { font-size: 12px; }
      .chat-product-price { font-size: 12px; }
    }

    @supports (-webkit-touch-callout: none) {
      .page { min-height: -webkit-fill-available; }
      .chat-panel { height: -webkit-fill-available; }
      .modal { align-items: flex-end; padding-bottom: env(safe-area-inset-bottom); }
    }

    input, select, textarea { font-size: 16px; }
    
    .chat-list, .chat-messages, #modalThumbs, .cats {
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
    }

    @media (hover: none) {
      .delete-conv { opacity: 1; background: rgba(255,255,255,0.9); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
    }

    @media (max-height: 500px) and (orientation: landscape) {
      .modal-box { max-height: 98vh; }
      .chat-panel { max-width: 100%; }
      #productModal .modal-body { max-height: calc(98vh - 60px); }
      .card-img { height: 150px; }
      .chat-product-info { padding: 8px 12px; }
    }
  </style>
<base target="_blank">
</head>
<body>

<nav>
  <div class="container nav">
    <div class="brand" onclick="showHome()">
      <div class="logo">üë∂</div>
      <span>Miniblocket</span>
    </div>
    <div style="display: flex; align-items: center; gap: 10px;">
      <button class="btn btn-soft" id="authBtn" onclick="openAuth()">Logga in</button>
      <button class="btn btn-primary hidden" id="sellBtn" onclick="openSellModal()">+ S√§lj</button>
      <button class="btn btn-soft hidden" id="chatBtn" onclick="openChat()" style="position: relative;">
        üí¨
        <span id="chatBadge" class="hidden" style="position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: 800;">0</span>
      </button>
      <div class="avatar hidden" id="userAvatar" onclick="toggleMenu(event)">??</div>
    </div>
  </div>
</nav>

<div id="userMenu" class="menu-dropdown hidden">
  <div class="menu-item" onclick="showProfile()">üë§ Min profil</div>
  <div class="menu-item hidden" id="adminMenuItem" onclick="showAdmin()">‚öôÔ∏è Admin panel</div>
  <div class="menu-divider"></div>
  <div class="menu-item" onclick="logout()" style="color: var(--danger);">üö™ Logga ut</div>
</div>

<!-- Pages -->
<div id="pageHome" class="page active">
  <div class="container">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="S√∂k annonser..." onkeyup="renderProducts()">
      <select id="filterLoc" onchange="renderProducts()">
        <option value="">Alla platser</option>
        <option>Stockholm</option>
        <option>G√∂teborg</option>
        <option>Malm√∂</option>
        <option>Uppsala</option>
      </select>
    </div>
    
    <div class="cats">
      <button class="cat active" onclick="setCat('all', this)">Allt</button>
      <button class="cat" onclick="setCat('leksaker', this)">üß∏ Leksaker</button>
      <button class="cat" onclick="setCat('barnvagn', this)">üçº Barnvagnar</button>
      <button class="cat" onclick="setCat('bilbarnstol', this)">üöó Bilbarnstolar</button>
      <button class="cat" onclick="setCat('kl√§der', this)">üëï Kl√§der</button>
      <button class="cat" onclick="setCat('m√∂bler', this)">üõèÔ∏è M√∂bler</button>
    </div>

    <div id="productsGrid" class="grid"></div>
    <div id="noResults" class="hidden" style="text-align: center; padding: 60px; color: #64748b;">
      <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>
      <div style="font-weight: 700; font-size: 18px;">Inga annonser hittades</div>
    </div>
  </div>
</div>

<div id="pageProfile" class="page">
  <div class="container">
    <button class="btn btn-soft" onclick="showHome()" style="margin-bottom: 20px;">‚Üê Tillbaka</button>
    
    <div class="profile-grid">
      <div class="panel">
        <div class="panel-header" style="height: 100px; position: relative;">
          <div style="position: absolute; bottom: -40px; left: 20px;">
            <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #fb923c, #ec4899); display: flex; align-items: center; justify-content: center; color: white; font-size: 28px; font-weight: 800; border: 4px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" id="pAvatar">??</div>
          </div>
        </div>
        <div class="panel-body" style="padding-top: 50px;">
          <div style="font-weight: 800; font-size: 20px;" id="pName">--</div>
          <div style="color: #64748b; margin-bottom: 20px;" id="pEmail">--</div>
          
          <div class="stat-grid">
            <div class="stat-box">
              <div class="stat-num" id="statAds">0</div>
              <div class="stat-label">Annonser</div>
            </div>
            <div class="stat-box">
              <div class="stat-num" id="statChats">0</div>
              <div class="stat-label">Chattar</div>
            </div>
            <div class="stat-box">
              <div class="stat-num" id="statFavs">0</div>
              <div class="stat-label">Favoriter</div>
            </div>
          </div>
          
          <button class="btn btn-primary" style="width: 100%;" onclick="openSellModal()">+ Ny annons</button>
        </div>
      </div>
      
      <div>
        <div class="tab-bar">
          <button class="tab-btn active" onclick="switchTab('active', this)">Aktiva</button>
          <button class="tab-btn" onclick="switchTab('history', this)">Historik</button>
          <button class="tab-btn" onclick="switchTab('favorites', this)">Favoriter</button>
        </div>
        
        <div id="tabContent"></div>
      </div>
    </div>
  </div>
</div>

<div id="pageAdmin" class="page">
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
      <button class="btn btn-soft" onclick="showHome()">‚Üê Tillbaka</button>
      <h2>Administration <span style="background: var(--danger); color: white; padding: 4px 12px; border-radius: 12px; font-size: 14px;">ADMIN</span></h2>
    </div>
    
    <div class="profile-grid">
      <div class="panel">
        <div class="panel-body">
          <div class="admin-nav">
            <div class="admin-nav-item active" onclick="setAdminTab('overview', this)">
              <span>üìä √ñversikt</span>
            </div>
            <div class="admin-nav-item" onclick="setAdminTab('pending', this)">
              <span>‚è≥ Granskning</span>
              <span class="count-badge hidden" id="badgePending">0</span>
            </div>
            <div class="admin-nav-item" onclick="setAdminTab('reports', this)">
              <span>üö® Anm√§lningar</span>
              <span class="count-badge hidden" id="badgeReports">0</span>
            </div>
            <div class="admin-nav-item" onclick="setAdminTab('users', this)">
              <span>üë• Anv√§ndare</span>
            </div>
          </div>
        </div>
      </div>
      
      <div id="adminContent">
        <!-- Dynamic content loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="authModal" class="modal" onclick="if(event.target === this) closeModal('authModal')">
  <div class="modal-box" style="max-width: 400px;">
    <div class="modal-head">
      <h3 id="authTitle">Logga in</h3>
      <button class="close-btn" onclick="closeModal('authModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <form onsubmit="event.preventDefault(); handleAuth();">
        <div id="authNameField" class="hidden">
          <label style="font-weight: 600; display: block; margin-bottom: 6px;">Namn</label>
          <input type="text" id="authName" placeholder="Ditt namn">
        </div>
        
        <label style="font-weight: 600; display: block; margin-bottom: 6px; margin-top: 12px;">E-post</label>
        <input type="email" id="authEmail" placeholder="namn@exempel.se" required>
        
        <label style="font-weight: 600; display: block; margin-bottom: 6px; margin-top: 12px;">L√∂senord</label>
        <input type="password" id="authPass" placeholder="Minst 6 tecken" required minlength="6">
        
        <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
          <button type="submit" class="btn btn-primary" id="authActionBtn" style="width: 100%;">Logga in</button>
          <button type="button" class="btn btn-soft" onclick="toggleAuthMode()" style="width: 100%;" id="authToggleBtn">Skapa konto ist√§llet</button>
          <div id="forgotPasswordLink" class="hidden" style="text-align: center; margin-top: 10px;">
  <a href="#" onclick="forgotPassword()" style="color: var(--primary); font-size: 14px;">Gl√∂mt l√∂senord?</a>
</div>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="forgotPasswordModal" class="modal" onclick="if(event.target === this) closeModal('forgotPasswordModal')">
  <div class="modal-box" style="max-width: 400px;">
    <div class="modal-head">
      <h3>√Öterst√§ll l√∂senord</h3>
      <button class="close-btn" onclick="closeModal('forgotPasswordModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <form onsubmit="event.preventDefault(); submitForgotPassword();">
        <label style="font-weight: 600;">Ange din e-postadress</label>
        <input type="email" id="forgotEmail" placeholder="namn@exempel.se" required>
        
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button type="button" class="btn btn-soft" style="flex: 1;" onclick="closeModal('forgotPasswordModal')">Avbryt</button>
          <button type="submit" class="btn btn-primary" style="flex: 1;">Skicka l√§nk</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="sellModal" class="modal" onclick="if(event.target === this) closeModal('sellModal')">
  <div class="modal-box" style="max-width: 600px;">
    <div class="modal-head">
      <h3 id="sellTitle">Ny annons</h3>
      <button class="close-btn" onclick="closeModal('sellModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <form onsubmit="event.preventDefault(); submitProduct();">
        <input type="hidden" id="editId">
        
        <label style="font-weight: 600;">Titel *</label>
        <input type="text" id="sellTitleInput" placeholder="Vad s√§ljer du?" required>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <label style="font-weight: 600;">Pris (kr) *</label>
            <input type="number" id="sellPrice" placeholder="0" required min="0">
          </div>
          <div>
            <label style="font-weight: 600;">Kategori</label>
            <select id="sellCat">
              <option value="leksaker">Leksaker</option>
              <option value="barnvagn">Barnvagn</option>
              <option value="bilbarnstol">Bilbarnstol</option>
              <option value="kl√§der">Kl√§der</option>
              <option value="m√∂bler">M√∂bler</option>
            </select>
          </div>
        </div>
        
        <label style="font-weight: 600; display: block; margin-top: 12px;">Plats</label>
        <select id="sellLoc">
          <option>Stockholm</option>
          <option>G√∂teborg</option>
          <option>Malm√∂</option>
          <option>Uppsala</option>
        </select>
        
        <label style="font-weight: 600; display: block; margin-top: 12px;">Beskrivning</label>
        <textarea id="sellDesc" rows="3" placeholder="Beskriv varan..."></textarea>
        
        <label style="font-weight: 600; display: block; margin-top: 12px;">Bilder (max 6)</label>
        <div class="file-input-wrapper">
          <label class="file-input-label">
            üì∑ Klicka f√∂r att v√§lja bilder fr√•n dator eller mobil
            <input type="file" id="sellImages" multiple accept="image/*" onchange="previewImages(this)" style="display: none;">
          </label>
        </div>
        <div id="imagePreviewGrid" class="img-grid"></div>
        <div style="font-size: 12px; color: #64748b; margin-bottom: 12px;">V√§lj upp till 6 bilder. F√∂rsta bilden blir huvudbilden.</div>
        
        <div id="pendingNotice" class="hidden" style="background: #fef3c7; padding: 12px; border-radius: 8px; margin: 12px 0; color: #92400e; font-size: 14px;">
          ‚è≥ Din annons kommer granskas av admin innan den publiceras.
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button type="button" class="btn btn-soft" style="flex: 1;" onclick="closeModal('sellModal')">Avbryt</button>
          <button type="submit" class="btn btn-primary" style="flex: 1;">Publicera</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="productModal" class="modal" onclick="if(event.target === this) closeModal('productModal')">
  <div class="modal-box">
    <div class="modal-head">
      <h3>Annonsdetaljer</h3>
      <button class="close-btn" onclick="closeModal('productModal')">‚úï</button>
    </div>
    <div class="modal-body" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
      <div>
        <img id="modalImg" style="width: 100%; height: 300px; object-fit: cover; border-radius: 12px; background: #f1f5f9;">
        <div id="modalThumbs" style="display: flex; gap: 8px; margin-top: 12px; overflow-x: auto;"></div>
      </div>
      <div>
        <div id="modalStatus"></div>
        <h2 id="modalTitle" style="font-size: 24px; font-weight: 800; margin: 8px 0;">--</h2>
        <div id="modalPrice" style="font-size: 28px; font-weight: 800; color: var(--primary);">--</div>
        <div id="modalMeta" style="color: #64748b; margin: 12px 0;">--</div>
        
        <div style="display: flex; gap: 12px; margin: 20px 0;">
          <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #0ea5e9); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;" id="modalSellerAvatar">??</div>
          <div>
            <div id="modalSellerName" style="font-weight: 700;">--</div>
            <div style="font-size: 14px; color: #64748b;">S√§ljare</div>
          </div>
        </div>
        
        <p id="modalDesc" style="color: #64748b; line-height: 1.6; margin-bottom: 20px;">--</p>
        
        <div id="modalActions" style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn btn-primary" id="btnContact" onclick="contactSeller()">üí¨ Kontakta</button>
          <button class="btn btn-soft" id="modalFavBtn" onclick="toggleFavoriteFromModal()">ü§ç Favorit</button>
          <button class="btn btn-warning" onclick="openReport()">üö® Anm√§l</button>
        </div>
        
        <div id="ownerActions" class="hidden" style="border-top: 1px solid var(--border); margin-top: 20px; padding-top: 20px;">
          <div style="font-weight: 600; margin-bottom: 10px; color: #64748b;">Hantera din annons:</div>
          <button class="btn btn-soft" onclick="editProduct()">‚úèÔ∏è Redigera</button>
          <button class="btn btn-success" id="btnSold" onclick="markSold()">‚úì Markera s√•ld</button>
          <button class="btn btn-danger" onclick="deleteProduct()">üóëÔ∏è Ta bort annons permanent</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="reportModal" class="modal" onclick="if(event.target === this) closeModal('reportModal')">
  <div class="modal-box" style="max-width: 400px;">
    <div class="modal-head" style="background: #fef3c7;">
      <h3>üö® Anm√§l</h3>
      <button class="close-btn" onclick="closeModal('reportModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <form onsubmit="event.preventDefault(); submitReport();">
        <label style="font-weight: 600;">Anledning</label>
        <select id="reportReason" style="margin-bottom: 12px;">
          <option value="Bedr√§geri">Bedr√§geri</option>
          <option value="Ol√§mpligt inneh√•ll">Ol√§mpligt inneh√•ll</option>
          <option value="Spam">Spam</option>
          <option value="Fejk">Fejk/felaktig</option>
          <option value="Annat">Annat</option>
        </select>
        
        <label style="font-weight: 600;">Detaljer (valfritt)</label>
        <textarea id="reportDetails" rows="3" placeholder="Beskriv problemet..."></textarea>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="button" class="btn btn-soft" style="flex: 1;" onclick="closeModal('reportModal')">Avbryt</button>
          <button type="submit" class="btn btn-danger" style="flex: 1;">Skicka</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="deleteModal" class="modal" onclick="if(event.target === this) closeModal('deleteModal')">
  <div class="modal-box" style="max-width: 400px;">
    <div class="modal-head" style="background: #fee2e2;">
      <h3>üóëÔ∏è Ta bort annons permanent?</h3>
      <button class="close-btn" onclick="closeModal('deleteModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <form onsubmit="event.preventDefault(); confirmDelete();">
        <p style="margin-bottom: 16px;">Varf√∂r tas annonsen bort?</p>
        <select id="deleteReason" style="margin-bottom: 20px;">
          <option value="Varan √§r s√•ld">Varan √§r s√•ld</option>
          <option value="√Öngrar f√∂rs√§ljning">√Öngrar f√∂rs√§ljning</option>
          <option value="Ville inte s√§lja">Ville inte s√§lja</option>
          <option value="Annat">Annat</option>
        </select>
        
        <div style="display: flex; gap: 10px;">
          <button type="button" class="btn btn-soft" style="flex: 1;" onclick="closeModal('deleteModal')">Avbryt</button>
          <button type="submit" class="btn btn-danger" style="flex: 1;">Ta bort permanent</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Chat -->
<div id="chatOverlay" class="chat-overlay"></div>
<div id="chatPanel" class="chat-panel">
  <div style="display: flex; height: 100%;">
    <div style="width: 100%; display: flex; flex-direction: column;">
      <div class="chat-header">
        <h3 style="margin: 0;">üí¨ Meddelanden</h3>
        <button class="close-btn" onclick="closeChat()">‚úï</button>
      </div>
      <div id="chatList" class="chat-list"></div>
    </div>
    <div id="chatConversation" class="chat-main hidden" style="position: absolute; inset: 0; background: white; z-index: 10;">
      <div class="chat-header">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div id="chatAvatar" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #fb923c, #ec4899); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">??</div>
          <div>
            <div id="chatName" style="font-weight: 700;">--</div>
            <div style="font-size: 12px; color: var(--success);">‚óè Online</div>
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button onclick="reportFromChat()" style="background: none; border: none; cursor: pointer; font-size: 20px;" title="Anm√§l">üö®</button>
          <button onclick="deleteCurrentChat()" style="background: none; border: none; cursor: pointer; font-size: 20px;" title="Radera">üóëÔ∏è</button>
          <button class="close-btn" onclick="backToChatList()">‚Üê</button>
        </div>
      </div>
      
      <div id="chatProductInfo" class="chat-product-info hidden" onclick="openProductFromChat()">
        <img id="chatProductImg" class="chat-product-img" src="" alt="">
        <div class="chat-product-details">
          <div class="chat-product-label">G√§ller annonsen:</div>
          <div id="chatProductTitle" class="chat-product-title">--</div>
          <div id="chatProductPrice" class="chat-product-price">--</div>
        </div>
        <div style="color: var(--primary); font-size: 20px;">‚Ä∫</div>
      </div>
      
      <div id="chatMessages" class="chat-messages"></div>
      <div class="chat-input">
        <input type="text" id="msgInput" placeholder="Skriv ett meddelande..." onkeypress="if(event.key === 'Enter') sendMessage()">
        <button class="send-btn" onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // BYT UT MOT DINA RIKTIGA V√ÑRDEN FR√ÖN SUPABASE
  //const SUPABASE_URL = "https://txhfogiljfejwdmvmkng.supabase.co";
  //const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4aGZvZ2lsamZlandkbXZta25nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NjgwNjcsImV4cCI6MjA4NTU0NDA2N30.009lF-xi1a0B9SQZDAJw10Bez29-wiptzZD11E73gDE";
   //staging
  const SUPABASE_URL = "https://qcszxirgrysyzfmdwatu.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjc3p4aXJncnlzeXpmbWR3YXR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTQ1MjEsImV4cCI6MjA4NTYzMDUyMX0.Tl87mzHg3U7BoaTi4s5TILenFzUz9QOqu7X7yxd7dt4";

 let sb;
  try {
    sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log("Supabase initierad:", !!sb);
  } catch(e) {
    console.error("Supabase init failed:", e);
    alert("Kunde inte ansluta till databasen.");
  }

  let currentUser = null;
  let currentProduct = null;
  let currentChat = null;
  let msgChannel = null;
  let currentChatId = null;  // Detta m√•ste vara korrekt satt!

  let tempImages = [];
  let products = [];
  let reports = [];
  let currentProfileTab = 'active';
  let localFavorites = new Set();
  
  const DEFAULT_IMAGE = "https://placehold.co/600x400?text=Ingen+bild";

  window.onload = async function() {
    try {
      console.log("Initialiserar applikationen...");
      await loadProducts();
      await checkSupabaseSession();
      renderProducts();

      // F√∂rb√§ttrad event delegation f√∂r chat-listan
      const chatList = document.getElementById('chatList');
      if (chatList) {
        chatList.addEventListener('click', (e) => {
          console.log("Klick p√• chat-lista", e.target);
          const row = e.target.closest('.chat-conv');
          if (!row) {
            console.log("Ingen .chat-conv hittad vid klick");
            return;
          }

          // Hantera delete-knappen separat
          if (e.target.closest('.delete-conv')) {
            console.log("Delete-knapp klickad");
            return; // L√•t delete-knappen hantera sitt eget klick
          }

          const id = row.getAttribute('data-id');
          console.log("√ñppnar konversation med ID:", id);
          if (!id || id === "null" || id === "undefined") {
            console.warn('Chat-rad saknar giltigt data-id:', id);
            showToast("Fel: Konversationen har inget ID");
            return;
          }

          openConversationDb(id);
        });
      } else {
        console.error("chatList element hittades inte!");
      }

      const chatOverlay = document.getElementById('chatOverlay');
      const chatPanel = document.getElementById('chatPanel');

      if (chatOverlay) {
        chatOverlay.addEventListener('click', () => closeChat());
      }

      if (chatPanel) {
        chatPanel.addEventListener('click', (e) => e.stopPropagation());
      }

      // F√∂rb√§ttrad event listener f√∂r Escape
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeAllModals();
          if (document.getElementById('chatPanel').classList.contains('show')) {
            if (!document.getElementById('chatConversation').classList.contains('hidden')) {
              backToChatList();
            } else {
              closeChat();
            }
          }
        }
        
        // L√§gg till Enter f√∂r att skicka meddelande (Ctrl+Enter f√∂r ny rad)
        if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey) {
          const chatPanel = document.getElementById('chatPanel');
          const chatConv = document.getElementById('chatConversation');
          const msgInput = document.getElementById('msgInput');
          
          if (chatPanel.classList.contains('show') && 
              !chatConv.classList.contains('hidden') && 
              document.activeElement === msgInput) {
            e.preventDefault();
            console.log("Enter tryckt i msgInput, skickar meddelande...");
            sendMessage();
          }
        }
      });

      document.addEventListener('click', function(e) {
        if (!e.target.closest('#userAvatar') && !e.target.closest('#userMenu')) {
          document.getElementById('userMenu').classList.add('hidden');
        }
      });

      if (sb) {
        sb.auth.onAuthStateChange(async (event, session) => {
          console.log("Auth state change:", event, session?.user?.id);
          if (event === 'PASSWORD_RECOVERY') {
            showToast('V√§lj ett nytt l√∂senord');
            setTimeout(() => {
              const newPass = prompt("Ange ditt nya l√∂senord (minst 6 tecken):");
              if (newPass && newPass.length >= 6) {
                sb.auth.updateUser({ password: newPass }).then(({ error }) => {
                  if (error) showToast('Kunde inte uppdatera: ' + error.message);
                  else {
                    showToast('L√∂senord uppdaterat! V√§nligen logga in igen.');
                    sb.auth.signOut();
                  }
                });
              }
            }, 1000);
            return;
          }
          if (session?.user) await loginFromAuth(session.user);
          else applyLoggedOutUI();
        });
      }
      
      console.log("Applikation initialiserad");
    } catch (err) {
      console.error("Init error:", err);
      showToast("Fel vid uppstart: " + err.message);
    }
  };

  async function loadProducts() {
    try {
      products = await fetchProductsFromSupabase();
      console.log("Loaded products:", products.length);
    } catch (e) {
      console.error("Kunde inte ladda produkter:", e);
      products = [];
    }
  }

  async function fetchProductsFromSupabase() {
    const { data, error } = await sb
      .from("products")
      .select(`*, product_images ( url, sort_order )`)
      .order("created_at", { ascending: false });

    if (error) throw error;

    return (data || []).map(p => {
      const uniqueImages = [...new Map((p.product_images || [])
        .sort((a,b) => (a.sort_order ?? 0) - (b.sort_order ?? 0))
        .map(img => [img.url, img])).values()];
      
      const imgs = uniqueImages.map(img => img.url);

      return {
        id: p.id,
        title: p.title,
        price: p.price,
        category: p.category,
        location: p.location,
        description: p.description,
        seller: p.seller || "Anonym",
        sellerId: p.seller_id,
        status: p.status || 'active',
        visible: p.visible !== false,
        createdAt: p.created_at,
        date: p.created_at ? new Date(p.created_at).toLocaleDateString('sv-SE') : "",
        images: imgs.length ? imgs : [DEFAULT_IMAGE],
      };
    });
  }

  async function createProductInSupabase(product, imageUrls) {
    const payload = {
      title: product.title,
      price: product.price,
      category: product.category,
      location: product.location,
      description: product.description,
      seller: product.seller,
      seller_id: product.sellerId,
      status: product.status,
      visible: product.visible
    };

    const { data: created, error: pErr } = await sb
      .from("products")
      .insert([payload])
      .select()
      .single();

    if (pErr) throw pErr;

    if (imageUrls && imageUrls.length) {
      const rows = imageUrls.map((url, i) => ({
        product_id: created.id,
        url: url,
        sort_order: i
      }));
      const { error } = await sb.from("product_images").insert(rows);
      if (error) throw error;
    }

    return created;
  }

  async function updateProductInSupabase(productId, updates, imageUrls) {
    const { error: pErr } = await sb
      .from("products")
      .update({
        title: updates.title,
        price: updates.price,
        category: updates.category,
        location: updates.location,
        description: updates.description
      })
      .eq("id", productId);

    if (pErr) throw pErr;

    if (imageUrls) {
      await sb.from("product_images").delete().eq("product_id", productId);
      if (imageUrls.length > 0) {
        const rows = imageUrls.map((url, i) => ({
          product_id: productId,
          url: url,
          sort_order: i
        }));
        const { error } = await sb.from("product_images").insert(rows);
        if (error) throw error;
      }
    }
    return true;
  }

  async function deleteProductFromSupabase(productId) {
    const { error } = await sb.from("products").delete().eq("id", productId);
    if (error) throw error;
    return true;
  }

  async function updateProductStatus(productId, status) {
    try {
      const { error } = await sb
        .from("products")
        .update({ status: status, updated_at: new Date().toISOString() })
        .eq("id", productId);
      
      if (error && error.message.includes('updated_at')) {
        const { error: err2 } = await sb
          .from("products")
          .update({ status: status })
          .eq("id", productId);
        if (err2) throw err2;
      } else if (error) {
        throw error;
      }
    } catch (e) {
      throw e;
    }
  }

  async function checkSupabaseSession() {
    if (!sb) return;
    const { data, error } = await sb.auth.getSession();
    if (error) {
      console.error("Session error:", error);
      return;
    }
    if (data?.session?.user) await loginFromAuth(data.session.user);
  }

  async function getMyProfile(userId) {
    const { data, error } = await sb
      .from('profiles')
      .select('id, name, email, is_admin')
      .eq('id', userId)
      .maybeSingle();

    if (error) {
      console.error('getMyProfile error:', error);
      return null;
    }
    return data;
  }

  let authMode = 'login';

  function openAuth() {
    authMode = 'login';
    updateAuthUI();
    document.getElementById('forgotPasswordLink').classList.remove('hidden');
    showModal('authModal');
  }

  function toggleAuthMode() {
    authMode = authMode === 'login' ? 'signup' : 'login';
    updateAuthUI();
    const forgotLink = document.getElementById('forgotPasswordLink');
    if (forgotLink) forgotLink.classList.toggle('hidden', authMode === 'signup');
  }

  function updateAuthUI() {
    document.getElementById('authTitle').textContent = authMode === 'login' ? 'Logga in' : 'Skapa konto';
    document.getElementById('authActionBtn').textContent = authMode === 'login' ? 'Logga in' : 'Registrera dig';
    document.getElementById('authToggleBtn').textContent = authMode === 'login' ? 'Skapa konto ist√§llet' : 'Har du redan konto?';
    document.getElementById('authNameField').classList.toggle('hidden', authMode === 'login');
  }

  async function handleAuth() {
    if (!sb) { showToast('Databasen √§r inte ansluten'); return; }
    const email = document.getElementById('authEmail').value.trim().toLowerCase();
    const pass = document.getElementById('authPass').value;
    if (!email || !pass) { showToast('Fyll i e-post och l√∂senord'); return; }

    try {
      if (authMode === 'signup') {
        const name = document.getElementById('authName').value.trim();
        if (!name) { showToast('Fyll i namn'); return; }

        const { data, error } = await sb.auth.signUp({
          email, password: pass, options: { data: { name } }
        });
        if (error) { showToast(error.message || 'Kunde inte skapa konto'); return; }
        if (!data?.session) {
          showToast("Konto skapat! Bekr√§fta e-post innan du kan logga in.");
          closeModal('authModal');
          return;
        }
        closeModal("authModal");
        await loginFromAuth(data.session.user);
      } else {
        const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
        if (error) { showToast('Fel e-post eller l√∂senord'); return; }
        closeModal('authModal');
        if (data?.user) await loginFromAuth(data.user);
      }
    } catch (e) {
      showToast('N√•got gick fel: ' + e.message);
    }
  }

  async function loginFromAuth(authUser) {
    console.log("Loggar in anv√§ndare:", authUser.id);
    let profile = await getMyProfile(authUser.id);
    if (!profile) {
      const { data: newProfile } = await sb.from('profiles').insert([{
        id: authUser.id,
        name: authUser.user_metadata?.name || authUser.email?.split('@')[0] || "Anv√§ndare",
        email: authUser.email,
        is_admin: false
      }]).select().single();
      if (newProfile) profile = newProfile;
    }

    currentUser = {
      id: authUser.id,
      email: authUser.email,
      name: (profile?.name || authUser.user_metadata?.name || authUser.email?.split('@')[0] || "Anv√§ndare"),
      isAdmin: !!profile?.is_admin
    };

    console.log("Anv√§ndare inloggad:", currentUser.id, currentUser.name);
    await refreshFavoritesCache();
    applyLoggedInUI(currentUser);
    updateStats();
    showToast('V√§lkommen ' + currentUser.name + '!');
  }

  function applyLoggedInUI(user) {
    document.getElementById('authBtn').classList.add('hidden');
    document.getElementById('userAvatar').classList.remove('hidden');
    document.getElementById('sellBtn').classList.remove('hidden');
    document.getElementById('chatBtn').classList.remove('hidden');

    const initials = (user.name || "??").substring(0, 2).toUpperCase();
    document.getElementById('userAvatar').textContent = initials;
    document.getElementById('pName').textContent = user.name;
    document.getElementById('pEmail').textContent = user.email;
    document.getElementById('pAvatar').textContent = initials;

    if (user.isAdmin) document.getElementById('adminMenuItem').classList.remove('hidden');
    else document.getElementById('adminMenuItem').classList.add('hidden');
  }

  function applyLoggedOutUI() {
    currentUser = null;
    localFavorites.clear();
    document.getElementById('authBtn').classList.remove('hidden');
    document.getElementById('userAvatar').classList.add('hidden');
    document.getElementById('sellBtn').classList.add('hidden');
    document.getElementById('chatBtn').classList.add('hidden');
    document.getElementById('adminMenuItem').classList.add('hidden');
    closeChat();
  }

  async function logout() {
    if (!sb) return;
    await sb.auth.signOut();
    applyLoggedOutUI();
    showToast('Du √§r utloggad');
    showHome();
  }

  function toggleMenu(e) {
    e.stopPropagation();
    document.getElementById('userMenu').classList.toggle('hidden');
  }

  function showHome() {
    hideAllPages();
    document.getElementById('pageHome').classList.add('active');
    renderProducts();
    document.getElementById('userMenu').classList.add('hidden');
    window.scrollTo(0, 0);
  }

  function showProfile() {
    if (!currentUser) return;
    hideAllPages();
    document.getElementById('pageProfile').classList.add('active');
    switchTab('active', document.querySelector('#pageProfile .tab-btn'));
    document.getElementById('userMenu').classList.add('hidden');
    updateStats();
    window.scrollTo(0, 0);
  }

  function showAdmin() {
    if (!currentUser?.isAdmin) { showToast('Endast f√∂r administrat√∂rer'); return; }
    hideAllPages();
    document.getElementById('pageAdmin').classList.add('active');
    setAdminTab('overview', document.querySelector('.admin-nav-item'));
    document.getElementById('userMenu').classList.add('hidden');
    window.scrollTo(0, 0);
  }

  function hideAllPages() {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  }

  async function refreshFavoritesCache() {
    if (!currentUser || !sb) return;
    const { data, error } = await sb
      .from('favorites')
      .select('product_id')
      .eq('user_id', currentUser.id);
    
    if (!error && data) {
      localFavorites = new Set(data.map(f => String(f.product_id)));
    }
  }

  async function getMyFavorites() {
    if (!currentUser) return [];
    if (localFavorites.size === 0) await refreshFavoritesCache();
    return Array.from(localFavorites);
  }

  async function toggleFav(id, event) {
    if (event) event.stopPropagation();
    if (!currentUser) { showToast('Logga in f√∂r att spara favoriter'); return; }
    
    const productId = String(id);
    const isCurrentlyFav = localFavorites.has(productId);
    
    if (isCurrentlyFav) {
      localFavorites.delete(productId);
      showToast('Borttagen fr√•n favoriter');
    } else {
      localFavorites.add(productId);
      showToast('Sparad som favorit');
    }
    
    renderProducts();
    updateStats();
    
    if (document.getElementById('pageProfile').classList.contains('active') && currentProfileTab === 'favorites') {
      const activeBtn = document.querySelector('#pageProfile .tab-btn.active');
      if (activeBtn) switchTab('favorites', activeBtn);
    }
    
    if (currentProduct && String(currentProduct.id) === productId) {
      updateModalFavoriteButton(productId);
    }
    
    try {
      if (isCurrentlyFav) {
        await sb.from('favorites').delete().eq('user_id', currentUser.id).eq('product_id', productId);
      } else {
        await sb.from('favorites').insert([{ user_id: currentUser.id, product_id: productId }]);
      }
    } catch (e) {
      console.error("Favoritfel:", e);
      showToast('Kunde inte spara √§ndring, √•terst√§ller...');
      if (isCurrentlyFav) localFavorites.add(productId);
      else localFavorites.delete(productId);
      renderProducts();
    }
  }

  async function toggleFavoriteFromModal() {
    if (!currentProduct) return;
    await toggleFav(currentProduct.id);
  }

  async function updateModalFavoriteButton(productId) {
    if (!currentUser) {
      document.getElementById('modalFavBtn').innerHTML = 'ü§ç Favorit';
      document.getElementById('modalFavBtn').style.background = '';
      return;
    }
    const isFav = localFavorites.has(String(productId));
    const btn = document.getElementById('modalFavBtn');
    if (btn) {
      btn.innerHTML = isFav ? '‚ù§Ô∏è Favorit' : 'ü§ç Favorit';
      btn.style.background = isFav ? '#fee2e2' : '';
    }
  }

  async function renderProducts() {
    const grid = document.getElementById('productsGrid');
    const search = (document.getElementById('searchInput').value || '').toLowerCase();
    const loc = document.getElementById('filterLoc').value;

    let list = products.filter(p => p.visible !== false && p.status !== 'deleted');
    if (search) list = list.filter(p => p.title.toLowerCase().includes(search));
    if (loc) list = list.filter(p => p.location === loc);

    const activeCatBtn = document.querySelector('.cat.active');
    let cat = 'all';
    if (activeCatBtn && !activeCatBtn.textContent.includes('Allt')) {
      const match = activeCatBtn.getAttribute('onclick');
      if (match) {
        const found = match.match(/'(.*?)'/);
        if (found) cat = found[1];
      }
    }
    if (cat !== 'all') list = list.filter(p => p.category === cat);

    if (list.length === 0) {
      grid.innerHTML = '';
      document.getElementById('noResults').classList.remove('hidden');
      return;
    }
    document.getElementById('noResults').classList.add('hidden');

    const favIds = Array.from(localFavorites);

    grid.innerHTML = list.map(p => {
      const isFav = favIds.includes(String(p.id));
      const imgUrl = (p.images && p.images.length) ? p.images[0] : DEFAULT_IMAGE;
      return `
        <div class="card ${p.status === 'sold' ? 'sold' : ''}" onclick="openProduct('${p.id}')">
          <div style="position: relative;">
            <img src="${imgUrl}" class="card-img" alt="${escapeHtml(p.title)}" onerror="this.src='${DEFAULT_IMAGE}'">
            ${p.status === 'pending' ? '<div class="badge-pending">V√ÑNTAR</div>' : ''}
            <button class="fav-btn ${isFav ? 'active' : ''}" 
                    onclick="event.stopPropagation(); toggleFav('${p.id}', event)"
                    style="${isFav ? 'background: #fee2e2;' : ''}">
              ${isFav ? '‚ù§Ô∏è' : 'ü§ç'}
            </button>
          </div>
          <div class="card-body">
            <div class="card-title">${escapeHtml(p.title)}</div>
            <div class="card-price">${p.price} kr</div>
            <div class="card-meta">
              <span>üìç ${p.location}</span>
              <span>${p.date}</span>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function setCat(cat, btn) {
    document.querySelectorAll('.cat').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderProducts();
  }

  async function openProduct(id) {
    currentProduct = products.find(p => String(p.id) === String(id));
    if (!currentProduct) return;
    
    document.getElementById('modalTitle').textContent = currentProduct.title;
    document.getElementById('modalPrice').textContent = currentProduct.price + ' kr';
    document.getElementById('modalMeta').textContent = `${currentProduct.location} ‚Ä¢ ${currentProduct.date} ‚Ä¢ ${currentProduct.category}`;
    document.getElementById('modalDesc').textContent = currentProduct.description || 'Ingen beskrivning.';
    document.getElementById('modalSellerName').textContent = currentProduct.seller;
    document.getElementById('modalSellerAvatar').textContent = (currentProduct.seller || '??').substring(0, 2).toUpperCase();
    
    const mainImg = (currentProduct.images && currentProduct.images.length) ? currentProduct.images[0] : DEFAULT_IMAGE;
    document.getElementById('modalImg').src = mainImg;
    document.getElementById('modalImg').onerror = function() { this.src = DEFAULT_IMAGE; };

    const thumbsDiv = document.getElementById('modalThumbs');
    if (currentProduct.images && currentProduct.images.length > 1) {
      thumbsDiv.innerHTML = currentProduct.images.map((img, i) => `
        <img src="${img}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; border: ${i === 0 ? '2px solid var(--primary)' : '2px solid transparent'}; flex-shrink: 0;" 
        onclick="document.getElementById('modalImg').src = this.src; document.querySelectorAll('#modalThumbs img').forEach(t => t.style.border = '2px solid transparent'); this.style.border = '2px solid var(--primary)';"
        onerror="this.style.display='none'">
      `).join('');
    } else {
      thumbsDiv.innerHTML = '';
    }
    
    const statusDiv = document.getElementById('modalStatus');
    if (currentProduct.status === 'sold') {
      statusDiv.innerHTML = '<span class="badge-sold">S√ÖLD</span>';
    } else if (currentProduct.status === 'pending') {
      statusDiv.innerHTML = '<span class="status-badge-small status-pending">V√ÑNTAR P√Ö GRANSKNING</span>';
    } else {
      statusDiv.innerHTML = '<span class="status-badge-small status-active">AKTIV</span>';
    }
    
    const isOwner = currentUser && String(currentUser.id) === String(currentProduct.sellerId);
    document.getElementById('ownerActions').classList.toggle('hidden', !isOwner);
    document.getElementById('btnContact').style.display = isOwner ? 'none' : 'inline-flex';
    
    if (isOwner) {
      document.getElementById('btnSold').textContent = currentProduct.status === 'sold' ? '‚Ü© √Öngra s√•ld' : '‚úì Markera som s√•ld';
    }
    
    await updateModalFavoriteButton(id);
    showModal('productModal');
  }

  async function switchTab(tab, btn) {
    currentProfileTab = tab;
    document.querySelectorAll('#pageProfile .tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const content = document.getElementById('tabContent');
    
    if (tab === 'active') {
      const myProducts = products.filter(p => String(p.sellerId) === String(currentUser.id) && p.status !== 'deleted' && p.status !== 'sold');
      if (myProducts.length === 0) {
        content.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">Du har inga aktiva annonser</div>';
        return;
      }
      content.innerHTML = myProducts.map(p => renderProductItem(p, 'active')).join('');
    } else if (tab === 'history') {
      const history = products.filter(p => String(p.sellerId) === String(currentUser.id) && p.status === 'sold');
      if (history.length === 0) {
        content.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">Ingen historik</div>';
        return;
      }
      content.innerHTML = history.map(p => renderProductItem(p, 'history')).join('');
    } else if (tab === 'favorites') {
      const favIds = Array.from(localFavorites);
      if (favIds.length === 0) {
        content.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">Inga favoriter sparade</div>';
        return;
      }
      const favProducts = products.filter(p => favIds.includes(String(p.id)) && p.status === 'active');
      if (favProducts.length === 0) {
        content.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">Dina favoriter √§r inte l√§ngre tillg√§ngliga</div>';
        return;
      }
      content.innerHTML = favProducts.map(p => renderProductItem(p, 'favorite')).join('');
    }
  }

  function renderProductItem(p, type) {
    const isSold = p.status === 'sold';
    const statusBadge = isSold ? '<span class="badge-sold">S√ÖLD</span>' : p.status === 'pending' ? '<span class="status-badge-small status-pending">V√ÑNTAR</span>' : '';
    const imgUrl = (p.images && p.images.length) ? p.images[0] : DEFAULT_IMAGE;
    
    let actionsHtml = '';
    if (type === 'favorite') {
      actionsHtml = `
        <div class="item-actions">
          <button class="btn btn-soft" onclick="event.stopPropagation(); removeFromFavorites('${p.id}')" style="border-color: var(--danger); color: var(--danger);">
            üíî Ta bort fr√•n favoriter
          </button>
        </div>
      `;
    } else if (type === 'active') {
      actionsHtml = `
        <div class="item-actions" onclick="event.stopPropagation()">
          ${p.status !== 'pending' ? `<button class="btn btn-success" onclick="event.stopPropagation(); quickSold('${p.id}')">‚úì S√•ld</button>` : ''}
          <button class="btn btn-danger" onclick="event.stopPropagation(); prepDelete('${p.id}')">üóëÔ∏è Ta bort annons permanent</button>
        </div>
      `;
    } else if (type === 'history') {
      actionsHtml = `
        <div class="item-actions" onclick="event.stopPropagation()">
          <button class="btn btn-success" onclick="event.stopPropagation(); quickSold('${p.id}')">‚Ü© √Öngra s√•ld</button>
        </div>
      `;
    }
    
    return `
      <div class="list-item" style="${isSold ? 'opacity: 0.7;' : ''} cursor: pointer;" onclick="openProduct('${p.id}')">
        <img src="${imgUrl}" class="item-thumb" style="${isSold ? 'filter: grayscale(1);' : ''}" onerror="this.src='${DEFAULT_IMAGE}'">
        <div class="item-content" style="flex: 1;">
          <div class="item-title" style="${isSold ? 'text-decoration: line-through;' : ''}">${escapeHtml(p.title)} ${statusBadge}</div>
          <div class="item-meta">${p.price} kr ‚Ä¢ ${p.location}</div>
          ${actionsHtml}
        </div>
      </div>
    `;
  }

  async function removeFromFavorites(productId) {
    if (!currentUser) return;
    localFavorites.delete(String(productId));
    showToast('Borttagen fr√•n favoriter');
    updateStats();
    const activeBtn = document.querySelector('#pageProfile .tab-btn.active');
    if (activeBtn && currentProfileTab === 'favorites') {
      switchTab('favorites', activeBtn);
    }
    renderProducts();
    
    try {
      await sb.from('favorites').delete().eq('user_id', currentUser.id).eq('product_id', productId);
    } catch (e) {
      showToast('Fel vid borttagning, √•terst√§ller...');
      localFavorites.add(String(productId));
      switchTab('favorites', activeBtn);
    }
  }

  async function quickSold(id, e) {
    if (e) e.stopPropagation();
    const p = products.find(x => String(x.id) === String(id));
    if (!p) return;
    try {
      const newStatus = p.status === 'sold' ? 'active' : 'sold';
      await updateProductStatus(p.id, newStatus);
      await loadProducts();
      renderProducts();
      const activeBtn = document.querySelector('#pageProfile .tab-btn.active');
      if (activeBtn) switchTab(currentProfileTab, activeBtn);
      updateStats();
      showToast(newStatus === 'sold' ? 'Markerad som s√•ld' : '√Öteraktiverad');
    } catch (e) {
      showToast('Kunde inte uppdatera');
    }
  }

  function prepDelete(id) {
    event.stopPropagation();
    currentProduct = products.find(x => String(x.id) === String(id));
    if (currentProduct) {
      showModal('deleteModal');
    }
  }

  async function confirmDelete() {
    if (!currentProduct) return;
    try {
      await deleteProductFromSupabase(currentProduct.id);
      await loadProducts();
      renderProducts();
      updateStats();
      showToast('Annons borttagen permanent');
      closeModal('deleteModal');
      if (document.getElementById('pageProfile').classList.contains('active')) {
        const activeBtn = document.querySelector('#pageProfile .tab-btn.active');
        if (activeBtn) switchTab(currentProfileTab, activeBtn);
      }
    } catch (e) {
      showToast('Kunde inte ta bort annonsen');
    }
  }

  function openSellModal() {
    if (!currentUser) { showToast('Logga in f√∂r att s√§lja'); openAuth(); return; }
    tempImages = [];
    document.getElementById('sellTitleInput').value = '';
    document.getElementById('sellPrice').value = '';
    document.getElementById('sellDesc').value = '';
    document.getElementById('editId').value = '';
    document.getElementById('sellTitle').textContent = 'Ny annons';
    document.getElementById('imagePreviewGrid').innerHTML = '';
    document.getElementById('pendingNotice').classList.toggle('hidden', !currentUser.isAdmin);
    showModal('sellModal');
  }

  async function previewImages(input) {
    const files = Array.from(input.files);
    if (files.length === 0) return;
    
    const remainingSlots = 6 - tempImages.length;
    if (remainingSlots <= 0) {
      showToast('Max 6 bilder till√•tna');
      input.value = '';
      return;
    }
    
    const filesToProcess = files.slice(0, remainingSlots);
    if (files.length > remainingSlots) {
      showToast(`Bara ${remainingSlots} bilder fick plats (max 6 totalt)`);
    }
    
    try {
      const promises = filesToProcess.map(file => {
        return new Promise((resolve, reject) => {
          if (file.size > 2 * 1024 * 1024) {
            reject(new Error(`${file.name} √§r f√∂r stor (max 2MB)`));
            return;
          }
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      });
      
      const results = await Promise.all(promises);
      tempImages.push(...results);
      renderImagePreviews();
      
    } catch (err) {
      showToast('Fel vid bildl√§sning: ' + err.message);
    }
    
    input.value = '';
  }

  function renderImagePreviews() {
    const grid = document.getElementById('imagePreviewGrid');
    if (tempImages.length === 0) {
      grid.innerHTML = '';
      return;
    }
    
    grid.innerHTML = tempImages.map((img, i) => `
      <div class="img-preview">
        <img src="${img}">
        <button type="button" class="remove-img" onclick="removeImage(${i})">‚úï</button>
      </div>
    `).join('');
  }

  function removeImage(idx) {
    tempImages.splice(idx, 1);
    renderImagePreviews();
  }

  async function submitProduct() {
    const title = document.getElementById('sellTitleInput').value.trim();
    const price = parseInt(document.getElementById('sellPrice').value);
    const cat = document.getElementById('sellCat').value;
    const loc = document.getElementById('sellLoc').value;
    const desc = document.getElementById('sellDesc').value.trim();
    const editId = document.getElementById('editId').value;

    if (!currentUser) {
      showToast('Logga in f√∂r att s√§lja');
      return;
    }

    if (!title || !price) {
      showToast('Fyll i titel och pris');
      return;
    }

    const uniqueImages = [...new Set(tempImages)];
    
    console.log('Sparar', uniqueImages.length, 'bilder:', uniqueImages);

    try {
      if (editId) {
        await updateProductInSupabase(editId, {
          title, price, category: cat, location: loc, description: desc
        }, uniqueImages);
        showToast('Annons uppdaterad!');
      } else {
        const newProduct = {
          title,
          price,
          category: cat,
          location: loc,
          description: desc,
          seller: currentUser.name,
          sellerId: currentUser.id,
          status: currentUser.isAdmin ? 'active' : 'pending',
          visible: true
        };
        
        const imagesToSave = uniqueImages.length > 0 ? uniqueImages : [DEFAULT_IMAGE];
        await createProductInSupabase(newProduct, imagesToSave);
        showToast(currentUser.isAdmin ? 'Annons publicerad' : 'Annons skickad till granskning');
      }

      tempImages = [];
      
      await loadProducts();
      renderProducts();
      updateStats();
      closeModal('sellModal');
      
    } catch (e) {
      console.error('Sparfel:', e);
      showToast('Kunde inte spara: ' + e.message);
    }
  }

  function editProduct() {
    if (!currentProduct) return;
    
    closeModal('productModal');
    document.getElementById('sellTitle').textContent = 'Redigera annons';
    document.getElementById('sellTitleInput').value = currentProduct.title;
    document.getElementById('sellPrice').value = currentProduct.price;
    document.getElementById('sellCat').value = currentProduct.category;
    document.getElementById('sellLoc').value = currentProduct.location;
    document.getElementById('sellDesc').value = currentProduct.description || '';
    document.getElementById('editId').value = currentProduct.id;
    document.getElementById('pendingNotice').classList.add('hidden');
    
    tempImages = [...new Set((currentProduct.images || []).filter(img => img !== DEFAULT_IMAGE))];
    
    console.log('Redigerar med', tempImages.length, 'bilder');
    renderImagePreviews();
    
    showModal('sellModal');
  }

  async function markSold() {
    if (!currentProduct) return;
    try {
      const newStatus = currentProduct.status === 'sold' ? 'active' : 'sold';
      await updateProductStatus(currentProduct.id, newStatus);
      await loadProducts();
      renderProducts();
      updateStats();
      showToast(newStatus === 'sold' ? 'Markerad som s√•ld' : '√Öteraktiverad');
      closeModal('productModal');
    } catch (e) {
      showToast('Kunde inte uppdatera status');
    }
  }

  function deleteProduct() {
    closeModal('productModal');
    showModal('deleteModal');
  }

  function forgotPassword() {
    document.getElementById('forgotEmail').value = '';
    closeModal('authModal');
    showModal('forgotPasswordModal');
  }

  async function submitForgotPassword() {
    const email = document.getElementById('forgotEmail').value.trim();
    if (!email) return;
    try {
      const { error } = await sb.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin + window.location.pathname
      });
      if (error) showToast(error.message);
      else {
        showToast('√Öterst√§llningsl√§nk skickad! Kolla din e-post.');
        closeModal('forgotPasswordModal');
      }
    } catch (e) {
      showToast('Kunde inte skicka √•terst√§llningsl√§nk');
    }
  }

  async function updateStats() {
    if (!currentUser) return;

    const myProducts = products.filter(p => String(p.sellerId) === String(currentUser.id) && p.status !== 'deleted');
    document.getElementById('statAds').textContent = myProducts.length;
    document.getElementById('statFavs').textContent = localFavorites.size;

    const { count: convCount, error: cErr } = await sb
      .from('conversations')
      .select('id', { count: 'exact', head: true })
      .or(`buyer_id.eq.${currentUser.id},seller_id.eq.${currentUser.id}`);

    if (cErr) {
      console.error('Kunde inte h√§mta conv count:', cErr);
      document.getElementById('statChats').textContent = '0';
    } else {
      document.getElementById('statChats').textContent = convCount || 0;
    }

    const badge = document.getElementById('chatBadge');
    if ((convCount || 0) > 0) {
      badge.textContent = convCount;
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  }

  // ==========================================
  // CHAT-FUNKTIONER - KORRIGERADE OCH F√ñRB√ÑTTRADE
  // ==========================================

  async function openChat() {
    if (!currentUser) { 
      showToast('Logga in f√∂r att chatta'); 
      return; 
    }

    console.log("√ñppnar chat...");
    document.getElementById('chatPanel').classList.add('show');
    document.getElementById('chatOverlay').classList.add('show');
    document.body.style.overflow = 'hidden';

    try {
      await loadConversationsDb();
    } catch (e) {
      console.error(e);
      showToast('Kunde inte ladda konversationer');
    }
  }

  function closeChat() {
    console.log("St√§nger chat");
    cleanupChatRealtime();
    document.getElementById('chatPanel').classList.remove('show');
    document.getElementById('chatOverlay').classList.remove('show');
    document.getElementById('chatConversation').classList.add('hidden');
    currentChat = null;
    currentChatId = null;
    document.body.style.overflow = '';
  }

  async function loadConversationsDb() {
    if (!currentUser) {
      console.log("Ingen currentUser i loadConversationsDb");
      return;
    }

    const list = document.getElementById('chatList');
    list.innerHTML = '<div style="padding: 20px; color:#64748b;">Laddar...</div>';
    
    console.log("Laddar konversationer f√∂r anv√§ndare:", currentUser.id);

    try {
      // VIKTIGT: H√§mta alla konversationer d√§r anv√§ndaren √§r med
      const { data: convs, error } = await sb
        .from('conversations')
        .select('*')
        .or(`buyer_id.eq.${currentUser.id},seller_id.eq.${currentUser.id}`)
        .order('updated_at', { ascending: false });

      if (error) {
        console.error("Fel vid h√§mtning av konversationer:", error);
        throw error;
      }

      console.log("H√§mtade konversationer:", convs?.length || 0);

      // Filtrera baserat p√• VEMS delete-flagga som √§r satt
      const visible = (convs || []).filter(c => {
        const isBuyer = String(c.buyer_id) === String(currentUser.id);
        const isSeller = String(c.seller_id) === String(currentUser.id);
        
        // Om jag √§r k√∂pare och har tagit bort den (buyer_deleted=true) -> visa EJ
        if (isBuyer && c.buyer_deleted === true) return false;
        
        // Om jag √§r s√§ljare och har tagit bort den (seller_deleted=true) -> visa EJ  
        if (isSeller && c.seller_deleted === true) return false;
        
        return true;
      });

      console.log("Synliga konversationer efter filtrering:", visible.length);

      if (visible.length === 0) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">Inga konversationer √§n</div>';
        return;
      }

      const enriched = [];
      for (const c of visible) {
        const isBuyer = String(c.buyer_id) === String(currentUser.id);
        const otherId = isBuyer ? c.seller_id : c.buyer_id;

        let otherName = await getDisplayName(otherId);
        if (!otherName) otherName = 'Ok√§nd anv√§ndare';

        const prod = products.find(p => String(p.id) === String(c.product_id));

        enriched.push({
          ...c,
          otherId,
          otherName,
          productTitle: prod?.title || null
        });
      }

      list.innerHTML = enriched.map(c => `
        <div class="chat-conv" data-id="${String(c.id)}">
          <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #fb923c, #ec4899); display:flex; align-items:center; justify-content:center; color:white; font-weight:700; flex-shrink:0;">
            ${(c.otherName || '??').substring(0, 2).toUpperCase()}
          </div>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 700;">${escapeHtml(c.otherName || 'Ok√§nd')}</div>
            <div style="font-size: 14px; color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
              ${escapeHtml(c.last_message || 'Inga meddelanden')}
            </div>
            ${c.productTitle ? `<div style="font-size: 12px; color: var(--primary); margin-top: 2px;">üì¶ ${escapeHtml(c.productTitle.substring(0, 30))}${c.productTitle.length > 30 ? '...' : ''}</div>` : ''}
          </div>
          <button class="delete-conv" onclick="event.stopPropagation(); deleteConversationFromList('${String(c.id)}')" title="Ta bort">üóëÔ∏è</button>
        </div>
      `).join('');
      
      console.log("Chat-lista renderad med", enriched.length, "konversationer");
    } catch (e) {
      console.error("Fel i loadConversationsDb:", e);
      list.innerHTML = '<div style="padding: 20px; color:#ef4444;">Kunde inte ladda konversationer</div>';
    }
  }

  async function deleteConversationFromList(conversationId) {
    if (!currentUser || !confirm('Radera denna konversation? Den kommer att f√∂rsvinna fr√•n din lista, men den andra parten beh√•ller sin kopia.')) return;
    
    console.log("Raderar konversation fr√•n lista:", conversationId);
    
    try {
      const convIdNum = Number(conversationId);
      
      const { data: conv, error: convErr } = await sb
        .from('conversations')
        .select('id,buyer_id,seller_id')
        .eq('id', convIdNum)
        .maybeSingle();

      if (convErr) throw convErr;
      if (!conv) {
        showToast('Konversationen finns inte');
        return;
      }

      const isBuyer = String(currentUser.id) === String(conv.buyer_id);
      const update = isBuyer ? { buyer_deleted: true } : { seller_deleted: true };

      const { error: updErr } = await sb
        .from('conversations')
        .update(update)
        .eq('id', convIdNum);

      if (updErr) throw updErr;

      await loadConversationsDb();
      await updateStats();
      showToast('Konversation raderad fr√•n din lista');
    } catch (e) {
      console.error(e);
      showToast('Kunde inte radera chatten');
    }
  }

  async function openConversationDb(conversationId) {
    if (!currentUser) {
      console.log("Ingen currentUser!");
      return;
    }

    if (conversationId == null || conversationId === "null" || conversationId === "undefined") {
      console.error("openConversationDb: ogiltigt conversationId:", conversationId);
      showToast("Kunde inte √∂ppna chatten (saknar ID)");
      return;
    }

    const convIdNum = Number(conversationId);
    if (!Number.isFinite(convIdNum)) {
      console.error('openConversationDb: id ej nummer:', conversationId);
      showToast('Kunde inte √∂ppna chatten (fel id-format)');
      return;
    }

    console.log("√ñppnar konversation:", convIdNum);

    try {
      const { data: conv, error } = await sb
        .from('conversations')
        .select('*')
        .eq('id', convIdNum)
        .maybeSingle();

      if (error) {
        console.error("Fel vid h√§mtning av konversation:", error);
        throw error;
      }
      
      if (!conv) {
        console.log("Konversationen finns inte:", convIdNum);
        showToast('Konversationen finns inte l√§ngre');
        return;
      }

      console.log("Konversation h√§mtad:", conv);

      // Kontrollera att anv√§ndaren inte har tagit bort denna konversation
      const isBuyer = String(conv.buyer_id) === String(currentUser.id);
      const isSeller = String(conv.seller_id) === String(currentUser.id);
      
      if (isBuyer && conv.buyer_deleted === true) {
        showToast('Du har tagit bort denna konversation');
        return;
      }
      if (isSeller && conv.seller_deleted === true) {
        showToast('Du har tagit bort denna konversation');
        return;
      }

      // VIKTIGT: S√§tt currentChatId som STRING f√∂r att matcha DB
      currentChatId = String(conv.id);
      console.log("currentChatId satt till:", currentChatId, "typ:", typeof currentChatId);
      
      const otherId = isBuyer ? conv.seller_id : conv.buyer_id;
      const otherName = (await getDisplayName(otherId)) || (isBuyer ? "S√§ljare" : "K√∂pare");

      // Visa chat-vyn
      document.getElementById('chatConversation').classList.remove('hidden');
      document.getElementById('chatName').textContent = otherName;
      document.getElementById('chatAvatar').textContent = (otherName || '??').substring(0, 2).toUpperCase();

      // S√§kerst√§ll att input √§r tom och fokuserad
      const msgInput = document.getElementById('msgInput');
      if (msgInput) {
        msgInput.value = '';
        // Fokusera input efter en kort stund f√∂r att UI ska hinna uppdateras
        setTimeout(() => msgInput.focus(), 100);
      }

      // Visa produktinfo
      const prod = products.find(p => String(p.id) === String(conv.product_id));
      if (prod) {
        document.getElementById('chatProductImg').src = (prod.images && prod.images[0]) ? prod.images[0] : DEFAULT_IMAGE;
        document.getElementById('chatProductTitle').textContent = prod.title || '--';
        document.getElementById('chatProductPrice').textContent = (prod.price != null) ? (prod.price + ' kr') : '';
        document.getElementById('chatProductInfo').classList.remove('hidden');
      } else {
        document.getElementById('chatProductInfo').classList.add('hidden');
      }

      // Markera aktiv i listan
      document.querySelectorAll('.chat-conv').forEach(el => el.classList.remove('active'));
      const activeEl = document.querySelector(`.chat-conv[data-id="${String(conv.id)}"]`);
      if (activeEl) activeEl.classList.add('active');

      // Ladda meddelanden och prenumerera
      await loadMessagesDb(String(conv.id));
      subscribeToMessages(String(conv.id));
      
      console.log("Konversation √∂ppnad och klar");

    } catch (e) {
      console.error("Fel i openConversationDb:", e);
      showToast('Kunde inte √∂ppna chatten');
    }
  }

  async function loadMessagesDb(conversationId) {
    const container = document.getElementById('chatMessages');
    container.innerHTML = '<div style="text-align:center; color:#64748b; margin-top:40px;">Laddar...</div>';

    console.log("Laddar meddelanden f√∂r:", conversationId);

    try {
      const { data: msgs, error } = await sb
        .from('messages')
        .select('*')
        .eq('conversation_id', conversationId)
        .order('created_at', { ascending: true });

      if (error) {
        console.error("Fel vid h√§mtning av meddelanden:", error);
        throw error;
      }

      console.log("H√§mtade meddelanden:", msgs?.length || 0);

      if (!msgs || msgs.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #64748b; margin-top: 40px;">Skriv f√∂rsta meddelandet</div>';
        return;
      }

      container.innerHTML = msgs.map(m => `
        <div class="msg ${String(m.sender_id) === String(currentUser.id) ? 'sent' : 'received'}">
          ${escapeHtml(m.body)}
          <div class="msg-time">${m.created_at ? new Date(m.created_at).toLocaleTimeString('sv-SE', {hour:'2-digit', minute:'2-digit'}) : ''}</div>
        </div>
      `).join('');

      container.scrollTop = container.scrollHeight;
      console.log("Meddelanden renderade");
    } catch (e) {
      console.error("Fel i loadMessagesDb:", e);
      container.innerHTML = '<div style="text-align:center; color:#ef4444; margin-top:40px;">Kunde inte ladda meddelanden</div>';
    }
  }

  // ==========================================
  // VIKTIG FUNKTION - sendMessage KORRIGERAD
  // ==========================================
  async function sendMessage() {
    const input = document.getElementById('msgInput');
    
    if (!input) {
      console.error("msgInput hittades inte!");
      showToast('Fel: Chattf√§ltet saknas');
      return;
    }
    
    const text = input.value.trim();
    
    console.log("sendMessage anropad:", {
      text: text,
      currentChatId: currentChatId,
      currentUserId: currentUser?.id,
      inputValue: input.value
    });

    // VIKTIGA KONTROLLER
    if (!text) {
      console.log("Inget text att skicka");
      return;
    }
    
    if (!currentChatId) {
      console.error("currentChatId √§r null eller undefined!");
      showToast('Fel: Ingen aktiv konversation');
      return;
    }
    
    if (!currentUser) {
      console.error("currentUser √§r null!");
      showToast('Fel: Du m√•ste vara inloggad');
      return;
    }

    try {
      console.log("Skickar meddelande till databasen...");
      
      // 1) Insert message
      const { error: msgErr } = await sb
        .from('messages')
        .insert([{
          conversation_id: Number(currentChatId), // Se till att det √§r ett nummer
          sender_id: currentUser.id,
          body: text,
          created_at: new Date().toISOString()
        }]);

      if (msgErr) {
        console.error("Fel vid insert av meddelande:", msgErr);
        throw msgErr;
      }

      console.log("Meddelande sparat, uppdaterar konversation...");

      // 2) update conversation
      const { error: convErr } = await sb
        .from('conversations')
        .update({
          last_message: text,
          updated_at: new Date().toISOString()
        })
        .eq('id', Number(currentChatId));

      if (convErr) {
        console.error("Fel vid uppdatering av konversation:", convErr);
        throw convErr;
      }

      input.value = '';
      console.log("Meddelande skickat framg√•ngsrikt");

      // 3) Uppdatera UI
      await loadMessagesDb(currentChatId);
      await loadConversationsDb();
      await updateStats();
      
    } catch (e) {
      console.error("Fel i sendMessage:", e);
      showToast('Kunde inte skicka: ' + (e.message || 'ok√§nt fel'));
    }
  }

  async function getDisplayName(userId) {
    try {
      const { data, error } = await sb
        .from('profiles')
        .select('name')
        .eq('id', userId)
        .maybeSingle();
      if (error) return null;
      return data?.name || null;
    } catch {
      return null;
    }
  }

  function cleanupChatRealtime() {
    try {
      if (msgChannel && sb) sb.removeChannel(msgChannel);
    } catch(e) {
      console.error("Fel vid cleanup:", e);
    }
    msgChannel = null;
  }

  function subscribeToMessages(conversationId) {
    cleanupChatRealtime();
    try {
      console.log("Prenumererar p√• meddelanden f√∂r:", conversationId);
      
      msgChannel = sb
        .channel('msgs_' + conversationId)
        .on(
          'postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'messages', filter: `conversation_id=eq.${conversationId}` },
          async (payload) => {
            console.log("Nytt meddelande mottaget via realtime:", payload);
            if (currentChatId === conversationId) {
              await loadMessagesDb(conversationId);
            }
            await loadConversationsDb();
            await updateStats();
          }
        )
        .subscribe((status) => {
          console.log("Realtime status:", status);
        });
    } catch (e) {
      console.error("Realtime subscribe error:", e);
    }
  }

  function backToChatList() {
    console.log("G√•r tillbaka till chat-lista");
    document.getElementById('chatConversation').classList.add('hidden');
    cleanupChatRealtime();
    currentChat = null;
    currentChatId = null;
  }

  async function deleteCurrentChat() {
    if (!currentUser || !sb || !currentChatId) return;
    if (!confirm('Radera konversationen? Den f√∂rsvinner fr√•n din lista men beh√•lls f√∂r den andra parten.')) return;

    console.log("Raderar nuvarande chat:", currentChatId);

    try {
      cleanupChatRealtime();

      const convIdNum = Number(currentChatId);

      const { data: conv, error: convErr } = await sb
        .from('conversations')
        .select('id,buyer_id,seller_id')
        .eq('id', convIdNum)
        .maybeSingle();

      if (convErr) throw convErr;
      if (!conv) throw new Error('Konversationen finns inte');

      const isBuyer = String(currentUser.id) === String(conv.buyer_id);
      const update = isBuyer ? { buyer_deleted: true } : { seller_deleted: true };

      const { error: updErr } = await sb
        .from('conversations')
        .update(update)
        .eq('id', convIdNum);

      if (updErr) throw updErr;

      document.getElementById('chatConversation').classList.add('hidden');
      currentChat = null;
      currentChatId = null;

      await loadConversationsDb();
      await updateStats();
      showToast('Konversation raderad fr√•n din lista');
    } catch (e) {
      console.error(e);
      showToast('Kunde inte radera chatten');
    }
  }

async function contactSeller() {
  if (!currentUser) { 
    showToast('Logga in f√∂rst'); 
    return; 
  }
  if (!currentProduct) return;

  if (String(currentProduct.sellerId) === String(currentUser.id)) {
    showToast('Detta √§r din egen annons');
    return;
  }

  console.log("Kontaktar s√§ljare f√∂r produkt:", currentProduct.id);

  try {
    // 1) hitta befintlig (inklusive raderade f√∂r att kunna √•terst√§lla dem)
    const { data: existing, error: findErr } = await sb
      .from('conversations')
      .select('*')
      .eq('product_id', currentProduct.id)
      .eq('buyer_id', currentUser.id)
      .eq('seller_id', currentProduct.sellerId)
      .maybeSingle();

    if (findErr) {
      console.error("Fel vid s√∂kning av befintlig konversation:", findErr);
      throw findErr;
    }

    let conv = existing;

    // 2) annars skapa, ELLER √•terst√§ll om den √§r raderad
    if (!conv) {
      console.log("Skapar ny konversation...");
      const now = new Date().toISOString();
      const { data: created, error: createErr } = await sb
        .from('conversations')
        .insert([{
          product_id: currentProduct.id,
          buyer_id: currentUser.id,
          seller_id: currentProduct.sellerId,
          last_message: 'Hej! Jag √§r intresserad av din annons.',
          created_at: now,
          updated_at: now,
          buyer_deleted: false,  // S√§kerst√§ll att den inte √§r raderad
          seller_deleted: false
        }])
        .select()
        .single();

      if (createErr) {
        console.error("Fel vid skapande av konversation:", createErr);
        throw createErr;
      }
      conv = created;
      console.log("Ny konversation skapad:", conv.id);

      const { error: msgErr } = await sb
        .from('messages')
        .insert([{
          conversation_id: conv.id,
          sender_id: currentUser.id,
          body: 'Hej! Jag √§r intresserad av din annons.',
          created_at: now
        }]);

      if (msgErr) {
        console.error("Fel vid skapande av f√∂rsta meddelande:", msgErr);
        throw msgErr;
      }
    } else {
      console.log("Befintlig konversation hittad:", conv.id, "Status:", {
        buyer_deleted: conv.buyer_deleted,
        seller_deleted: conv.seller_deleted
      });
      
      // KORRIGERING: √Öterst√§ll om den √§r raderad av nuvarande anv√§ndare
      const isBuyer = String(conv.buyer_id) === String(currentUser.id);
      const wasDeletedByMe = isBuyer ? conv.buyer_deleted : conv.seller_deleted;
      
      if (wasDeletedByMe) {
        console.log("Konversationen var raderad, √•terst√§ller...");
        const update = isBuyer ? { buyer_deleted: false } : { seller_deleted: false };
        
        const { error: restoreErr } = await sb
          .from('conversations')
          .update(update)
          .eq('id', conv.id);
          
        if (restoreErr) {
          console.error("Fel vid √•terst√§llning:", restoreErr);
          throw restoreErr;
        }
        
        // Uppdatera lokalt objekt ocks√•
        if (isBuyer) conv.buyer_deleted = false;
        else conv.seller_deleted = false;
        
        showToast('Konversation √•terst√§lld');
      }
    }

    closeModal('productModal');
    openChat();
    
    // V√§nta lite s√• chat-panel hinner √∂ppnas
    setTimeout(async () => {
      await openConversationDb(conv.id);
    }, 300);
    
  } catch (e) {
    console.error("Fel i contactSeller:", e);
    showToast('Kunde inte starta chat: ' + (e.message || 'ok√§nt fel'));
  }
}

  function openReport() {
    if (!currentUser) { showToast('Logga in f√∂r att anm√§la'); return; }
    document.getElementById('reportReason').value = 'Bedr√§geri';
    document.getElementById('reportDetails').value = '';
    showModal('reportModal');
  }

  function submitReport() {
    const reason = document.getElementById('reportReason').value;
    const details = document.getElementById('reportDetails').value;
    if (!currentProduct) return;
    reports.push({
      id: Date.now(),
      type: 'product',
      targetId: currentProduct.id,
      targetName: currentProduct.title || currentProduct.seller,
      reporterId: currentUser.id,
      reporterName: currentUser.name,
      reason: reason,
      details: details,
      status: 'pending',
      date: new Date().toLocaleString('sv-SE')
    });
    showToast('Anm√§lan skickad till admin');
    closeModal('reportModal');
    updateAdminBadges();
  }

  function reportFromChat() {
    showToast('Anm√§lningsfunktion fr√•n chat ej implementerad');
  }

  function openProductFromChat() {
    showToast('√ñppna annons fr√•n chat ej implementerad');
  }

  function setAdminTab(tab, element) {
    document.querySelectorAll('.admin-nav-item').forEach(el => el.classList.remove('active'));
    element.classList.add('active');
    renderAdminContent(tab);
  }

  function renderAdminContent(tab) {
    const content = document.getElementById('adminContent');
    if (tab === 'overview') {
      const activeAds = products.filter(p => p.status === 'active').length;
      const pendingAds = products.filter(p => p.status === 'pending').length;
      const soldAds = products.filter(p => p.status === 'sold').length;
      content.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
          <div class="panel" style="padding: 20px;">
            <div style="color: #64748b; font-size: 14px; font-weight: 600;">AKTIVA ANNONSER</div>
            <div style="font-size: 32px; font-weight: 800; margin-top: 8px;">${activeAds}</div>
          </div>
          <div class="panel" style="padding: 20px;">
            <div style="color: #64748b; font-size: 14px; font-weight: 600;">GRANSKNING</div>
            <div style="font-size: 32px; font-weight: 800; margin-top: 8px;">${pendingAds}</div>
          </div>
          <div class="panel" style="padding: 20px;">
            <div style="color: #64748b; font-size: 14px; font-weight: 600;">S√ÖLDA</div>
            <div style="font-size: 32px; font-weight: 800; margin-top: 8px;">${soldAds}</div>
          </div>
        </div>
      `;
    } else if (tab === 'pending') {
      const pending = products.filter(p => p.status === 'pending');
      if (pending.length === 0) {
        content.innerHTML = '<div class="panel" style="padding: 40px; text-align: center; color: #64748b;">Inga annonser v√§ntar p√• granskning</div>';
        return;
      }
      content.innerHTML = pending.map(p => {
        const img = (p.images && p.images.length) ? p.images[0] : DEFAULT_IMAGE;
        return `
        <div class="panel" style="margin-bottom: 12px; overflow: hidden;">
          <div style="display: flex; gap: 16px; padding: 16px; flex-wrap: wrap;">
            <img src="${img}" style="width: 100px; height: 75px; object-fit: cover; border-radius: 8px; flex-shrink: 0;" onerror="this.src='${DEFAULT_IMAGE}'">
            <div style="flex: 1; min-width: 200px;">
              <div style="font-weight: 700;">${escapeHtml(p.title)}</div>
              <div style="color: #64748b; font-size: 14px;">${p.price} kr ‚Ä¢ ${p.seller}</div>
              <div style="margin-top: 8px; font-size: 14px;">${escapeHtml(p.description || '')}</div>
            </div>
          </div>
          <div style="display: flex; gap: 8px; padding: 0 16px 16px;">
            <button class="btn btn-success" onclick="approveProduct('${p.id}')">‚úì Godk√§nn</button>
            <button class="btn btn-danger" onclick="rejectProduct('${p.id}')">‚úï Avvisa</button>
          </div>
        </div>
      `}).join('');
    } else if (tab === 'reports') {
      const pendingReports = reports.filter(r => r.status === 'pending');
      if (pendingReports.length === 0) {
        content.innerHTML = '<div class="panel" style="padding: 40px; text-align: center; color: #64748b;">Inga nya anm√§lningar</div>';
        return;
      }
      content.innerHTML = pendingReports.map(r => `
        <div class="panel" style="margin-bottom: 12px; padding: 16px; border-left: 4px solid #f59e0b;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px;">
            <div>
              <span style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 700;">${r.type}</span>
              <div style="font-weight: 700; margin-top: 8px;">${r.reason}</div>
              <div style="color: #64748b; font-size: 14px;">M√•l: ${escapeHtml(r.targetName)}</div>
              <div style="color: #64748b; font-size: 14px;">Av: ${escapeHtml(r.reporterName)}</div>
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="btn btn-soft" onclick="dismissReport(${r.id})">Avf√§rda</button>
            </div>
          </div>
        </div>
      `).join('');
    } else if (tab === 'users') {
      content.innerHTML = '<div style="text-align: center; color: #64748b;">Anv√§ndarhantering visas h√§r</div>';
    }
  }

  async function approveProduct(id) {
    try {
      await updateProductStatus(id, 'active');
      await loadProducts();
      renderProducts();
      renderAdminContent('pending');
      updateAdminBadges();
      showToast('Annons godk√§nd');
    } catch (e) {
      showToast('Kunde inte godk√§nna');
    }
  }

  async function rejectProduct(id) {
    const reason = prompt('Ange anledning f√∂r avvisning:');
    if (!reason) return;
    try {
      await updateProductStatus(id, 'rejected');
      await loadProducts();
      renderAdminContent('pending');
      updateAdminBadges();
      showToast('Annons avvisad');
    } catch (e) {
      showToast('Kunde inte avvisa');
    }
  }

  function dismissReport(reportId) {
    const r = reports.find(x => x.id === reportId);
    if (r) {
      r.status = 'dismissed';
      showToast('Anm√§lan avf√§rdad');
      renderAdminContent('reports');
      updateAdminBadges();
    }
  }

  function updateAdminBadges() {
    const pending = products.filter(p => p.status === 'pending').length;
    const rep = reports.filter(r => r.status === 'pending').length;
    document.getElementById('badgePending').textContent = pending;
    document.getElementById('badgePending').classList.toggle('hidden', pending === 0);
    document.getElementById('badgeReports').textContent = rep;
    document.getElementById('badgeReports').classList.toggle('hidden', rep === 0);
  }

  function showModal(id) {
    const modal = document.getElementById(id);
    modal.classList.add('show');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  function closeModal(id) {
    const modal = document.getElementById(id);
    modal.classList.remove('show');
    setTimeout(() => { modal.style.display = 'none'; }, 300);
    if (!document.getElementById('chatPanel').classList.contains('show')) {
      document.body.style.overflow = '';
    }
  }

  function closeAllModals() {
    ['authModal', 'sellModal', 'productModal', 'reportModal', 'deleteModal', 'forgotPasswordModal'].forEach(id => {
      const modal = document.getElementById(id);
      if (modal.classList.contains('show')) closeModal(id);
    });
  }

  function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
  }

  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }
</script>
</body>
</html>
