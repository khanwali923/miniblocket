<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Miniblocket</title>
  <style>
    :root {
      --primary: #0ea5e9;
      --danger: #ef4444;
      --success: #10b981;
      --bg: #f8fafc;
      --text: #0f172a;
      --border: #e2e8f0;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, -apple-system, sans-serif; }
    
    body { background: var(--bg); color: var(--text); }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    .hidden { display: none !important; }
    
    /* Nav */
    nav { background: white; border-bottom: 1px solid var(--border); padding: 15px 0; position: sticky; top: 0; z-index: 100; }
    .nav { display: flex; justify-content: space-between; align-items: center; }
    .brand { cursor: pointer; font-weight: 800; font-size: 20px; display: flex; align-items: center; gap: 10px; }
    .logo { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), #8b5cf6); color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    
    .btn { padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-soft { background: #f1f5f9; border: 1px solid var(--border); }
    .btn-danger { background: #fee2e2; color: #991b1b; }
    .btn-success { background: var(--success); color: white; }
    .btn-warning { background: #fef3c7; color: #92400e; }
    
    .avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #fb923c, #ec4899); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; cursor: pointer; }
    
    /* Layout */
    .page { display: none; padding: 20px 0; min-height: calc(100vh - 80px); }
    .page.active { display: block; }
    
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
    
    .card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); cursor: pointer; transition: transform 0.2s; border: 1px solid var(--border); }
    .card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.12); }
    .card.sold { opacity: 0.6; filter: grayscale(0.8); pointer-events: none; position: relative; }
    .card.sold::after { content: 'S√ÖLD'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); background: var(--danger); color: white; padding: 10px 30px; font-weight: 900; font-size: 24px; border-radius: 8px; }
    .card.pending { opacity: 0.7; }
    
    .card-img { width: 100%; height: 200px; object-fit: cover; background: #f1f5f9; }
    .card-body { padding: 16px; }
    .card-title { font-weight: 700; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .card-price { color: var(--primary); font-weight: 800; font-size: 18px; }
    .card-meta { display: flex; justify-content: space-between; margin-top: 12px; font-size: 14px; color: #64748b; align-items: center; }
    
    .badge-pending { position: absolute; top: 10px; right: 10px; background: #f59e0b; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; }
    .badge-sold { background: var(--danger); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; display: inline-block; margin-bottom: 8px; }
    .badge-active { background: var(--success); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; display: inline-block; margin-bottom: 8px; }
    
    .fav-btn { position: absolute; top: 10px; right: 10px; width: 36px; height: 36px; border-radius: 50%; border: none; background: white; cursor: pointer; font-size: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 5; }
    .fav-btn.active { background: #fee2e2; }
    
    /* Forms */
    input, select, textarea { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 12px; font-size: 16px; margin-bottom: 12px; }
    input:focus, select:focus { border-color: var(--primary); outline: none; }
    
    .search-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
    .search-bar input, .search-bar select { flex: 1; min-width: 200px; margin-bottom: 0; }
    
    .cats { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 20px; }
    .cat { padding: 10px 20px; border: 2px solid var(--border); border-radius: 20px; background: white; cursor: pointer; white-space: nowrap; font-weight: 600; }
    .cat.active { background: var(--primary); color: white; border-color: var(--primary); }
    
    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal.show { display: flex; }
    .modal-box { background: white; border-radius: 20px; width: 100%; max-width: 800px; max-height: 90vh; overflow: auto; }
    .modal-head { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; }
    .modal-body { padding: 20px; }
    
    .close-btn { width: 36px; height: 36px; border-radius: 50%; border: none; background: #f1f5f9; cursor: pointer; font-size: 20px; }
    
    /* Profile */
    .profile-grid { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
    @media (max-width: 768px) { .profile-grid { grid-template-columns: 1fr; } }
    
    .panel { background: white; border-radius: 16px; border: 1px solid var(--border); overflow: hidden; }
    .panel-header { padding: 20px; background: linear-gradient(135deg, #e0f2fe, #fce7f3); }
    .panel-body { padding: 20px; }
    
    .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px 0; }
    .stat-box { text-align: center; padding: 16px; background: #f8fafc; border-radius: 12px; }
    .stat-num { font-size: 24px; font-weight: 800; color: var(--primary); }
    .stat-label { font-size: 12px; color: #64748b; text-transform: uppercase; margin-top: 4px; }
    
    .tab-bar { display: flex; background: #f1f5f9; padding: 6px; border-radius: 12px; margin-bottom: 20px; }
    .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 600; color: #64748b; }
    .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    
    .list-item { display: flex; gap: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); align-items: center; }
    .list-item:hover { border-color: var(--primary); }
    .item-thumb { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; background: #e2e8f0; flex-shrink: 0; }
    .item-content { flex: 1; }
    .item-title { font-weight: 700; margin-bottom: 4px; }
    .item-meta { font-size: 14px; color: #64748b; }
    .item-actions { display: flex; gap: 8px; margin-top: 8px; }
    
    /* Chat */
    .chat-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; }
    .chat-overlay.show { display: block; }
    .chat-panel { display: none; position: fixed; top: 0; right: 0; height: 100vh; width: 100%; max-width: 450px; background: white; z-index: 201; box-shadow: -10px 0 30px rgba(0,0,0,0.2); }
    .chat-panel.show { display: flex; flex-direction: column; }
    .chat-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .chat-list { flex: 1; overflow-y: auto; }
    .chat-conv { padding: 16px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; gap: 12px; position: relative; }
    .chat-conv:hover { background: #f8fafc; }
    .chat-conv.active { background: #e0f2fe; border-left: 4px solid var(--primary); }
    .delete-conv { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); opacity: 0; cursor: pointer; padding: 5px; }
    .chat-conv:hover .delete-conv { opacity: 1; }
    .chat-main { flex: 1; display: flex; flex-direction: column; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; background: #f8fafc; }
    .msg { max-width: 80%; padding: 12px 16px; border-radius: 16px; line-height: 1.4; }
    .msg.sent { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
    .msg.received { background: white; border: 1px solid var(--border); align-self: flex-start; border-bottom-left-radius: 4px; }
    .msg-time { font-size: 11px; opacity: 0.7; margin-top: 4px; }
    .chat-input { padding: 16px; border-top: 1px solid var(--border); display: flex; gap: 12px; background: white; }
    .chat-input input { flex: 1; margin-bottom: 0; }
    .send-btn { width: 44px; height: 44px; border-radius: 50%; border: none; background: var(--primary); color: white; cursor: pointer; font-size: 18px; }
    
    /* Admin */
    .admin-badge { background: var(--danger); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 800; margin-left: 10px; }
    .admin-nav { display: flex; flex-direction: column; gap: 8px; }
    .admin-nav-item { padding: 12px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #64748b; display: flex; justify-content: space-between; align-items: center; }
    .admin-nav-item:hover, .admin-nav-item.active { background: var(--primary); color: white; }
    .count-badge { background: var(--danger); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
    
    .status-badge-small { font-size: 11px; padding: 4px 8px; border-radius: 12px; font-weight: 700; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-active { background: #d1fae5; color: #065f46; }
    .status-sold { background: #fee2e2; color: #991b1b; }
    
    /* Image preview */
    .img-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 10px 0; }
    .img-preview { aspect-ratio: 1; border-radius: 8px; overflow: hidden; position: relative; border: 1px solid var(--border); }
    .img-preview img { width: 100%; height: 100%; object-fit: cover; }
    .remove-img { position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; border-radius: 50%; border: none; background: rgba(255,255,255,0.9); cursor: pointer; color: var(--danger); font-weight: 700; }
    
    /* Toast */
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #0f172a; color: white; padding: 14px 28px; border-radius: 12px; font-weight: 600; z-index: 3000; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none; }
    .toast.show { display: block; animation: slideUp 0.3s; }
    @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
    
    .menu-dropdown { position: absolute; top: 60px; right: 20px; background: white; border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); min-width: 200px; overflow: hidden; z-index: 150; }
    .menu-item { padding: 14px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 600; }
    .menu-item:hover { background: #f8fafc; color: var(--primary); }
    .menu-divider { border-top: 1px solid var(--border); margin: 4px 0; }

    /* ============================================
   MOBILANPASSNING - L√§gg till detta i slutet av <style>
   ============================================ */

@media (max-width: 768px) {
  /* Generella justeringar */
  .container {
    padding: 0 12px;
  }
  
  /* Navigation */
  .nav {
    flex-wrap: wrap;
    gap: 10px;
  }
  
  .brand span {
    font-size: 16px;
  }
  
  /* S√∂kbar - stapla vertikalt p√• mobil */
  .search-bar {
    flex-direction: column;
  }
  
  .search-bar input,
  .search-bar select {
    min-width: 100%;
    width: 100%;
  }
  
  /* Kategorier - b√§ttre scroll */
  .cats {
    gap: 8px;
    padding: 8px 0;
    -webkit-overflow-scrolling: touch;
  }
  
  .cat {
    padding: 8px 14px;
    font-size: 14px;
  }
  
  /* Produktkort - fullbredd p√• sm√• sk√§rmar */
  .grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .card-img {
    height: 240px; /* St√∂rre bilder p√• mobil */
  }
  
  /* Modaler - fullsk√§rm p√• mobil */
  .modal {
    padding: 0;
    align-items: flex-end; /* √ñppna fr√•n botten */
  }
  
  .modal-box {
    max-width: 100%;
    max-height: 95vh;
    border-radius: 20px 20px 0 0; /* Rundade h√∂rn √∂verst */
    width: 100%;
  }
  
  /* Produktmodal - l√§gg till scroll och vertikal layout */
  #productModal .modal-body {
    grid-template-columns: 1fr;
    gap: 16px;
    max-height: calc(95vh - 80px);
    overflow-y: auto;
  }
  
  #modalImg {
    height: 250px;
  }
  
  /* Bildgalleri i modal - scrollbart */
  #modalThumbs {
    flex-wrap: nowrap;
    overflow-x: auto;
    gap: 8px;
    padding-bottom: 8px;
  }
  
  /* S√§lj-modal - enkolumnigt */
  #sellModal .modal-body > div[style*="grid-template-columns"] {
    grid-template-columns: 1fr !important;
  }
  
  /* Chat - fullsk√§rm */
  .chat-panel {
    max-width: 100%;
    width: 100%;
  }
  
  .chat-conv {
    padding: 12px;
  }
  
  /* Profil - b√§ttre padding */
  .profile-grid {
    gap: 16px;
  }
  
  .panel-body {
    padding: 16px;
  }
  
  .stat-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }
  
  .stat-box {
    padding: 12px 8px;
  }
  
  .stat-num {
    font-size: 20px;
  }
  
  /* Lista-produkter i profil */
  .list-item {
    flex-wrap: wrap;
    gap: 12px;
  }
  
  .item-thumb {
    width: 60px;
    height: 60px;
  }
  
  .item-actions {
    width: 100%;
    margin-top: 8px;
  }
  
  /* Admin panel */
  .admin-nav-item {
    padding: 14px 12px;
    font-size: 14px;
  }
  
  /* Bild-grid i s√§ljformul√§r */
  .img-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  /* Toast - s√§kerst√§ll synlighet */
  .toast {
    max-width: 90%;
    text-align: center;
    font-size: 14px;
  }
  
  /* Knappar - st√∂rre touch-m√•l */
  .btn {
    padding: 12px 20px;
    min-height: 44px; /* iOS rekommendation */
  }
  
  .tab-btn {
    padding: 12px 8px;
    font-size: 14px;
  }
  
  /* Meny - fullbredd p√• mobil */
  .menu-dropdown {
    right: 10px;
    left: 10px;
    min-width: auto;
  }
}

/* Extra sm√• sk√§rmar (iPhone SE, gamla Android) */
@media (max-width: 380px) {
  .card-img {
    height: 200px;
  }
  
  .nav {
    padding: 10px 0;
  }
  
  .btn {
    padding: 10px 16px;
    font-size: 14px;
  }
  
  #sellBtn {
    padding: 10px 14px;
  }
  
  .stat-label {
    font-size: 10px;
  }
  
  .badge-pending {
    font-size: 11px;
    padding: 4px 8px;
  }
}

/* Fix f√∂r iOS Safari (viewport height issue) */
@supports (-webkit-touch-callout: none) {
  .page {
    min-height: -webkit-fill-available;
  }
  
  .chat-panel {
    height: -webkit-fill-available;
  }
}

/* F√∂rhindra horisontell scroll */
body {
  overflow-x: hidden;
  max-width: 100vw;
}

/* B√§ttre touch-respons */
button, 
input, 
select, 
textarea,
.cat,
.card,
.chat-conv {
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}

/* St√∂rre text p√• mobil f√∂r l√§sbarhet */
@media (max-width: 768px) {
  body {
    font-size: 16px; /* F√∂rhindrar zoom p√• iOS */
  }
  
  input, 
  select, 
  textarea {
    font-size: 16px; /* Viktigt! 16px f√∂rhindrar auto-zoom p√• iOS */
  }
  
  .card-title {
    font-size: 16px;
  }
  
  .card-price {
    font-size: 20px;
  }
}
  </style>
</head>
<body>

<nav>
  <div class="container nav">
    <div class="brand" onclick="showHome()">
      <div class="logo">üë∂</div>
      <span>Miniblocket</span>
    </div>
    <div style="display: flex; align-items: center; gap: 10px;">
      <button class="btn btn-soft" id="authBtn" onclick="openAuth()">Logga in</button>
      <button class="btn btn-primary hidden" id="sellBtn" onclick="openSellModal()">+ S√§lj</button>
      <button class="btn btn-soft hidden" id="chatBtn" onclick="openChat()" style="position: relative;">
        üí¨
        <span id="chatBadge" class="hidden" style="position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: 800;">0</span>
      </button>
      <div class="avatar hidden" id="userAvatar" onclick="toggleMenu()">??</div>
    </div>
  </div>
</nav>

<div id="userMenu" class="menu-dropdown hidden">
  <div class="menu-item" onclick="showProfile()">üë§ Min profil</div>
  <div class="menu-item hidden" id="adminMenuItem" onclick="showAdmin()">‚öôÔ∏è Admin panel</div>
  <div class="menu-divider"></div>
  <div class="menu-item" onclick="logout()" style="color: var(--danger);">üö™ Logga ut</div>
</div>

<!-- Pages -->
<div id="pageHome" class="page active">
  <div class="container">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="S√∂k annonser..." onkeyup="renderProducts()">
      <select id="filterLoc" onchange="renderProducts()">
        <option value="">Alla platser</option>
        <option>Stockholm</option>
        <option>G√∂teborg</option>
        <option>Malm√∂</option>
        <option>Uppsala</option>
      </select>
    </div>
    
    <div class="cats">
      <button class="cat active" onclick="setCat('all', this)">Allt</button>
      <button class="cat" onclick="setCat('leksaker', this)">üß∏ Leksaker</button>
      <button class="cat" onclick="setCat('barnvagn', this)">üçº Barnvagnar</button>
      <button class="cat" onclick="setCat('bilbarnstol', this)">üöó Bilbarnstolar</button>
      <button class="cat" onclick="setCat('kl√§der', this)">üëï Kl√§der</button>
      <button class="cat" onclick="setCat('m√∂bler', this)">üõèÔ∏è M√∂bler</button>
    </div>

    <div id="productsGrid" class="grid"></div>
    <div id="noResults" class="hidden" style="text-align: center; padding: 60px; color: #64748b;">
      <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>
      <div style="font-weight: 700; font-size: 18px;">Inga annonser hittades</div>
    </div>
  </div>
</div>

<div id="pageProfile" class="page">
  <div class="container">
    <button class="btn btn-soft" onclick="showHome()" style="margin-bottom: 20px;">‚Üê Tillbaka</button>
    
    <div class="profile-grid">
      <div class="panel">
        <div class="panel-header" style="height: 100px; position: relative;">
          <div style="position: absolute; bottom: -40px; left: 20px;">
            <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #fb923c, #ec4899); display: flex; align-items: center; justify-content: center; color: white; font-size: 28px; font-weight: 800; border: 4px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" id="pAvatar">??</div>
          </div>
        </div>
        <div class="panel-body" style="padding-top: 50px;">
          <div style="font-weight: 800; font-size: 20px;" id="pName">--</div>
          <div style="color: #64748b; margin-bottom: 20px;" id="pEmail">--</div>
          
          <div class="stat-grid">
            <div class="stat-box">
              <div class="stat-num" id="statAds">0</div>
              <div class="stat-label">Annonser</div>
            </div>
            <div class="stat-box">
              <div class="stat-num" id="statChats">0</div>
              <div class="stat-label">Chattar</div>
            </div>
            <div class="stat-box">
              <div class="stat-num" id="statFavs">0</div>
              <div class="stat-label">Favoriter</div>
            </div>
          </div>
          
          <button class="btn btn-primary" style="width: 100%;" onclick="openSellModal()">+ Ny annons</button>
        </div>
      </div>
      
      <div>
        <div class="tab-bar">
          <button class="tab-btn active" onclick="switchTab('active', this)">Aktiva</button>
          <button class="tab-btn" onclick="switchTab('history', this)">Historik</button>
          <button class="tab-btn" onclick="switchTab('favorites', this)">Favoriter</button>
        </div>
        
        <div id="tabContent"></div>
      </div>
    </div>
  </div>
</div>

<div id="pageAdmin" class="page">
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <button class="btn btn-soft" onclick="showHome()">‚Üê Tillbaka</button>
      <h2>Administration <span style="background: var(--danger); color: white; padding: 4px 12px; border-radius: 12px; font-size: 14px;">ADMIN</span></h2>
    </div>
    
    <div class="profile-grid">
      <div class="panel">
        <div class="panel-body">
          <div class="admin-nav">
            <div class="admin-nav-item active" onclick="setAdminTab('overview', this)">
              <span>üìä √ñversikt</span>
            </div>
            <div class="admin-nav-item" onclick="setAdminTab('pending', this)">
              <span>‚è≥ Granskning</span>
              <span class="count-badge hidden" id="badgePending">0</span>
            </div>
            <div class="admin-nav-item" onclick="setAdminTab('reports', this)">
              <span>üö® Anm√§lningar</span>
              <span class="count-badge hidden" id="badgeReports">0</span>
            </div>
            <div class="admin-nav-item" onclick="setAdminTab('users', this)">
              <span>üë• Anv√§ndare</span>
            </div>
          </div>
        </div>
      </div>
      
      <div id="adminContent">
        <!-- Dynamic content loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="authModal" class="modal" onclick="if(event.target === this) closeModal('authModal')">
  <div class="modal-box" style="max-width: 400px;">
    <div class="modal-head">
      <h3 id="authTitle">Logga in</h3>
      <button class="close-btn" onclick="closeModal('authModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="authNameField" class="hidden">
        <label style="font-weight: 600; display: block; margin-bottom: 6px;">Namn</label>
        <input type="text" id="authName" placeholder="Ditt namn">
      </div>
      
      <label style="font-weight: 600; display: block; margin-bottom: 6px; margin-top: 12px;">E-post</label>
      <input type="email" id="authEmail" placeholder="namn@exempel.se">
      
      <label style="font-weight: 600; display: block; margin-bottom: 6px; margin-top: 12px;">L√∂senord</label>
      <input type="password" id="authPass" placeholder="Minst 6 tecken">
      
      <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
        <button class="btn btn-primary" onclick="handleAuth()" id="authActionBtn" style="width: 100%;">Logga in</button>
        <button class="btn btn-soft" onclick="toggleAuthMode()" style="width: 100%;" id="authToggleBtn">Skapa konto ist√§llet</button>
      </div>
      
      <div style="margin-top: 16px; padding: 12px; background: #f1f5f9; border-radius: 8px; font-size: 13px;">
        <strong>Admin-login:</strong><br>
        E-post: admin@miniblocket.se<br>
        L√∂sen: admin123
      </div>
    </div>
  </div>
</div>

<div id="sellModal" class="modal" onclick="if(event.target === this) closeModal('sellModal')">
  <div class="modal-box" style="max-width: 600px;">
    <div class="modal-head">
      <h3 id="sellTitle">Ny annons</h3>
      <button class="close-btn" onclick="closeModal('sellModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editId">
      
      <label style="font-weight: 600;">Titel</label>
      <input type="text" id="sellTitleInput" placeholder="Vad s√§ljer du?">
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div>
          <label style="font-weight: 600;">Pris (kr)</label>
          <input type="number" id="sellPrice" placeholder="0">
        </div>
        <div>
          <label style="font-weight: 600;">Kategori</label>
          <select id="sellCat">
            <option value="leksaker">Leksaker</option>
            <option value="barnvagn">Barnvagn</option>
            <option value="bilbarnstol">Bilbarnstol</option>
            <option value="kl√§der">Kl√§der</option>
            <option value="m√∂bler">M√∂bler</option>
          </select>
        </div>
      </div>
      
      <label style="font-weight: 600; display: block; margin-top: 12px;">Plats</label>
      <select id="sellLoc">
        <option>Stockholm</option>
        <option>G√∂teborg</option>
        <option>Malm√∂</option>
        <option>Uppsala</option>
      </select>
      
      <label style="font-weight: 600; display: block; margin-top: 12px;">Beskrivning</label>
      <textarea id="sellDesc" rows="3" placeholder="Beskriv varan..."></textarea>
      
      <label style="font-weight: 600; display: block; margin-top: 12px;">Bilder (max 6)</label>
      <input type="file" id="sellImages" multiple accept="image/*" onchange="previewImages(this)">
      
      <div id="imagePreviewGrid" class="img-grid"></div>
      
      <div id="pendingNotice" class="hidden" style="background: #fef3c7; padding: 12px; border-radius: 8px; margin: 12px 0; color: #92400e; font-size: 14px;">
        ‚è≥ Din annons kommer granskas av admin innan den publiceras.
      </div>
      
      <div style="display: flex; gap: 12px; margin-top: 20px;">
        <button class="btn btn-soft" style="flex: 1;" onclick="closeModal('sellModal')">Avbryt</button>
        <button class="btn btn-primary" style="flex: 1;" onclick="submitProduct()">Publicera</button>
      </div>
    </div>
  </div>
</div>

<div id="productModal" class="modal" onclick="if(event.target === this) closeModal('productModal')">
  <div class="modal-box">
    <div class="modal-head">
      <h3>Annonsdetaljer</h3>
      <button class="close-btn" onclick="closeModal('productModal')">‚úï</button>
    </div>
    <div class="modal-body" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
      <div>
        <img id="modalImg" style="width: 100%; height: 300px; object-fit: cover; border-radius: 12px; background: #f1f5f9;">
        <div id="modalThumbs" style="display: flex; gap: 8px; margin-top: 12px; overflow-x: auto;"></div>
      </div>
      <div>
        <div id="modalStatus"></div>
        <h2 id="modalTitle" style="font-size: 24px; font-weight: 800; margin: 8px 0;">--</h2>
        <div id="modalPrice" style="font-size: 28px; font-weight: 800; color: var(--primary);">--</div>
        <div id="modalMeta" style="color: #64748b; margin: 12px 0;">--</div>
        
        <div style="display: flex; gap: 12px; margin: 20px 0;">
          <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #0ea5e9); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;" id="modalSellerAvatar">??</div>
          <div>
            <div id="modalSellerName" style="font-weight: 700;">--</div>
            <div style="font-size: 14px; color: #64748b;">S√§ljare</div>
          </div>
        </div>
        
        <p id="modalDesc" style="color: #64748b; line-height: 1.6; margin-bottom: 20px;">--</p>
        
        <div id="modalActions" style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn btn-primary" id="btnContact" onclick="contactSeller()">üí¨ Kontakta</button>
          <button class="btn btn-soft" onclick="toggleFavoriteFromModal()">ü§ç Favorit</button>
          <button class="btn btn-warning" onclick="openReport()">üö® Anm√§l</button>
        </div>
        
        <div id="ownerActions" class="hidden" style="border-top: 1px solid var(--border); margin-top: 20px; padding-top: 20px;">
          <div style="font-weight: 600; margin-bottom: 10px; color: #64748b;">Hantera din annons:</div>
          <button class="btn btn-soft" onclick="editProduct()">‚úèÔ∏è Redigera</button>
          <button class="btn btn-success" id="btnSold" onclick="markSold()">‚úì Markera s√•ld</button>
          <button class="btn btn-danger" onclick="deleteProduct()">üóëÔ∏è Ta bort</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="reportModal" class="modal" onclick="if(event.target === this) closeModal('reportModal')">
  <div class="modal-box" style="max-width: 400px;">
    <div class="modal-head" style="background: #fef3c7;">
      <h3>üö® Anm√§l</h3>
      <button class="close-btn" onclick="closeModal('reportModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <label style="font-weight: 600;">Anledning</label>
      <select id="reportReason" style="margin-bottom: 12px;">
        <option value="Bedr√§geri">Bedr√§geri</option>
        <option value="Ol√§mpligt inneh√•ll">Ol√§mpligt inneh√•ll</option>
        <option value="Spam">Spam</option>
        <option value="Fejk">Fejk/felaktig</option>
        <option value="Annat">Annat</option>
      </select>
      
      <label style="font-weight: 600;">Detaljer (valfritt)</label>
      <textarea id="reportDetails" rows="3" placeholder="Beskriv problemet..."></textarea>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-soft" style="flex: 1;" onclick="closeModal('reportModal')">Avbryt</button>
        <button class="btn btn-danger" style="flex: 1;" onclick="submitReport()">Skicka</button>
      </div>
    </div>
  </div>
</div>

<div id="deleteModal" class="modal" onclick="if(event.target === this) closeModal('deleteModal')">
  <div class="modal-box" style="max-width: 400px;">
    <div class="modal-head" style="background: #fee2e2;">
      <h3>üóëÔ∏è Ta bort annons?</h3>
      <button class="close-btn" onclick="closeModal('deleteModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom: 16px;">Varf√∂r tas annonsen bort?</p>
      <select id="deleteReason" style="margin-bottom: 20px;">
        <option value="Varan √§r s√•ld">Varan √§r s√•ld</option>
        <option value="√Öngrar f√∂rs√§ljning">√Öngrar f√∂rs√§ljning</option>
        <option value="Ville inte s√§lja">Ville inte s√§lja</option>
        <option value="Annat">Annat</option>
      </select>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-soft" style="flex: 1;" onclick="closeModal('deleteModal')">Avbryt</button>
        <button class="btn btn-danger" style="flex: 1;" onclick="confirmDelete()">Ta bort</button>
      </div>
    </div>
  </div>
</div>

<!-- Chat -->
<div id="chatOverlay" class="chat-overlay" onclick="closeChat()"></div>
<div id="chatPanel" class="chat-panel">
  <div style="display: flex; height: 100%;">
    <div style="width: 100%; display: flex; flex-direction: column;">
      <div class="chat-header">
        <h3 style="margin: 0;">üí¨ Meddelanden</h3>
        <button class="close-btn" onclick="closeChat()">‚úï</button>
      </div>
      <div id="chatList" class="chat-list"></div>
    </div>
    <div id="chatConversation" class="chat-main hidden" style="position: absolute; inset: 0; background: white; z-index: 10;">
      <div class="chat-header">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div id="chatAvatar" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #fb923c, #ec4899); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">??</div>
          <div>
            <div id="chatName" style="font-weight: 700;">--</div>
            <div style="font-size: 12px; color: var(--success);">‚óè Online</div>
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button onclick="reportFromChat()" style="background: none; border: none; cursor: pointer; font-size: 20px;" title="Anm√§l">üö®</button>
          <button onclick="deleteCurrentChat()" style="background: none; border: none; cursor: pointer; font-size: 20px;" title="Radera">üóëÔ∏è</button>
          <button class="close-btn" onclick="backToChatList()">‚Üê</button>
        </div>
      </div>
      <div id="chatMessages" class="chat-messages"></div>
      <div class="chat-input">
        <input type="text" id="msgInput" placeholder="Skriv ett meddelande..." onkeypress="if(event.key === 'Enter') sendMessage()">
        <button class="send-btn" onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
// Global state
let currentUser = null;
let currentProduct = null;
let currentChat = null;
let tempImages = [];
let products = [];
let users = [];
let reports = [];
let conversations = [];

const LS_PRODUCTS = 'mb_products_v2';
const LS_USERS = 'mb_users_v2';
const LS_REPORTS = 'mb_reports_v2';
const LS_CONV = 'mb_conv_';
const LS_FAV = 'mb_fav_';
const ADMIN_EMAIL = 'admin@miniblocket.se';

// Init
window.onload = function() {
  loadData();
  checkSession();
  renderProducts();
  cleanupSold();
  
  // Close menu when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('#userAvatar') && !e.target.closest('#userMenu')) {
      document.getElementById('userMenu').classList.add('hidden');
    }
  });
};

function loadData() {
  products = JSON.parse(localStorage.getItem(LS_PRODUCTS)) || getSeedData();
  users = JSON.parse(localStorage.getItem(LS_USERS)) || [];
  reports = JSON.parse(localStorage.getItem(LS_REPORTS)) || [];
  saveData();
}

function getSeedData() {
  return [
    {
      id: 1,
      title: 'Bugaboo Cameleon 3 - Toppskick',
      price: 2500,
      category: 'barnvagn',
      location: 'Stockholm',
      description: 'Nyskick, anv√§nd 6 m√•nader. Inklusive regnskydd och muggh√•llare.',
      images: ['https://images.unsplash.com/photo-1566004100631-35d015d6a491?w=400&q=80'],
      seller: 'Anna S.',
      sellerId: 'seed1',
      status: 'active',
      date: new Date().toLocaleDateString('sv-SE'),
      createdAt: new Date().toISOString()
    },
    {
      id: 2,
      title: 'LEGO Duplo - Stort l√•da 100 bitar',
      price: 350,
      category: 'leksaker',
      location: 'G√∂teborg',
      description: 'Komplett set med f√∂rvaringsl√•da. Nyskick.',
      images: ['https://images.unsplash.com/photo-1585366119957-e9730b6d0f60?w=400&q=80'],
      seller: 'Erik L.',
      sellerId: 'seed2',
      status: 'active',
      date: new Date().toLocaleDateString('sv-SE'),
      createdAt: new Date().toISOString()
    }
  ];
}

function saveData() {
  localStorage.setItem(LS_PRODUCTS, JSON.stringify(products));
  localStorage.setItem(LS_USERS, JSON.stringify(users));
  localStorage.setItem(LS_REPORTS, JSON.stringify(reports));
}

function checkSession() {
  const session = JSON.parse(localStorage.getItem('mb_session'));
  if (session) {
    const user = users.find(u => u.id === session.userId);
    if (user) login(user);
  }
}

// Auth
let authMode = 'login';

function openAuth() {
  authMode = 'login';
  updateAuthUI();
  showModal('authModal');
}

function toggleAuthMode() {
  authMode = authMode === 'login' ? 'signup' : 'login';
  updateAuthUI();
}

function updateAuthUI() {
  document.getElementById('authTitle').textContent = authMode === 'login' ? 'Logga in' : 'Skapa konto';
  document.getElementById('authActionBtn').textContent = authMode === 'login' ? 'Logga in' : 'Registrera dig';
  document.getElementById('authToggleBtn').textContent = authMode === 'login' ? 'Skapa konto ist√§llet' : 'Har du redan konto?';
  document.getElementById('authNameField').classList.toggle('hidden', authMode === 'login');
}

function handleAuth() {
  const email = document.getElementById('authEmail').value.trim().toLowerCase();
  const pass = document.getElementById('authPass').value;
  
  if (authMode === 'signup') {
    const name = document.getElementById('authName').value.trim();
    if (!name || !email || !pass) {
      showToast('Fyll i alla f√§lt');
      return;
    }
    if (users.find(u => u.email === email)) {
      showToast('E-postadressen finns redan');
      return;
    }
    
    const newUser = {
      id: Date.now().toString(),
      name: name,
      email: email,
      pass: pass,
      createdAt: new Date().toISOString(),
      isAdmin: false
    };
    
    // Auto-create admin if email matches
    if (email === ADMIN_EMAIL && pass === 'admin123') {
      newUser.isAdmin = true;
    }
    
    users.push(newUser);
    saveData();
    showToast('Konto skapat! V√§lkommen.');
    login(newUser);
    closeModal('authModal');
  } else {
    // Login
    if (email === ADMIN_EMAIL && pass === 'admin123') {
      let admin = users.find(u => u.email === ADMIN_EMAIL);
      if (!admin) {
        admin = {
          id: 'admin_' + Date.now(),
          name: 'Admin',
          email: ADMIN_EMAIL,
          pass: 'admin123',
          isAdmin: true,
          createdAt: new Date().toISOString()
        };
        users.push(admin);
        saveData();
      }
      login(admin);
      closeModal('authModal');
      return;
    }
    
    const user = users.find(u => u.email === email && u.pass === pass);
    if (!user) {
      showToast('Fel e-post eller l√∂senord');
      return;
    }
    if (user.banned) {
      showToast('Kontot √§r blockerat: ' + (user.banReason || 'Kontakta support'));
      return;
    }
    login(user);
    closeModal('authModal');
  }
}

function login(user) {
  currentUser = user;
  localStorage.setItem('mb_session', JSON.stringify({ userId: user.id }));
  
  document.getElementById('authBtn').classList.add('hidden');
  document.getElementById('userAvatar').classList.remove('hidden');
  document.getElementById('sellBtn').classList.remove('hidden');
  document.getElementById('chatBtn').classList.remove('hidden');
  document.getElementById('userAvatar').textContent = user.name.substring(0, 2).toUpperCase();
  
  document.getElementById('pName').textContent = user.name;
  document.getElementById('pEmail').textContent = user.email;
  document.getElementById('pAvatar').textContent = user.name.substring(0, 2).toUpperCase();
  
  if (user.isAdmin) {
    document.getElementById('adminMenuItem').classList.remove('hidden');
  }
  
  loadConversations();
  updateStats();
  showToast('V√§lkommen ' + user.name + '!');
}

function logout() {
  currentUser = null;
  localStorage.removeItem('mb_session');
  location.reload();
}

function toggleMenu() {
  document.getElementById('userMenu').classList.toggle('hidden');
}

// Navigation
function showHome() {
  hideAllPages();
  document.getElementById('pageHome').classList.add('active');
  renderProducts();
  document.getElementById('userMenu').classList.add('hidden');
}

function showProfile() {
  if (!currentUser) return;
  hideAllPages();
  document.getElementById('pageProfile').classList.add('active');
  switchTab('active', document.querySelector('#pageProfile .tab-btn'));
  document.getElementById('userMenu').classList.add('hidden');
  updateStats();
}

function showAdmin() {
  hideAllPages();
  document.getElementById('pageAdmin').classList.add('active');
  setAdminTab('overview', document.querySelector('.admin-nav-item'));
  document.getElementById('userMenu').classList.add('hidden');
}

function hideAllPages() {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
}

// Products
function renderProducts() {
  const grid = document.getElementById('productsGrid');
  const search = document.getElementById('searchInput').value.toLowerCase();
  const loc = document.getElementById('filterLoc').value;
  
  let list = products.filter(p => p.status === 'active' && p.visible !== false);
  
  if (search) {
    list = list.filter(p => p.title.toLowerCase().includes(search));
  }
  if (loc) {
    list = list.filter(p => p.location === loc);
  }
  
  // Get active category
  const activeCatBtn = document.querySelector('.cat.active');
  const cat = activeCatBtn ? activeCatBtn.textContent.includes('Allt') ? 'all' : activeCatBtn.getAttribute('onclick').match(/'(.*?)'/)[1] : 'all';
  
  if (cat !== 'all') {
    list = list.filter(p => p.category === cat);
  }
  
  if (list.length === 0) {
    grid.innerHTML = '';
    document.getElementById('noResults').classList.remove('hidden');
    return;
  }
  document.getElementById('noResults').classList.add('hidden');
  
  grid.innerHTML = list.map(p => {
    const isFav = isFavorite(p.id);
    return `
      <div class="card ${p.status === 'sold' ? 'sold' : ''}" onclick="openProduct(${p.id})">
        <div style="position: relative;">
          <img src="${p.images[0]}" class="card-img" alt="">
          ${p.status === 'pending' ? '<div class="badge-pending">V√ÑNTAR</div>' : ''}
          <button class="fav-btn ${isFav ? 'active' : ''}" onclick="event.stopPropagation(); toggleFav(${p.id})" style="${isFav ? 'background: #fee2e2;' : ''}">
            ${isFav ? '‚ù§Ô∏è' : 'ü§ç'}
          </button>
        </div>
        <div class="card-body">
          <div class="card-title">${escapeHtml(p.title)}</div>
          <div class="card-price">${p.price} kr</div>
          <div class="card-meta">
            <span>üìç ${p.location}</span>
            <span>${p.date}</span>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function setCat(cat, btn) {
  document.querySelectorAll('.cat').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderProducts();
}

function openProduct(id) {
  currentProduct = products.find(p => p.id === id);
  if (!currentProduct) return;
  
  document.getElementById('modalTitle').textContent = currentProduct.title;
  document.getElementById('modalPrice').textContent = currentProduct.price + ' kr';
  document.getElementById('modalMeta').textContent = `${currentProduct.location} ‚Ä¢ ${currentProduct.date} ‚Ä¢ ${currentProduct.category}`;
  document.getElementById('modalDesc').textContent = currentProduct.description || 'Ingen beskrivning.';
  document.getElementById('modalSellerName').textContent = currentProduct.seller;
  document.getElementById('modalSellerAvatar').textContent = currentProduct.seller.substring(0, 2).toUpperCase();
  document.getElementById('modalImg').src = currentProduct.images[0];
  
  // Thumbs
  const thumbsDiv = document.getElementById('modalThumbs');
  thumbsDiv.innerHTML = currentProduct.images.map((img, i) => `
    <img src="${img}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; border: ${i === 0 ? '2px solid var(--primary)' : '2px solid transparent'};" 
    onclick="document.getElementById('modalImg').src = this.src; document.querySelectorAll('#modalThumbs img').forEach(t => t.style.border = '2px solid transparent'); this.style.border = '2px solid var(--primary)';">
  `).join('');
  
  // Status
  const statusDiv = document.getElementById('modalStatus');
  if (currentProduct.status === 'sold') {
    statusDiv.innerHTML = '<span class="badge-sold">S√ÖLD</span>';
  } else if (currentProduct.status === 'pending') {
    statusDiv.innerHTML = '<span class="status-badge-small status-pending">V√ÑNTAR P√Ö GRANSKNING</span>';
  } else {
    statusDiv.innerHTML = '<span class="status-badge-small status-active">AKTIV</span>';
  }
  
  // Owner check
  const isOwner = currentUser && currentUser.id === currentProduct.sellerId;
  document.getElementById('ownerActions').classList.toggle('hidden', !isOwner);
  document.getElementById('btnContact').style.display = isOwner ? 'none' : 'inline-flex';
  
  if (isOwner) {
    document.getElementById('btnSold').textContent = currentProduct.status === 'sold' ? '‚Ü© √Öngra s√•ld' : '‚úì Markera som s√•ld';
  }
  
  showModal('productModal');
}

// Sell
function openSellModal() {
  if (!currentUser) {
    showToast('Logga in f√∂r att s√§lja');
    openAuth();
    return;
  }
  tempImages = [];
  document.getElementById('sellTitleInput').value = '';
  document.getElementById('sellPrice').value = '';
  document.getElementById('sellDesc').value = '';
  document.getElementById('editId').value = '';
  document.getElementById('sellTitle').textContent = 'Ny annons';
  document.getElementById('imagePreviewGrid').innerHTML = '';
  document.getElementById('pendingNotice').classList.remove('hidden');
  showModal('sellModal');
}

function previewImages(input) {
  const files = Array.from(input.files).slice(0, 6);
  tempImages = [];
  const grid = document.getElementById('imagePreviewGrid');
  grid.innerHTML = '';
  
  files.forEach((file, i) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      tempImages.push(e.target.result);
      grid.innerHTML += `
        <div class="img-preview">
          <img src="${e.target.result}">
          <button class="remove-img" onclick="removeImage(${i})">‚úï</button>
        </div>
      `;
    };
    reader.readAsDataURL(file);
  });
}

function removeImage(idx) {
  tempImages.splice(idx, 1);
  document.getElementById('imagePreviewGrid').innerHTML = tempImages.map((img, i) => `
    <div class="img-preview">
      <img src="${img}">
      <button class="remove-img" onclick="removeImage(${i})">‚úï</button>
    </div>
  `).join('');
}

function submitProduct() {
  const title = document.getElementById('sellTitleInput').value.trim();
  const price = parseInt(document.getElementById('sellPrice').value);
  const cat = document.getElementById('sellCat').value;
  const loc = document.getElementById('sellLoc').value;
  const desc = document.getElementById('sellDesc').value.trim();
  const editId = document.getElementById('editId').value;
  
  if (!title || !price) {
    showToast('Fyll i titel och pris');
    return;
  }
  
  if (tempImages.length === 0 && !editId) {
    showToast('L√§gg till minst en bild');
    return;
  }
  
  if (editId) {
    // Edit
    const p = products.find(x => x.id == editId);
    if (p) {
      p.title = title;
      p.price = price;
      p.category = cat;
      p.location = loc;
      p.description = desc;
      if (tempImages.length > 0) p.images = tempImages;
      saveData();
      showToast('Annons uppdaterad');
      closeModal('sellModal');
      renderProducts();
      if (document.getElementById('pageProfile').classList.contains('active')) {
        switchTab('active', document.querySelector('#pageProfile .tab-btn.active'));
      }
    }
  } else {
    // New
    const newProduct = {
      id: Date.now(),
      title: title,
      price: price,
      category: cat,
      location: loc,
      description: desc,
      images: tempImages.length > 0 ? tempImages : ['https://via.placeholder.com/400'],
      seller: currentUser.name,
      sellerId: currentUser.id,
      status: currentUser.isAdmin ? 'active' : 'pending',
      date: new Date().toLocaleDateString('sv-SE'),
      createdAt: new Date().toISOString(),
      visible: true
    };
    
    products.unshift(newProduct);
    saveData();
    
    if (currentUser.isAdmin) {
      showToast('Annons publicerad');
    } else {
      showToast('Annons skickad till granskning');
    }
    
    closeModal('sellModal');
    renderProducts();
    updateStats();
  }
}

function editProduct() {
  closeModal('productModal');
  document.getElementById('sellTitle').textContent = 'Redigera annons';
  document.getElementById('sellTitleInput').value = currentProduct.title;
  document.getElementById('sellPrice').value = currentProduct.price;
  document.getElementById('sellCat').value = currentProduct.category;
  document.getElementById('sellLoc').value = currentProduct.location;
  document.getElementById('sellDesc').value = currentProduct.description || '';
  document.getElementById('editId').value = currentProduct.id;
  document.getElementById('pendingNotice').classList.add('hidden');
  
  tempImages = currentProduct.images;
  document.getElementById('imagePreviewGrid').innerHTML = tempImages.map((img, i) => `
    <div class="img-preview">
      <img src="${img}">
      <button class="remove-img" onclick="removeImage(${i})">‚úï</button>
    </div>
  `).join('');
  
  showModal('sellModal');
}

function markSold() {
  if (!currentProduct) return;
  if (currentProduct.status === 'sold') {
    currentProduct.status = 'active';
    delete currentProduct.soldAt;
    showToast('Annons √•teraktiverad');
  } else {
    currentProduct.status = 'sold';
    currentProduct.soldAt = new Date().toISOString();
    showToast('Grattis! Annonser visas som s√•ld i 24h');
  }
  saveData();
  closeModal('productModal');
  renderProducts();
  updateStats();
}

function deleteProduct() {
  closeModal('productModal');
  showModal('deleteModal');
}

function confirmDelete() {
  if (!currentProduct) return;
  const reason = document.getElementById('deleteReason').value;
  
  currentProduct.status = 'deleted';
  currentProduct.deleteReason = reason;
  currentProduct.deletedAt = new Date().toISOString();
  currentProduct.visible = false;
  
  saveData();
  showToast('Annons borttagen');
  closeModal('deleteModal');
  renderProducts();
  if (document.getElementById('pageProfile').classList.contains('active')) {
    switchTab('active', document.querySelector('#pageProfile .tab-btn.active'));
  }
}

function cleanupSold() {
  const now = new Date();
  let changed = false;
  products.forEach(p => {
    if (p.status === 'sold' && p.soldAt) {
      const soldTime = new Date(p.soldAt);
      const hours = (now - soldTime) / 36e5;
      if (hours > 24) {
        p.status = 'archived';
        p.visible = false;
        changed = true;
      }
    }
  });
  if (changed) saveData();
}

// Favorites
function isFavorite(id) {
  if (!currentUser) return false;
  const favs = JSON.parse(localStorage.getItem(LS_FAV + currentUser.id)) || [];
  return favs.includes(id);
}

function toggleFav(id) {
  if (!currentUser) {
    showToast('Logga in f√∂r att spara favoriter');
    return;
  }
  let favs = JSON.parse(localStorage.getItem(LS_FAV + currentUser.id)) || [];
  if (favs.includes(id)) {
    favs = favs.filter(x => x !== id);
    showToast('Borttagen fr√•n favoriter');
  } else {
    favs.push(id);
    showToast('Sparad som favorit');
  }
  localStorage.setItem(LS_FAV + currentUser.id, JSON.stringify(favs));
  renderProducts();
  updateStats();
}

function toggleFavoriteFromModal() {
  if (!currentProduct) return;
  toggleFav(currentProduct.id);
  closeModal('productModal');
  setTimeout(() => openProduct(currentProduct.id), 300);
}

// Profile tabs
function switchTab(tab, btn) {
  document.querySelectorAll('#pageProfile .tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  
  const content = document.getElementById('tabContent');
  
  if (tab === 'active') {
    const myProducts = products.filter(p => p.sellerId === currentUser.id && p.status !== 'deleted' && p.status !== 'archived');
    if (myProducts.length === 0) {
      content.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">Du har inga aktiva annonser</div>';
      return;
    }
    content.innerHTML = myProducts.map(p => renderProductItem(p)).join('');
  } else if (tab === 'history') {
    const history = products.filter(p => p.sellerId === currentUser.id && (p.status === 'sold' || p.status === 'archived' || p.status === 'deleted'));
    if (history.length === 0) {
      content.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">Ingen historik</div>';
      return;
    }
    content.innerHTML = history.map(p => renderProductItem(p, true)).join('');
  } else if (tab === 'favorites') {
    const favs = JSON.parse(localStorage.getItem(LS_FAV + currentUser.id)) || [];
    const favProducts = products.filter(p => favs.includes(p.id) && p.status === 'active');
    if (favProducts.length === 0) {
      content.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">Inga favoriter sparade</div>';
      return;
    }
    content.innerHTML = favProducts.map(p => renderProductItem(p)).join('');
  }
}

function renderProductItem(p, isHistory = false) {
  const isSold = p.status === 'sold' || p.status === 'archived';
  const statusBadge = isSold ? '<span class="badge-sold">S√ÖLD</span>' : p.status === 'pending' ? '<span class="status-badge-small status-pending">V√ÑNTAR</span>' : '';
  
  return `
    <div class="list-item" style="${isSold ? 'opacity: 0.7;' : ''} cursor: ${isSold ? 'default' : 'pointer'};" onclick="${isSold ? '' : `openProduct(${p.id})`}">
      <img src="${p.images[0]}" class="item-thumb" style="${isSold ? 'filter: grayscale(1);' : ''}">
      <div class="item-content" style="flex: 1;">
        <div class="item-title" style="${isSold ? 'text-decoration: line-through;' : ''}">${escapeHtml(p.title)} ${statusBadge}</div>
        <div class="item-meta">${p.price} kr ‚Ä¢ ${p.location}</div>
        ${p.deleteReason ? `<div class="item-meta">Anledning: ${p.deleteReason}</div>` : ''}
        
        ${!isHistory ? `
          <div class="item-actions" onclick="event.stopPropagation()">
            ${p.status !== 'pending' ? `<button class="btn btn-success" onclick="quickSold(${p.id})">${p.status === 'sold' ? '√Öngra' : 'S√•ld'}</button>` : ''}
            <button class="btn btn-danger" onclick="prepDelete(${p.id})">Ta bort</button>
          </div>
        ` : ''}
      </div>
    </div>
  `;
}

function quickSold(id) {
  const p = products.find(x => x.id === id);
  if (p) {
    if (p.status === 'sold') {
      p.status = 'active';
      delete p.soldAt;
    } else {
      p.status = 'sold';
      p.soldAt = new Date().toISOString();
    }
    saveData();
    showToast(p.status === 'sold' ? 'Markerad som s√•ld' : '√Öteraktiverad');
    switchTab('active', document.querySelector('#pageProfile .tab-btn.active'));
    updateStats();
  }
  event.stopPropagation();
}

function prepDelete(id) {
  currentProduct = products.find(x => x.id === id);
  if (currentProduct) {
    showModal('deleteModal');
  }
  event.stopPropagation();
}

function updateStats() {
  if (!currentUser) return;
  const myProducts = products.filter(p => p.sellerId === currentUser.id && p.status !== 'deleted' && p.status !== 'archived');
  document.getElementById('statAds').textContent = myProducts.length;
  
  const convs = JSON.parse(localStorage.getItem(LS_CONV + currentUser.id)) || [];
  document.getElementById('statChats').textContent = convs.length;
  
  const favs = JSON.parse(localStorage.getItem(LS_FAV + currentUser.id)) || [];
  document.getElementById('statFavs').textContent = favs.length;
  
  const badge = document.getElementById('chatBadge');
  if (convs.length > 0) {
    badge.textContent = convs.length;
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }
}

// Chat
function openChat() {
  if (!currentUser) {
    showToast('Logga in f√∂r att chatta');
    return;
  }
  loadConversations();
  document.getElementById('chatPanel').classList.add('show');
  document.getElementById('chatOverlay').classList.add('show');
}

function closeChat() {
  document.getElementById('chatPanel').classList.remove('show');
  document.getElementById('chatOverlay').classList.remove('show');
  document.getElementById('chatConversation').classList.add('hidden');
}

function loadConversations() {
  if (!currentUser) return;
  const convs = JSON.parse(localStorage.getItem(LS_CONV + currentUser.id)) || [];
  const list = document.getElementById('chatList');
  
  if (convs.length === 0) {
    list.innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">Inga konversationer √§n</div>';
    return;
  }
  
  list.innerHTML = convs.map(c => `
    <div class="chat-conv" onclick="openConversation(${c.id})">
      <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #fb923c, #ec4899); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; flex-shrink: 0;">
        ${(c.withName || '??').substring(0, 2).toUpperCase()}
      </div>
      <div style="flex: 1; min-width: 0;">
        <div style="font-weight: 700;">${escapeHtml(c.withName || 'Ok√§nd')}</div>
        <div style="font-size: 14px; color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
          ${c.lastMsg || 'Inga meddelanden'}
        </div>
      </div>
      <button class="delete-conv" onclick="event.stopPropagation(); deleteConversation(${c.id})">üóëÔ∏è</button>
    </div>
  `).join('');
}

function openConversation(id) {
  const convs = JSON.parse(localStorage.getItem(LS_CONV + currentUser.id)) || [];
  currentChat = convs.find(c => c.id === id);
  if (!currentChat) return;
  
  document.getElementById('chatConversation').classList.remove('hidden');
  document.getElementById('chatName').textContent = currentChat.withName || 'Ok√§nd';
  document.getElementById('chatAvatar').textContent = (currentChat.withName || '??').substring(0, 2).toUpperCase();
  
  renderMessages();
}

function renderMessages() {
  const container = document.getElementById('chatMessages');
  if (!currentChat || !currentChat.messages) {
    container.innerHTML = '<div style="text-align: center; color: #64748b; margin-top: 40px;">Skriv f√∂rsta meddelandet</div>';
    return;
  }
  
  container.innerHTML = currentChat.messages.map(m => `
    <div class="msg ${m.from === currentUser.id ? 'sent' : 'received'}">
      ${escapeHtml(m.text)}
      <div class="msg-time">${m.time || ''}</div>
    </div>
  `).join('');
  
  container.scrollTop = container.scrollHeight;
}

function sendMessage() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text || !currentChat) return;
  
  if (!currentChat.messages) currentChat.messages = [];
  currentChat.messages.push({
    from: currentUser.id,
    text: text,
    time: new Date().toLocaleTimeString('sv-SE', {hour: '2-digit', minute: '2-digit'})
  });
  currentChat.lastMsg = text;
  
  saveConversations();
  input.value = '';
  renderMessages();
  
  // Simulate reply
  setTimeout(() => {
    currentChat.messages.push({
      from: 'them',
      text: 'Hej! Tack f√∂r ditt meddelande. Jag √•terkommer s√• snart som m√∂jligt.',
      time: new Date().toLocaleTimeString('sv-SE', {hour: '2-digit', minute: '2-digit'})
    });
    currentChat.lastMsg = 'Hej! Tack f√∂r ditt meddelande...';
    saveConversations();
    renderMessages();
  }, 2000);
}

function saveConversations() {
  if (!currentUser || !currentChat) return;
  let convs = JSON.parse(localStorage.getItem(LS_CONV + currentUser.id)) || [];
  const idx = convs.findIndex(c => c.id === currentChat.id);
  if (idx >= 0) convs[idx] = currentChat;
  else convs.push(currentChat);
  localStorage.setItem(LS_CONV + currentUser.id, JSON.stringify(convs));
  loadConversations();
  updateStats();
}

function backToChatList() {
  document.getElementById('chatConversation').classList.add('hidden');
  currentChat = null;
}

function deleteConversation(id) {
  if (!confirm('Radera konversationen?')) return;
  let convs = JSON.parse(localStorage.getItem(LS_CONV + currentUser.id)) || [];
  convs = convs.filter(c => c.id !== id);
  localStorage.setItem(LS_CONV + currentUser.id, JSON.stringify(convs));
  loadConversations();
  document.getElementById('chatConversation').classList.add('hidden');
  updateStats();
}

function deleteCurrentChat() {
  if (currentChat) deleteConversation(currentChat.id);
}

function contactSeller() {
  if (!currentUser) {
    showToast('Logga in f√∂rst');
    return;
  }
  if (currentProduct.sellerId === currentUser.id) {
    showToast('Detta √§r din egen annons');
    return;
  }
  
  const convId = Date.now();
  const newConv = {
    id: convId,
    withId: currentProduct.sellerId,
    withName: currentProduct.seller,
    productId: currentProduct.id,
    lastMsg: 'Hej! Jag √§r intresserad av din annons.',
    messages: [{
      from: currentUser.id,
      text: 'Hej! Jag √§r intresserad av din annons.',
      time: new Date().toLocaleTimeString('sv-SE', {hour: '2-digit', minute: '2-digit'})
    }]
  };
  
  let convs = JSON.parse(localStorage.getItem(LS_CONV + currentUser.id)) || [];
  convs.push(newConv);
  localStorage.setItem(LS_CONV + currentUser.id, JSON.stringify(convs));
  
  closeModal('productModal');
  openChat();
  openConversation(convId);
  showToast('Konversation startad');
}

function reportFromChat() {
  if (!currentChat) return;
  const mockProduct = { id: 'user_' + currentChat.withId, seller: currentChat.withName };
  currentProduct = mockProduct;
  openReport();
}

// Reports
function openReport() {
  if (!currentUser) {
    showToast('Logga in f√∂r att anm√§la');
    return;
  }
  document.getElementById('reportReason').value = 'Bedr√§geri';
  document.getElementById('reportDetails').value = '';
  showModal('reportModal');
}

function submitReport() {
  const reason = document.getElementById('reportReason').value;
  const details = document.getElementById('reportDetails').value;
  
  if (!currentProduct) return;
  
  reports.push({
    id: Date.now(),
    type: 'product',
    targetId: currentProduct.id,
    targetName: currentProduct.title || currentProduct.seller,
    reporterId: currentUser.id,
    reporterName: currentUser.name,
    reason: reason,
    details: details,
    status: 'pending',
    date: new Date().toLocaleString('sv-SE')
  });
  
  saveData();
  showToast('Anm√§lan skickad till admin');
  closeModal('reportModal');
  updateAdminBadges();
}

// Admin
function setAdminTab(tab, element) {
  document.querySelectorAll('.admin-nav-item').forEach(el => el.classList.remove('active'));
  element.classList.add('active');
  
  renderAdminContent(tab);
}

function renderAdminContent(tab) {
  const content = document.getElementById('adminContent');
  
  if (tab === 'overview') {
    const userCount = users.filter(u => !u.isAdmin).length;
    const activeAds = products.filter(p => p.status === 'active').length;
    const pendingAds = products.filter(p => p.status === 'pending').length;
    const soldToday = products.filter(p => p.status === 'sold' && p.soldAt && new Date(p.soldAt).toDateString() === new Date().toDateString()).length;
    
    content.innerHTML = `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
        <div class="panel" style="padding: 20px;">
          <div style="color: #64748b; font-size: 14px; font-weight: 600;">ANV√ÑNDARE</div>
          <div style="font-size: 32px; font-weight: 800; margin-top: 8px;">${userCount}</div>
        </div>
        <div class="panel" style="padding: 20px;">
          <div style="color: #64748b; font-size: 14px; font-weight: 600;">AKTIVA ANNONSER</div>
          <div style="font-size: 32px; font-weight: 800; margin-top: 8px;">${activeAds}</div>
        </div>
        <div class="panel" style="padding: 20px;">
          <div style="color: #64748b; font-size: 14px; font-weight: 600;">GRANSKNING</div>
          <div style="font-size: 32px; font-weight: 800; margin-top: 8px;">${pendingAds}</div>
        </div>
        <div class="panel" style="padding: 20px;">
          <div style="color: #64748b; font-size: 14px; font-weight: 600;">S√ÖLDA IDAG</div>
          <div style="font-size: 32px; font-weight: 800; margin-top: 8px;">${soldToday}</div>
        </div>
      </div>
      <div class="panel">
        <div style="padding: 16px; border-bottom: 1px solid var(--border); font-weight: 700;">Senaste aktivitet</div>
        <div style="padding: 16px; color: #64748b;">Systemet √§r aktivt</div>
      </div>
    `;
  } else if (tab === 'pending') {
    const pending = products.filter(p => p.status === 'pending');
    if (pending.length === 0) {
      content.innerHTML = '<div class="panel" style="padding: 40px; text-align: center; color: #64748b;">Inga annonser v√§ntar p√• granskning</div>';
      return;
    }
    content.innerHTML = pending.map(p => `
      <div class="panel" style="margin-bottom: 12px; overflow: hidden;">
        <div style="display: flex; gap: 16px; padding: 16px;">
          <img src="${p.images[0]}" style="width: 100px; height: 75px; object-fit: cover; border-radius: 8px;">
          <div style="flex: 1;">
            <div style="font-weight: 700;">${escapeHtml(p.title)}</div>
            <div style="color: #64748b; font-size: 14px;">${p.price} kr ‚Ä¢ ${p.seller}</div>
            <div style="margin-top: 8px; font-size: 14px;">${escapeHtml(p.description || '')}</div>
          </div>
        </div>
        <div style="display: flex; gap: 8px; padding: 0 16px 16px;">
          <button class="btn btn-success" onclick="approveProduct(${p.id})">‚úì Godk√§nn</button>
          <button class="btn btn-danger" onclick="rejectProduct(${p.id})">‚úï Avvisa</button>
        </div>
      </div>
    `).join('');
  } else if (tab === 'reports') {
    const pendingReports = reports.filter(r => r.status === 'pending');
    if (pendingReports.length === 0) {
      content.innerHTML = '<div class="panel" style="padding: 40px; text-align: center; color: #64748b;">Inga nya anm√§lningar</div>';
      return;
    }
    content.innerHTML = pendingReports.map(r => `
      <div class="panel" style="margin-bottom: 12px; padding: 16px; border-left: 4px solid #f59e0b;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div>
            <span style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 700;">${r.type}</span>
            <div style="font-weight: 700; margin-top: 8px;">${r.reason}</div>
            <div style="color: #64748b; font-size: 14px;">M√•l: ${escapeHtml(r.targetName)}</div>
            <div style="color: #64748b; font-size: 14px;">Av: ${escapeHtml(r.reporterName)}</div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-danger" onclick="banUser('${r.targetId}', '${escapeHtml(r.targetName)}')">Blockera</button>
            <button class="btn btn-soft" onclick="dismissReport(${r.id})">Avf√§rda</button>
          </div>
        </div>
      </div>
    `).join('');
  } else if (tab === 'users') {
    const regularUsers = users.filter(u => !u.isAdmin);
    content.innerHTML = regularUsers.map(u => `
      <div class="panel" style="margin-bottom: 8px; padding: 16px; display: flex; justify-content: space-between; align-items: center;">
        <div>
          <div style="font-weight: 700;">${escapeHtml(u.name)} ${u.banned ? '<span style="color: #ef4444;">[BLOCKERAD]</span>' : ''}</div>
          <div style="color: #64748b; font-size: 14px;">${u.email}</div>
        </div>
        ${u.banned ? 
          `<button class="btn btn-success" onclick="unbanUser('${u.id}')">Upph√§v blockering</button>` :
          `<button class="btn btn-danger" onclick="banUser('${u.id}', '${escapeHtml(u.name)}')">Blockera</button>`
        }
      </div>
    `).join('') || '<div style="text-align: center; color: #64748b;">Inga anv√§ndare</div>';
  }
}

function approveProduct(id) {
  const p = products.find(x => x.id === id);
  if (p) {
    p.status = 'active';
    saveData();
    showToast('Annons godk√§nd');
    renderAdminContent('pending');
    renderProducts();
    updateAdminBadges();
  }
}

function rejectProduct(id) {
  const reason = prompt('Ange anledning f√∂r avvisning:');
  if (!reason) return;
  const p = products.find(x => x.id === id);
  if (p) {
    p.status = 'rejected';
    p.rejectReason = reason;
    saveData();
    showToast('Annons avvisad');
    renderAdminContent('pending');
    updateAdminBadges();
  }
}

function banUser(userId, name) {
  const reason = prompt(`Blockera ${name}?\n\nAnledning:`);
  if (!reason) return;
  const u = users.find(x => x.id === userId);
  if (u) {
    u.banned = true;
    u.banReason = reason;
    saveData();
    showToast(`${name} √§r blockerad`);
    renderAdminContent('reports');
    renderAdminContent('users');
  }
}

function unbanUser(userId) {
  const u = users.find(x => x.id === userId);
  if (u) {
    delete u.banned;
    delete u.banReason;
    saveData();
    showToast('Blockering upph√§vd');
    renderAdminContent('users');
  }
}

function dismissReport(reportId) {
  const r = reports.find(x => x.id === reportId);
  if (r) {
    r.status = 'dismissed';
    saveData();
    showToast('Anm√§lan avf√§rdad');
    renderAdminContent('reports');
    updateAdminBadges();
  }
}

function updateAdminBadges() {
  const pending = products.filter(p => p.status === 'pending').length;
  const rep = reports.filter(r => r.status === 'pending').length;
  
  document.getElementById('badgePending').textContent = pending;
  document.getElementById('badgePending').classList.toggle('hidden', pending === 0);
  document.getElementById('badgeReports').textContent = rep;
  document.getElementById('badgeReports').classList.toggle('hidden', rep === 0);
}

// Utils
function showModal(id) {
  document.getElementById(id).classList.add('show');
  document.getElementById(id).style.display = 'flex';
}

function closeModal(id) {
  document.getElementById(id).classList.remove('show');
  setTimeout(() => {
    document.getElementById(id).style.display = 'none';
  }, 300);
}

function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

function escapeHtml(text) {
  if (!text) return '';
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}
</script>
</body>
</html>
