<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Miniblocket</title>
  <style>
    :root{
      --primary:#0ea5e9;
      --primary-dark:#0284c7;
      --primary-light:#e0f2fe;
      --secondary:#8b5cf6;
      --accent:#f59e0b;
      --danger:#ef4444;
      --success:#10b981;
      --bg:#f8fafc;
      --surface:#ffffff;
      --text:#0f172a;
      --text-secondary:#64748b;
      --border:#e2e8f0;
      --shadow-sm:0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl:0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --radius:16px;
      --radius-sm:12px;
    }
    
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    
    body{
      font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
      background:linear-gradient(135deg,#f0f9ff 0%,#f8fafc 50%,#fff1f2 100%);
      background-attachment:fixed;
      color:var(--text);
      line-height:1.6;
      min-height:100vh;
    }
    
    .container{max-width:1200px;margin:auto;padding:0 20px}
    .hidden{display:none!important}

    /* Navigation - Glassmorphism */
    nav{
      position:sticky;
      top:0;
      z-index:100;
      background:rgba(255,255,255,0.85);
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
      border-bottom:1px solid rgba(226,232,240,0.6);
      box-shadow:var(--shadow-sm);
    }
    
    .nav{
      display:flex;
      justify-content:space-between;
      align-items:center;
      height:72px;
      gap:12px;
    }
    
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      cursor:pointer;
      user-select:none;
      transition:transform 0.2s;
    }
    
    .brand:active{transform:scale(0.98)}
    
    .logo{
      width:44px;
      height:44px;
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);
      font-size:24px;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }
    
    .logo::after{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,transparent 0%,rgba(255,255,255,0.3) 100%);
    }
    
    .brand strong{
      font-size:20px;
      font-weight:800;
      background:linear-gradient(135deg,var(--text) 0%,var(--text-secondary) 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    
    .brand small{
      display:block;
      font-size:11px;
      color:var(--text-secondary);
      font-weight:600;
      letter-spacing:0.5px;
      text-transform:uppercase;
    }

    .nav-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    
    .btn{
      padding:10px 18px;
      border:none;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      transition:all 0.2s;
      position:relative;
      overflow:hidden;
    }
    
    .btn::after{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,transparent 0%,rgba(255,255,255,0.2) 100%);
      opacity:0;
      transition:opacity 0.2s;
    }
    
    .btn:hover::after{opacity:1}
    .btn:active{transform:translateY(1px)}
    
    .btn-primary{
      background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
      color:#fff;
      box-shadow:0 4px 14px 0 rgba(14,165,233,0.35);
    }
    
    .btn-primary:hover{
      box-shadow:0 6px 20px 0 rgba(14,165,233,0.45);
      transform:translateY(-1px);
    }
    
    .btn-soft{
      background:var(--surface);
      color:var(--text-secondary);
      border:1px solid var(--border);
    }
    
    .btn-soft:hover{
      background:var(--bg);
      color:var(--text);
      border-color:var(--primary);
    }
    
    .btn-danger{
      background:linear-gradient(135deg,#fee2e2 0%,#fecaca 100%);
      color:#991b1b;
      border:1px solid #fecaca;
    }
    
    .btn-danger:hover{
      background:linear-gradient(135deg,#fecaca 0%,#fca5a5 100%);
    }
    
    .btn-success{
      background:linear-gradient(135deg,var(--success) 0%,#059669 100%);
      color:#fff;
      box-shadow:0 4px 14px 0 rgba(16,185,129,0.35);
    }
    
    .btn-icon{
      width:42px;
      height:42px;
      border-radius:50%;
      border:none;
      background:var(--surface);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      color:var(--text-secondary);
      position:relative;
      box-shadow:var(--shadow-sm);
      transition:all 0.2s;
      border:1px solid var(--border);
    }
    
    .btn-icon:hover{
      transform:translateY(-2px);
      box-shadow:var(--shadow);
      color:var(--primary);
    }
    
    .badge{
      position:absolute;
      top:-4px;
      right:-4px;
      min-width:20px;
      height:20px;
      border-radius:10px;
      background:var(--danger);
      color:#fff;
      font-size:11px;
      font-weight:800;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0 6px;
      box-shadow:0 2px 4px rgba(239,68,68,0.3);
      border:2px solid #fff;
    }
    
    .avatar{
      width:42px;
      height:42px;
      border-radius:50%;
      background:linear-gradient(135deg,#fb923c,#ec4899);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      cursor:pointer;
      user-select:none;
      box-shadow:var(--shadow);
      border:2px solid rgba(255,255,255,0.8);
      transition:transform 0.2s;
    }
    
    .avatar:hover{transform:scale(1.05) rotate(5deg)}

    .page{padding:28px 0}
    
    /* Search Card - Glass effect */
    .search-card{
      background:rgba(255,255,255,0.9);
      backdrop-filter:blur(10px);
      border:1px solid rgba(226,232,240,0.6);
      border-radius:var(--radius);
      padding:24px;
      box-shadow:var(--shadow-lg);
      margin-bottom:24px;
    }
    
    .search-row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:stretch;
    }
    
    .search-input{
      flex:1;
      min-width:260px;
      position:relative;
    }
    
    .search-input::before{
      content:"üîç";
      position:absolute;
      left:16px;
      top:50%;
      transform:translateY(-50%);
      font-size:18px;
      opacity:0.5;
    }
    
    input,select,textarea{
      width:100%;
      padding:14px 16px;
      border:2px solid var(--border);
      border-radius:var(--radius-sm);
      outline:none;
      font-size:15px;
      background:var(--surface);
      transition:all 0.2s;
      font-family:inherit;
    }
    
    input:focus,select:focus,textarea:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 4px rgba(14,165,233,0.1);
    }
    
    .search-input input{padding-left:48px}

    .cats{
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding-top:16px;
      padding-bottom:4px;
      scrollbar-width:none;
      -ms-overflow-style:none;
    }
    
    .cats::-webkit-scrollbar{display:none}
    
    .cat{
      border:2px solid var(--border);
      background:var(--surface);
      border-radius:999px;
      padding:10px 20px;
      font-weight:600;
      color:var(--text-secondary);
      cursor:pointer;
      white-space:nowrap;
      transition:all 0.2s;
      box-shadow:var(--shadow-sm);
    }
    
    .cat:hover{
      border-color:var(--primary);
      color:var(--primary);
      transform:translateY(-1px);
    }
    
    .cat.active{
      background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(14,165,233,0.35);
    }

    /* Products Grid */
    .products{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:24px;
      margin-top:24px;
    }
    
    .card{
      background:var(--surface);
      border-radius:var(--radius);
      overflow:hidden;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      cursor:pointer;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position:relative;
    }
    
    .card:hover{
      transform:translateY(-4px);
      box-shadow:var(--shadow-xl);
      border-color:var(--primary-light);
    }
    
    .card.sold{
      opacity:0.7;
      pointer-events:none;
      filter:grayscale(0.6);
    }
    
    .card.sold::after{
      content:'S√ÖLD';
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%) rotate(-15deg);
      background:var(--danger);
      color:#fff;
      padding:12px 32px;
      font-size:24px;
      font-weight:900;
      border-radius:8px;
      box-shadow:var(--shadow-xl);
      z-index:10;
      letter-spacing:2px;
    }
    
    .img-wrap{
      position:relative;
      overflow:hidden;
    }
    
    .card img{
      width:100%;
      height:220px;
      object-fit:cover;
      display:block;
      background:var(--bg);
      transition:transform 0.3s;
    }
    
    .card:hover img{transform:scale(1.05)}
    
    .tag{
      position:absolute;
      top:12px;
      left:12px;
      background:rgba(255,255,255,0.95);
      padding:8px 14px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      color:var(--text);
      box-shadow:var(--shadow);
      backdrop-filter:blur(4px);
    }
    
    .fav{
      position:absolute;
      top:12px;
      right:12px;
      width:40px;
      height:40px;
      border-radius:50%;
      border:none;
      background:rgba(255,255,255,0.95);
      box-shadow:var(--shadow);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      transition:all 0.2s;
      z-index:5;
    }
    
    .fav:hover{
      transform:scale(1.1);
      background:#fff;
    }
    
    .fav.active{
      background:#fee2e2;
      color:var(--danger);
    }
    
    .body{padding:18px}
    
    .p-top{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      margin-bottom:8px;
    }
    
    .p-title{
      font-weight:700;
      font-size:15px;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      line-height:1.4;
      color:var(--text);
    }
    
    .p-price{
      font-weight:800;
      font-size:18px;
      color:var(--primary-dark);
      white-space:nowrap;
    }
    
    .p-meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:14px;
      padding-top:14px;
      border-top:1px solid var(--border);
      color:var(--text-secondary);
      font-size:13px;
      font-weight:500;
    }
    
    .seller{
      display:flex;
      align-items:center;
      gap:10px;
    }
    
    .seller-badge{
      width:32px;
      height:32px;
      border-radius:50%;
      background:linear-gradient(135deg,var(--success),var(--primary));
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:700;
      font-size:12px;
      box-shadow:var(--shadow-sm);
    }

    .empty{
      display:none;
      text-align:center;
      padding:60px 20px;
      color:var(--text-secondary);
    }
    
    .empty.show{display:block}
    
    .empty-icon{
      font-size:64px;
      opacity:0.3;
      margin-bottom:16px;
    }

    /* Modals */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.6);
      backdrop-filter:blur(4px);
      align-items:center;
      justify-content:center;
      z-index:1000;
      padding:20px;
      opacity:0;
      transition:opacity 0.3s;
    }
    
    .modal.show{
      display:flex;
      opacity:1;
    }
    
    .box{
      background:var(--surface);
      border-radius:var(--radius);
      width:100%;
      max-width:800px;
      max-height:92vh;
      overflow:auto;
      box-shadow:var(--shadow-xl);
      transform:scale(0.95);
      transition:transform 0.3s;
      border:1px solid var(--border);
    }
    
    .modal.show .box{transform:scale(1)}
    
    .head{
      padding:24px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      position:sticky;
      top:0;
      background:var(--surface);
      z-index:10;
    }
    
    .head h3{font-size:20px;font-weight:800}
    
    .x{
      width:40px;
      height:40px;
      border-radius:50%;
      border:none;
      background:var(--bg);
      cursor:pointer;
      font-weight:700;
      font-size:18px;
      color:var(--text-secondary);
      transition:all 0.2s;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    .x:hover{
      background:var(--danger);
      color:#fff;
      transform:rotate(90deg);
    }
    
    .pad{padding:24px}

    /* Product Detail */
    .pm-grid{
      display:grid;
      grid-template-columns:1.2fr 0.8fr;
      gap:24px;
    }
    
    .pm-img{
      border-radius:var(--radius);
      overflow:hidden;
      border:1px solid var(--border);
      background:var(--bg);
      position:relative;
    }
    
    .pm-img img{
      width:100%;
      height:400px;
      object-fit:cover;
      display:block;
    }
    
    .thumbs{
      display:flex;
      gap:12px;
      overflow-x:auto;
      padding-top:16px;
      scrollbar-width:thin;
    }
    
    .thumbs img{
      width:80px;
      height:64px;
      object-fit:cover;
      border-radius:12px;
      border:3px solid transparent;
      cursor:pointer;
      background:var(--bg);
      transition:all 0.2s;
    }
    
    .thumbs img.active{
      border-color:var(--primary);
      box-shadow:0 0 0 4px rgba(14,165,233,0.1);
    }
    
    .pm-title{
      font-weight:800;
      font-size:24px;
      line-height:1.3;
      color:var(--text);
    }
    
    .pm-price{
      font-weight:800;
      font-size:28px;
      color:var(--primary-dark);
      margin-top:8px;
    }
    
    .pm-meta{
      margin-top:12px;
      color:var(--text-secondary);
      font-weight:500;
      font-size:14px;
      display:flex;
      gap:16px;
      flex-wrap:wrap;
    }

    .seller-card{
      margin-top:20px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:20px;
      background:linear-gradient(135deg,var(--bg) 0%,var(--surface) 100%);
      display:flex;
      gap:16px;
      align-items:center;
      flex-wrap:wrap;
      box-shadow:var(--shadow-sm);
    }
    
    .seller-card .seller-badge{
      width:52px;
      height:52px;
      font-size:16px;
      flex-shrink:0;
    }
    
    .seller-card .seller-info-wrap{flex:1;min-width:200px}
    
    .seller-card .btn{
      margin-left:auto;
      position:static;
    }

    .action-buttons{
      display:flex;
      gap:12px;
      margin-top:20px;
      flex-wrap:wrap;
    }
    
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--surface);
      font-weight:600;
      font-size:13px;
      color:var(--text-secondary);
      box-shadow:var(--shadow-sm);
    }
    
    .chip.good{
      background:linear-gradient(135deg,#ecfdf5 0%,#d1fae5 100%);
      border-color:#a7f3d0;
      color:#065f46;
    }

    /* Profile Layout */
    .profile-layout{
      display:grid;
      grid-template-columns:360px 1fr;
      gap:24px;
      align-items:start;
    }
    
    .panel{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    
    .panel-pad{padding:24px}
    
    .profile-banner{
      height:100px;
      background:linear-gradient(135deg,rgba(14,165,233,0.2) 0%,rgba(139,92,246,0.2) 100%);
      position:relative;
      overflow:hidden;
    }
    
    .profile-banner::after{
      content:'';
      position:absolute;
      inset:0;
      background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    
    .profile-top{
      padding:0 24px 24px;
      display:flex;
      gap:16px;
      align-items:flex-end;
      margin-top:-40px;
      position:relative;
      z-index:2;
    }
    
    .profile-avatar{
      width:80px;
      height:80px;
      border-radius:20px;
      background:linear-gradient(135deg,#fb923c,#ec4899);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:800;
      font-size:24px;
      border:4px solid var(--surface);
      box-shadow:var(--shadow-lg);
      overflow:hidden;
      flex-shrink:0;
    }
    
    .stats{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
      padding:0 24px 24px;
    }
    
    .stat{
      border:1px solid var(--border);
      border-radius:var(--radius-sm);
      padding:16px;
      background:var(--bg);
      text-align:center;
      transition:all 0.2s;
    }
    
    .stat:hover{
      transform:translateY(-2px);
      box-shadow:var(--shadow);
      border-color:var(--primary-light);
    }
    
    .stat .n{
      font-weight:800;
      font-size:22px;
      color:var(--primary-dark);
    }
    
    .stat .l{
      font-size:12px;
      color:var(--text-secondary);
      font-weight:600;
      margin-top:4px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    .seg{
      display:flex;
      gap:8px;
      padding:6px;
      background:var(--bg);
      border:1px solid var(--border);
      border-radius:999px;
      margin-bottom:20px;
    }
    
    .seg button{
      flex:1;
      border:none;
      background:transparent;
      padding:12px 16px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      color:var(--text-secondary);
      transition:all 0.2s;
      font-size:14px;
    }
    
    .seg button:hover{color:var(--text)}
    
    .seg button.active{
      background:var(--surface);
      color:var(--primary);
      box-shadow:var(--shadow);
      border:1px solid var(--border);
    }

    .list{
      margin-top:16px;
      display:grid;
      gap:16px;
    }
    
    .item{
      display:flex;
      gap:16px;
      align-items:flex-start;
      flex-wrap:wrap;
      padding:16px;
      background:var(--bg);
      border-radius:var(--radius-sm);
      border:1px solid var(--border);
      transition:all 0.2s;
    }
    
    .item:hover{
      border-color:var(--primary-light);
      box-shadow:var(--shadow);
    }
    
    .thumb{
      width:140px;
      height:100px;
      border-radius:var(--radius-sm);
      border:1px solid var(--border);
      object-fit:cover;
      background:var(--bg);
      flex-shrink:0;
    }
    
    .item-main{flex:1;min-width:200px}
    
    .item-title{
      font-weight:700;
      font-size:16px;
      color:var(--text);
      margin-bottom:4px;
    }
    
    .item-sub{
      color:var(--text-secondary);
      font-weight:500;
      font-size:13px;
    }
    
    .item-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    
    .preview-grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
      margin-top:16px;
    }
    
    .preview-item{
      position:relative;
      border-radius:var(--radius-sm);
      overflow:hidden;
      background:var(--bg);
      aspect-ratio:1;
      border:2px solid var(--border);
    }
    
    .preview-item img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    
    .preview-item button{
      position:absolute;
      top:8px;
      right:8px;
      width:32px;
      height:32px;
      border-radius:50%;
      border:none;
      background:rgba(255,255,255,0.95);
      cursor:pointer;
      font-weight:700;
      color:var(--danger);
      box-shadow:var(--shadow);
      transition:all 0.2s;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    .preview-item button:hover{
      transform:scale(1.1);
      background:#fff;
    }

    /* Chat - Mobile First */
    .chat-overlay{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.5);
      backdrop-filter:blur(4px);
      z-index:180;
      opacity:0;
      transition:opacity 0.3s;
    }
    
    .chat-overlay.show{
      display:block;
      opacity:1;
    }
    
    .chat{
      display:none;
      position:fixed;
      top:0;
      right:0;
      height:100vh;
      width:100%;
      max-width:480px;
      background:var(--surface);
      z-index:200;
      box-shadow:-10px 0 40px rgba(0,0,0,0.2);
      transform:translateX(100%);
      transition:transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .chat.show{
      display:flex;
      transform:translateX(0);
    }
    
    .chat-shell{
      display:flex;
      height:100%;
      width:100%;
      flex-direction:column;
    }
    
    @media(min-width:769px){
      .chat-shell{flex-direction:row}
    }
    
    .chat-list{
      width:100%;
      background:var(--bg);
      border-bottom:1px solid var(--border);
      display:flex;
      flex-direction:column;
      height:40%;
    }
    
    @media(min-width:769px){
      .chat-list{
        width:280px;
        min-width:280px;
        border-right:1px solid var(--border);
        border-bottom:none;
        height:100%;
      }
    }
    
    .chat-top{
      padding:20px;
      border-bottom:1px solid var(--border);
      background:var(--surface);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    
    .chat-top b{
      font-size:18px;
      font-weight:800;
    }
    
    .conv{
      padding:16px;
      border-bottom:1px solid var(--border);
      cursor:pointer;
      display:flex;
      gap:12px;
      transition:all 0.2s;
    }
    
    .conv:hover{background:rgba(14,165,233,0.05)}
    
    .conv.active{
      background:var(--primary-light);
      border-left:4px solid var(--primary);
    }
    
    .conv .t{
      font-size:11px;
      color:var(--text-secondary);
      font-weight:600;
    }
    
    .conv .n{
      font-size:14px;
      font-weight:700;
      color:var(--text);
      margin-bottom:2px;
    }
    
    .conv .p{
      font-size:13px;
      color:var(--text-secondary);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:200px;
    }

    .chat-main{
      flex:1;
      display:flex;
      flex-direction:column;
      background:var(--bg);
      min-width:0;
      height:60%;
    }
    
    @media(min-width:769px){
      .chat-main{height:100%}
    }
    
    .chat-empty{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--text-secondary);
      font-weight:600;
      padding:24px;
      text-align:center;
    }
    
    .chat-header{
      padding:16px 20px;
      border-bottom:1px solid var(--border);
      background:var(--surface);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      box-shadow:var(--shadow-sm);
    }
    
    .msgs{
      flex:1;
      overflow-y:auto;
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:12px;
      background:linear-gradient(180deg,var(--bg) 0%,var(--surface) 100%);
    }
    
    .msg{
      max-width:80%;
      padding:14px 18px;
      border-radius:20px;
      font-size:15px;
      line-height:1.5;
      position:relative;
      animation:messageSlide 0.3s ease-out;
    }
    
    @keyframes messageSlide{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }
    
    .msg.sent{
      align-self:flex-end;
      background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
      color:#fff;
      border-bottom-right-radius:6px;
      box-shadow:0 4px 12px rgba(14,165,233,0.25);
    }
    
    .msg.recv{
      align-self:flex-start;
      background:var(--surface);
      border-bottom-left-radius:6px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
    }
    
    .msg .time{
      font-size:11px;
      opacity:0.8;
      margin-top:6px;
      font-weight:500;
    }
    
    .chat-input{
      padding:20px;
      border-top:1px solid var(--border);
      background:var(--surface);
      display:flex;
      gap:12px;
      align-items:center;
    }
    
    .chat-input input{
      border-radius:999px;
      padding:14px 20px;
      background:var(--bg);
    }
    
    .send{
      width:48px;
      height:48px;
      border-radius:50%;
      border:none;
      background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 4px 12px rgba(14,165,233,0.35);
      transition:all 0.2s;
      flex-shrink:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
    }
    
    .send:hover{
      transform:scale(1.05);
      box-shadow:0 6px 16px rgba(14,165,233,0.45);
    }
    
    .send:active{transform:scale(0.95)}

    /* Toast */
    .toast{
      position:fixed;
      bottom:24px;
      left:50%;
      transform:translateX(-50%) translateY(100px);
      background:var(--text);
      color:#fff;
      padding:16px 24px;
      border-radius:var(--radius-sm);
      box-shadow:var(--shadow-xl);
      z-index:2200;
      opacity:0;
      transition:all 0.3s;
      font-weight:600;
      max-width:min(480px, calc(100% - 40px));
      text-align:center;
    }
    
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }

    /* User Menu */
    #userMenu{
      position:fixed;
      top:84px;
      right:20px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow-xl);
      min-width:240px;
      overflow:hidden;
      z-index:120;
      animation:menuSlide 0.2s ease-out;
    }
    
    @keyframes menuSlide{
      from{opacity:0;transform:translateY(-10px)}
      to{opacity:1;transform:translateY(0)}
    }
    
    #userMenu > div:first-child{
      padding:16px 20px;
      border-bottom:1px solid var(--border);
      background:var(--bg);
    }
    
    #userMenu button{
      width:100%;
      border:none;
      background:var(--surface);
      padding:14px 20px;
      text-align:left;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:10px;
    }
    
    #userMenu button:hover{
      background:var(--bg);
      color:var(--primary);
      padding-left:24px;
    }

    /* Status badges */
    .status-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .status-sold{
      background:#fee2e2;
      color:#991b1b;
    }
    
    .status-active{
      background:#d1fae5;
      color:#065f46;
    }

    /* Mobile Optimizations */
    @media (max-width: 768px){
      .container{padding:0 16px}
      .page{padding:16px 0}
      
      .nav{height:64px}
      .brand strong{font-size:16px}
      .logo{width:40px;height:40px;font-size:20px}
      
      .products{
        grid-template-columns:repeat(2,1fr);
        gap:12px;
      }
      
      .card img{height:160px}
      .body{padding:12px}
      .p-title{font-size:14px}
      .p-price{font-size:16px}
      
      .search-card{padding:16px}
      .search-input{min-width:100%}
      
      .pm-grid{grid-template-columns:1fr}
      .pm-img img{height:280px}
      .thumbs img{width:64px;height:48px}
      
      .profile-layout{grid-template-columns:1fr}
      .profile-top{padding:0 16px 16px}
      .profile-avatar{width:64px;height:64px;font-size:20px}
      
      .thumb{width:100%;height:180px}
      
      .chat{max-width:100%}
      .chat-list{height:35%}
      .chat-main{height:65%}
      
      .modal{padding:12px}
      .box{max-height:95vh}
      .head{padding:16px 20px}
      .pad{padding:20px}
      
      .action-buttons{flex-direction:column}
      .action-buttons .btn{width:100%;justify-content:center}
      
      .preview-grid{grid-template-columns:repeat(2,1fr)}
      
      .grid2{grid-template-columns:1fr}
    }
    
    @media (max-width: 480px){
      .products{grid-template-columns:1fr}
      .nav-actions .btn-soft{display:none}
    }
    
    /* Touch improvements */
    @media (hover: none){
      .btn:hover{transform:none}
      .card:hover{transform:none}
      .card:hover img{transform:none}
    }
    
    /* Loading animation */
    .skeleton{
      background:linear-gradient(90deg,var(--bg) 25%,#e2e8f0 50%,var(--bg) 75%);
      background-size:200% 100%;
      animation:loading 1.5s infinite;
    }
    
    @keyframes loading{
      0%{background-position:200% 0}
      100%{background-position:-200% 0}
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-track{background:var(--bg)}
    ::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
    ::-webkit-scrollbar-thumb:hover{background:var(--text-secondary)}
  </style>
<base target="_blank">
</head>
<body>

<nav>
  <div class="container nav">
    <div class="brand" onclick="showHome()">
      <div class="logo">üë∂</div>
      <div>
        <strong>Miniblocket</strong>
        <small>Bara barnsaker</small>
      </div>
    </div>

    <div class="nav-actions">
      <button class="btn-icon" onclick="openChatPanel()" title="Meddelanden">üí¨<span class="badge" id="msgBadge">0</span></button>
      <button class="btn btn-primary" onclick="openSell()" id="sellBtn">+ S√§lj</button>
      <button class="btn btn-soft" onclick="openAuth('signup')" id="authBtn">Skapa konto</button>
      <div class="avatar hidden" id="avatar" onclick="toggleUserMenu(event)">??</div>
    </div>
  </div>
</nav>

<div class="container page" id="homePage">
  <div class="search-card">
    <div class="search-row">
      <div class="search-input"><input id="q" placeholder="S√∂k efter leksaker, barnvagnar..." onkeyup="applyFilters()" /></div>
      <select id="loc" onchange="applyFilters()">
        <option value="">üìç Alla platser</option>
        <option>Stockholm</option>
        <option>G√∂teborg</option>
        <option>Malm√∂</option>
        <option>Uppsala</option>
      </select>
      <select id="price" onchange="applyFilters()">
        <option value="">üí∞ Pris</option>
        <option value="0-100">0 - 100 kr</option>
        <option value="100-500">100 - 500 kr</option>
        <option value="500-1000">500 - 1000 kr</option>
        <option value="1000+">1000+ kr</option>
      </select>
    </div>
    <div class="cats">
      <button class="cat active" onclick="setCat('all', this)">Allt</button>
      <button class="cat" onclick="setCat('leksaker', this)">üß∏ Leksaker</button>
      <button class="cat" onclick="setCat('barnvagn', this)">üçº Barnvagnar</button>
      <button class="cat" onclick="setCat('bilbarnstol', this)">üöó Bilbarnstolar</button>
      <button class="cat" onclick="setCat('kl√§der', this)">üëï Kl√§der</button>
      <button class="cat" onclick="setCat('m√∂bler', this)">üõèÔ∏è Barnm√∂bler</button>
    </div>
  </div>

  <div id="products" class="products"></div>

  <div id="empty" class="empty">
    <div class="empty-icon">üîç</div>
    <div style="font-weight:800;font-size:18px;margin-bottom:8px">Inga annonser hittades</div>
    <div style="color:var(--text-secondary)">Prova att √§ndra dina filter eller s√∂kord</div>
  </div>
</div>

<div class="container page hidden" id="profilePage">
  <div class="profile-topbar" style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:20px;flex-wrap:wrap">
    <button class="btn btn-soft" onclick="showHome()">‚Üê Till alla annonser</button>
    <div style="font-weight:800;font-size:18px;color:var(--text)">Min profil</div>
  </div>
  <div class="profile-layout">
    <div class="panel" style="overflow:hidden">
      <div class="profile-banner"></div>
      <div class="profile-top">
        <div class="profile-avatar" id="profileAvatarWrap">
          <img id="profileAvatarImg" alt="" class="hidden" style="width:100%;height:100%;object-fit:cover" />
          <span id="profileAvatar">??</span>
        </div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:800;font-size:20px" id="profileName">Profil</div>
          <div style="font-size:13px;color:var(--text-secondary);font-weight:500;margin-top:4px" id="profileEmail">‚Äî</div>
          <div style="margin-top:12px;color:var(--text-secondary);font-weight:500;font-size:14px;line-height:1.6" id="profileBio">Ingen beskrivning √§nnu.</div>
        </div>
      </div>
      <div class="stats">
        <div class="stat"><div class="n" id="statAds">0</div><div class="l">annonser</div></div>
        <div class="stat"><div class="n" id="statConvos">0</div><div class="l">chattar</div></div>
        <div class="stat"><div class="n" id="statFav">0</div><div class="l">favoriter</div></div>
      </div>
      <div style="padding:0 24px 24px;display:flex;gap:12px;flex-wrap:wrap">
        <button class="btn btn-primary" style="flex:1" onclick="openSell()">+ Ny annons</button>
        <button class="btn btn-soft" style="flex:1" onclick="openEditProfile()">‚úèÔ∏è Redigera profil</button>
      </div>
    </div>

    <div class="panel panel-pad">
      <div class="seg">
        <button class="active" id="tabAds" onclick="setProfileTab('ads')">Mina annonser</button>
        <button id="tabConvos" onclick="setProfileTab('convos')">Konversationer</button>
        <button id="tabFav" onclick="setProfileTab('fav')">Favoriter</button>
      </div>
      <div class="list" id="profileContent"></div>
    </div>
  </div>
</div>

<div id="chatOverlay" class="chat-overlay" onclick="closeChatPanel()"></div>
<div id="chat" class="chat" aria-hidden="true">
  <div class="chat-shell">
    <div class="chat-list">
      <div class="chat-top"><b>üí¨ Meddelanden</b><button class="x" onclick="closeChatPanel()">‚úï</button></div>
      <div id="convList" style="flex:1;overflow:auto"></div>
    </div>

    <div id="chatMain" class="chat-main">
      <div id="chatEmpty" class="chat-empty">
        <div>
          <div style="font-size:48px;margin-bottom:16px">üí¨</div>
          <div style="font-weight:700;font-size:16px">V√§lj en konversation</div>
          <div style="font-size:14px;margin-top:8px;opacity:0.8">Klicka p√• en chatt i listan f√∂r att b√∂rja skriva</div>
        </div>
      </div>

      <div id="chatActive" class="hidden" style="height:100%;display:flex;flex-direction:column">
        <div class="chat-header">
          <div style="display:flex;gap:12px;align-items:center;min-width:0">
            <div class="seller-badge" id="chatAva">??</div>
            <div style="min-width:0">
              <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:16px" id="chatWith">‚Äî</div>
              <div style="font-size:12px;color:var(--success);font-weight:600;display:flex;align-items:center;gap:4px">
                <span style="width:8px;height:8px;background:var(--success);border-radius:50%;display:inline-block"></span>
                Aktiv nu
              </div>
            </div>
          </div>
          <button class="x" onclick="backToConversations()" title="Tillbaka till listan">‚Üê</button>
        </div>

        <div class="msgs" id="msgs"></div>

        <div class="chat-input">
          <input id="msgIn" placeholder="Skriv ett meddelande..." onkeypress="onEnter(event)" />
          <button class="send" onclick="sendMsg()">‚û§</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="productModal" class="modal" onclick="closeOnBackdrop(event)">
  <div class="box" onclick="event.stopPropagation()">
    <div class="head"><h3>Annons</h3><button class="x" onclick="hide('productModal')">‚úï</button></div>
    <div class="pad">
      <div class="pm-grid">
        <div>
          <div class="pm-img"><img id="pmImg" alt="" /></div>
          <div class="thumbs" id="pmThumbs"></div>
        </div>
        <div>
          <div class="pm-title" id="pmTitle">‚Äî</div>
          <div class="pm-price" id="pmPrice">‚Äî</div>
          <div class="pm-meta" id="pmMeta">‚Äî</div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:16px">
            <span class="chip good">‚úÖ S√§ker aff√§r</span>
            <span id="pmStatus" class="status-badge status-active" style="display:none">AKTIV</span>
          </div>

          <div class="seller-card">
            <div class="seller-badge" id="pmSellerAva">??</div>
            <div class="seller-info-wrap">
              <div style="font-weight:700;font-size:16px" id="pmSeller">‚Äî</div>
              <div style="font-size:13px;color:var(--text-secondary);font-weight:500" id="pmSellerLine">S√§ljare</div>
            </div>
            <button class="btn btn-primary" id="pmMessageBtn" onclick="messageSeller()">üí¨ Kontakta</button>
          </div>

          <div style="margin-top:20px;color:var(--text)">
            <div style="font-weight:700;margin-bottom:10px;font-size:16px">Beskrivning</div>
            <div id="pmDesc" style="line-height:1.7;color:var(--text-secondary)">‚Äî</div>
          </div>

          <div class="action-buttons" id="pmActions">
            <button class="btn btn-soft" id="pmFavBtn" onclick="toggleFavoriteFromModal()">ü§ç Favorit</button>
            <button class="btn btn-soft" onclick="openSellerProfileFromModal()">üë§ Se profil</button>
          </div>
          
          <div id="pmOwnerActions" class="action-buttons hidden" style="border-top:2px solid var(--border);padding-top:20px;margin-top:20px">
            <div style="width:100%;font-weight:700;margin-bottom:8px;color:var(--text-secondary);font-size:14px">‚öôÔ∏è Hantera din annons:</div>
            <button class="btn btn-soft" onclick="editCurrentProduct()">‚úèÔ∏è Redigera</button>
            <button class="btn btn-success" id="pmSoldBtn" onclick="markAsSold()">‚úì Markera som s√•ld</button>
            <button class="btn btn-danger" onclick="deleteCurrentProduct()">üóëÔ∏è Ta bort</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="editProfileModal" class="modal" onclick="closeOnBackdrop(event)">
  <div class="box" onclick="event.stopPropagation()" style="max-width:620px">
    <div class="head"><div><h3>Redigera profil</h3><div style="font-size:13px;color:var(--text-secondary);font-weight:500;margin-top:4px">Sparas lokalt i din webbl√§sare</div></div><button class="x" onclick="hide('editProfileModal')">‚úï</button></div>
    <div class="pad">
      <div style="display:grid;grid-template-columns:160px 1fr;gap:24px;align-items:start">
        <div>
          <div style="font-weight:700;margin-bottom:12px;color:var(--text)">Profilbild</div>
          <div style="width:160px;height:160px;border-radius:20px;border:3px solid var(--border);background:var(--bg);overflow:hidden;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow) inset">
            <img id="epPreview" class="hidden" alt="" style="width:100%;height:100%;object-fit:cover" />
            <div id="epInitials" style="font-weight:800;font-size:32px;color:var(--text-secondary)"></div>
          </div>
          <input id="epImg" type="file" accept="image/*" style="margin-top:16px;font-size:13px" />
          <button class="btn btn-soft" style="margin-top:12px;width:100%" onclick="removeProfileImage()">Ta bort bild</button>
        </div>
        <div>
          <div style="font-weight:700;margin-bottom:10px;color:var(--text)">Om mig</div>
          <textarea id="epBio" rows="8" placeholder="Ber√§tta kort om dig sj√§lv..." style="resize:vertical;min-height:120px"></textarea>
          <div style="display:flex;gap:12px;margin-top:20px;flex-wrap:wrap">
            <button class="btn btn-soft" style="flex:1" onclick="hide('editProfileModal')">Avbryt</button>
            <button class="btn btn-primary" style="flex:1" onclick="saveProfileEdits()">Spara √§ndringar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="authModal" class="modal" onclick="closeOnBackdrop(event)">
  <div class="box" onclick="event.stopPropagation()" style="max-width:480px">
    <div class="head"><div><h3 id="authTitle">Skapa konto</h3><div style="font-size:13px;color:var(--text-secondary);font-weight:500;margin-top:4px" id="authSub">B√∂rja k√∂pa och s√§lja barnsaker</div></div><button class="x" onclick="hide('authModal')">‚úï</button></div>
    <div class="pad">
      <div id="nameRow" style="margin-bottom:16px">
        <div style="font-weight:600;margin-bottom:8px;color:var(--text)">Namn</div>
        <input id="aName" placeholder="t.ex. Anna Andersson" />
      </div>
      <div style="margin-bottom:16px">
        <div style="font-weight:600;margin-bottom:8px;color:var(--text)">E-post</div>
        <input id="aEmail" type="email" placeholder="namn@mail.se" />
      </div>
      <div style="margin-bottom:20px">
        <div style="font-weight:600;margin-bottom:8px;color:var(--text)">L√∂senord</div>
        <input id="aPass" type="password" placeholder="Minst 6 tecken" />
      </div>
      <div style="display:flex;gap:12px;margin-top:10px;flex-wrap:wrap">
        <button class="btn btn-soft" style="flex:1" onclick="toggleAuthMode()" id="authSwitch">Jag har redan konto</button>
        <button class="btn btn-primary" style="flex:1" onclick="submitAuth()" id="authDo">Skapa konto</button>
      </div>
    </div>
  </div>
</div>

<div id="sellModal" class="modal" onclick="closeOnBackdrop(event)">
  <div class="box" onclick="event.stopPropagation()" style="max-width:680px">
    <div class="head"><div><h3 id="sellModalTitle">Ny annons</h3><div style="font-size:13px;color:var(--text-secondary);font-weight:500;margin-top:4px" id="sellAs">S√§ljer som: ‚Äî</div></div><button class="x" onclick="hide('sellModal')">‚úï</button></div>
    <div class="pad">
      <input type="hidden" id="sId" value="" />
      <div style="font-weight:600;margin-bottom:8px;color:var(--text)">Titel</div>
      <input id="sTitle" placeholder="t.ex. Bugaboo Cameleon 3 i fint skick" />
      <div class="grid2" style="margin-top:16px">
        <div>
          <div style="font-weight:600;margin-bottom:8px;color:var(--text)">Pris (kr)</div>
          <input id="sPrice" type="number" placeholder="0" min="0" />
        </div>
        <div>
          <div style="font-weight:600;margin-bottom:8px;color:var(--text)">Kategori</div>
          <select id="sCat">
            <option value="leksaker">Leksaker</option>
            <option value="barnvagn">Barnvagn</option>
            <option value="bilbarnstol">Bilbarnstol</option>
            <option value="kl√§der">Kl√§der</option>
            <option value="m√∂bler">M√∂bler</option>
          </select>
        </div>
      </div>
      <div style="margin-top:16px">
        <div style="font-weight:600;margin-bottom:8px;color:var(--text)">Plats</div>
        <select id="sLoc">
          <option>Stockholm</option>
          <option>G√∂teborg</option>
          <option>Malm√∂</option>
          <option>Uppsala</option>
        </select>
      </div>
      <div style="margin-top:16px">
        <div style="font-weight:600;margin-bottom:8px;color:var(--text)">Beskrivning</div>
        <textarea id="sDesc" placeholder="Beskriv varan, skick, √•lder, eventuella skavanker..." rows="5" style="resize:vertical"></textarea>
      </div>
      <div style="margin-top:16px">
        <div style="font-weight:600;margin-bottom:8px;color:var(--text)">Bilder</div>
        <input id="sImgs" type="file" accept="image/*" multiple />
        <div style="font-size:13px;color:var(--text-secondary);margin-top:8px">V√§lj upp till 6 bilder (demo-l√§ge: sparas lokalt)</div>
        <div class="preview-grid" id="sPreview"></div>
      </div>
      <div style="display:flex;gap:12px;margin-top:24px;flex-wrap:wrap">
        <button class="btn btn-soft" style="flex:1" onclick="hide('sellModal')">Avbryt</button>
        <button class="btn btn-primary" style="flex:1" onclick="publish()" id="publishBtn">Publicera annons</button>
      </div>
    </div>
  </div>
</div>

<div id="deleteModal" class="modal" onclick="closeOnBackdrop(event)">
  <div class="box" onclick="event.stopPropagation()" style="max-width:420px">
    <div class="head" style="background:linear-gradient(135deg,#fee2e2 0%,#fff 100%)"><h3 style="color:#991b1b">üóëÔ∏è Ta bort annons</h3><button class="x" onclick="hide('deleteModal')">‚úï</button></div>
    <div class="pad">
      <p style="margin-bottom:16px;color:var(--text-secondary);line-height:1.6">√Ñr du s√§ker p√• att du vill ta bort denna annons? √Ötg√§rden kan inte √•ngras.</p>
      
      <div style="margin-bottom:20px">
        <div style="font-weight:600;margin-bottom:8px;color:var(--text)">Varf√∂r tas annonsen bort?</div>
        <select id="deleteReason" style="width:100%">
          <option value="sold">Varan √§r s√•ld</option>
          <option value="changed">√Öngrar f√∂rs√§ljning</option>
          <option value="error">Felaktig information</option>
          <option value="other">Annan anledning</option>
        </select>
      </div>
      
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <button class="btn btn-soft" style="flex:1" onclick="hide('deleteModal')">Avbryt</button>
        <button class="btn btn-danger" style="flex:1" onclick="confirmDelete()">Ta bort permanent</button>
      </div>
    </div>
  </div>
</div>

<div id="sellerModal" class="modal" onclick="closeOnBackdrop(event)">
  <div class="box" onclick="event.stopPropagation()" style="max-width:760px">
    <div class="head"><h3 id="sellerTitle">Profil</h3><button class="x" onclick="hide('sellerModal')">‚úï</button></div>
    <div class="pad">
      <div class="panel panel-pad" style="margin-bottom:20px;background:linear-gradient(135deg,var(--bg) 0%,var(--surface) 100%)">
        <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
          <div class="seller-badge" style="width:56px;height:56px;font-size:16px" id="sellerAva">??</div>
          <div style="min-width:0;flex:1">
            <div style="font-weight:800;font-size:20px" id="sellerName">‚Äî</div>
            <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:6px">
              <div id="sellerStars" class="stars" aria-label="Betyg">‚Äî</div>
              <div style="font-size:13px;color:var(--text-secondary);font-weight:500" id="sellerCounts">‚Äî</div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel panel-pad" style="margin-bottom:20px">
        <div style="font-weight:700;margin-bottom:16px;font-size:16px">Omd√∂men</div>
        <div id="sellerReviews" class="list"></div>
        <div id="sellerReviewForm" class="review-form" style="margin-top:16px;padding:16px;background:var(--bg);border-radius:var(--radius-sm);border:1px solid var(--border)"></div>
      </div>

      <div style="font-weight:700;margin-bottom:16px;font-size:16px">Annonser fr√•n s√§ljaren</div>
      <div class="list" id="sellerAds"></div>
    </div>
  </div>
</div>

<div id="userMenu" class="hidden">
  <div>
    <div style="font-weight:700;color:var(--text)" id="uName">‚Äî</div>
    <div style="font-size:12px;color:var(--text-secondary);margin-top:2px" id="uEmail">‚Äî</div>
  </div>
  <button onclick="showProfile()">üë§ Min profil</button>
  <button onclick="logout()">üö™ Logga ut</button>
</div>

<div id="toast" class="toast"></div>

<script>
  const LS_USERS='mb_users_v2';
  const LS_SESSION='mb_session_v2';
  const LS_PRODUCTS='mb_products_v4';
  const LS_FAV_PREFIX='mb_fav_';
  const LS_CONV_PREFIX='mb_conv_';
  const LS_PROFILE_PREFIX='mb_profile_';
  const LS_REV_PREFIX='mb_reviews_';

  function favKey(uid){return LS_FAV_PREFIX+uid+'_v1'}
  function convKey(uid){return LS_CONV_PREFIX+uid+'_v1'}
  function profileKey(uid){return LS_PROFILE_PREFIX+uid+'_v1'}
  function reviewsKey(sellerName){return LS_REV_PREFIX+String(sellerName||'').toLowerCase()+'_v1'}

  let authMode='signup';
  let session=loadJSON(LS_SESSION,null);
  let products=loadJSON(LS_PRODUCTS,null);
  let deleteTargetId=null;

  if(!Array.isArray(products)||products.length===0){
    products=seedProducts();
    saveJSON(LS_PRODUCTS,products);
  }

  let activeCat='all';
  let currentProduct=null;
  let pmIdx=0;
  let sellImgs=[];
  let conversations=[];
  let currentChat=null;
  let isEditing=false;

  init();

  function init(){
    applyAuthUI();
    loadUserData();
    applyFilters();
    updateBadge();
    wireSellUpload();
    
    // Touch gestures for mobile chat
    let touchStartX=0;
    const chatEl=document.getElementById('chat');
    chatEl.addEventListener('touchstart',e=>{touchStartX=e.changedTouches[0].screenX;});
    chatEl.addEventListener('touchend',e=>{
      const touchEndX=e.changedTouches[0].screenX;
      if(touchStartX-touchEndX>100 && window.innerWidth<=768){
        // Swipe left to close on mobile
        closeChatPanel();
      }
    });

    window.addEventListener('resize',ensureChatLayout);
    document.addEventListener('click',()=>closeUserMenu());
    document.addEventListener('keydown',(e)=>{
      if(e.key==='Escape'){
        closeAllModals();
        if(isChatOpen())closeChatPanel();
        closeUserMenu();
      }
    });
  }

  /* AUTH */
  function openAuth(mode){
    authMode=mode||'signup';
    syncAuthUI();
    show('authModal');
  }
  
  function toggleAuthMode(){
    authMode=(authMode==='signup')?'login':'signup';
    syncAuthUI();
  }
  
  function syncAuthUI(){
    const title=document.getElementById('authTitle');
    const sub=document.getElementById('authSub');
    const sw=document.getElementById('authSwitch');
    const doBtn=document.getElementById('authDo');
    const nameRow=document.getElementById('nameRow');

    if(authMode==='signup'){
      title.textContent='Skapa konto';
      sub.textContent='B√∂rja k√∂pa och s√§lja barnsaker';
      sw.textContent='Jag har redan konto';
      doBtn.textContent='Skapa konto';
      nameRow.style.display='block';
    }else{
      title.textContent='Logga in';
      sub.textContent='V√§lkommen tillbaka!';
      sw.textContent='Skapa nytt konto';
      doBtn.textContent='Logga in';
      nameRow.style.display='none';
    }
  }

  function submitAuth(){
    const name=document.getElementById('aName').value.trim();
    const email=document.getElementById('aEmail').value.trim().toLowerCase();
    const pass=document.getElementById('aPass').value;

    if(!email||!pass) return toast('Fyll i e-post och l√∂senord.');
    if(pass.length<6) return toast('L√∂senordet m√•ste vara minst 6 tecken.');

    const users=loadJSON(LS_USERS,[]);

    if(authMode==='signup'){
      if(!name) return toast('Fyll i ditt namn.');
      if(users.some(u=>u.email===email)){
        authMode='login';
        syncAuthUI();
        return toast('E-posten finns redan. V√§xlat till inloggning.');
      }
      const u={id:uid(),name,email,pass};
      users.push(u);
      saveJSON(LS_USERS,users);
      session={userId:u.id};
      saveJSON(LS_SESSION,session);
      saveJSON(profileKey(u.id),{bio:'',image:''});
      applyAuthUI();
      hide('authModal');
      loadUserData();
      toast('V√§lkommen! Ditt konto √§r skapat.');
    }else{
      const u=users.find(x=>x.email===email);
      if(!u||u.pass!==pass) return toast('Fel e-post eller l√∂senord.');
      session={userId:u.id};
      saveJSON(LS_SESSION,session);
      applyAuthUI();
      hide('authModal');
      loadUserData();
      toast('Inloggning lyckades!');
    }
  }

  function logout(){
    session=null;
    localStorage.removeItem(LS_SESSION);
    applyAuthUI();
    closeUserMenu();
    showHome();
    closeChatPanel();
    toast('Du √§r utloggad.');
  }

  function getUser(){
    if(!session) return null;
    const users=loadJSON(LS_USERS,[]);
    return users.find(u=>u.id===session.userId)||null;
  }

  function applyAuthUI(){
    const u=getUser();
    const authBtn=document.getElementById('authBtn');
    const avatar=document.getElementById('avatar');
    const sellBtn=document.getElementById('sellBtn');

    if(u){
      authBtn.classList.add('hidden');
      avatar.classList.remove('hidden');
      avatar.textContent=initials(u.name);
      document.getElementById('uName').textContent=u.name;
      document.getElementById('uEmail').textContent=u.email;
      document.getElementById('sellAs').textContent='S√§ljer som: '+u.name;
      sellBtn.classList.remove('hidden');
      applyProfileExtras();
    }else{
      authBtn.classList.remove('hidden');
      avatar.classList.add('hidden');
      sellBtn.classList.add('hidden');
      document.getElementById('sellAs').textContent='S√§ljer som: ‚Äî';
    }
    syncAuthUI();
  }

  function toggleUserMenu(e){
    e.stopPropagation();
    document.getElementById('userMenu').classList.toggle('hidden');
  }
  
  function closeUserMenu(){
    document.getElementById('userMenu').classList.add('hidden');
  }

  /* NAV */
  function showHome(){
    document.getElementById('homePage').classList.remove('hidden');
    document.getElementById('profilePage').classList.add('hidden');
    applyFilters();
  }

  function showProfile(){
    const u=getUser();
    if(!u){toast('Logga in f√∂r att se din profil.');openAuth('login');return;}
    document.getElementById('homePage').classList.add('hidden');
    document.getElementById('profilePage').classList.remove('hidden');
    document.getElementById('profileName').textContent=u.name;
    document.getElementById('profileEmail').textContent=u.email;
    applyProfileExtras();
    refreshProfileStats();
    setProfileTab('ads');
    closeUserMenu();
  }

  function refreshProfileStats(){
    const u=getUser();
    if(!u) return;
    const mine=products.filter(p=>p.userId===u.id);
    const favIds=loadFavorites();
    document.getElementById('statAds').textContent=String(mine.length);
    document.getElementById('statConvos').textContent=String(conversations.length);
    document.getElementById('statFav').textContent=String(favIds.length);
  }

  function setProfileTab(tab){
    ['ads','convos','fav'].forEach(t=>document.getElementById('tab'+cap(t)).classList.toggle('active',t===tab));
    const box=document.getElementById('profileContent');
    box.innerHTML='';

    const u=getUser();
    if(!u) return;

    if(tab==='ads'){
      const mine=products.filter(p=>p.userId===u.id);
      if(!mine.length){
        box.innerHTML=`<div class="panel panel-pad" style="text-align:center;padding:40px"><div style="font-size:48px;margin-bottom:16px">üì¶</div><div style="font-weight:700;margin-bottom:8px">Du har inga annonser √§n</div><div style="color:var(--text-secondary);margin-bottom:20px">B√∂rja s√§lja genom att skapa din f√∂rsta annons</div><button class="btn btn-primary" onclick="openSell()">+ Skapa annons</button></div>`;
        return;
      }
      box.innerHTML=mine.map(p=>profileItem(p,'ad')).join('');
      return;
    }

    if(tab==='convos'){
      if(!conversations.length){
        box.innerHTML=`<div class="panel panel-pad" style="text-align:center;padding:40px"><div style="font-size:48px;margin-bottom:16px">üí¨</div><div style="font-weight:700">Inga konversationer √§n</div><div style="color:var(--text-secondary);margin-top:8px">Dina meddelanden visas h√§r</div></div>`;
        return;
      }
      box.innerHTML=conversations.map(c=>`
        <div class="panel" style="cursor:pointer" onclick="openChatPanel();openChat(${c.id});">
          <div class="item" style="border:none;background:transparent">
            <div class="seller-badge" style="width:48px;height:48px;font-size:16px">${escapeHtml(c.avatar)}</div>
            <div class="item-main">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
                <div class="item-title">${escapeHtml(c.with)}</div>
                <div style="font-size:12px;color:var(--text-secondary);font-weight:600">${escapeHtml(c.time)}</div>
              </div>
              <div class="item-sub">${escapeHtml(c.product)}</div>
              <div style="margin-top:8px;color:var(--text);font-size:14px;font-weight:500">${escapeHtml(c.lastMessage)}</div>
            </div>
          </div>
        </div>
      `).join('');
      return;
    }

    if(tab==='fav'){
      const favIds=loadFavorites();
      const favs=products.filter(p=>favIds.includes(p.id));
      if(!favs.length){
        box.innerHTML=`<div class="panel panel-pad" style="text-align:center;padding:40px"><div style="font-size:48px;margin-bottom:16px">ü§ç</div><div style="font-weight:700">Inga favoriter √§n</div><div style="color:var(--text-secondary);margin-top:8px">Spara annonser du gillar genom att klicka p√• hj√§rtat</div></div>`;
        return;
      }
      box.innerHTML=favs.map(p=>profileItem(p,'fav')).join('');
      return;
    }
  }

  function profileItem(p,mode){
    const isFav=isFavorited(p.id);
    const isSold=p.status==='sold';
    const statusBadge=isSold?`<span class="status-badge status-sold">S√ÖLD</span>`:`<span class="status-badge status-active">AKTIV</span>`;
    
    let actions=`<button class="btn btn-soft" onclick="event.stopPropagation();openProduct(${p.id})">Visa</button>`;
    
    if(mode==='ad'){
      if(!isSold){
        actions+=`<button class="btn btn-soft" onclick="event.stopPropagation();openEdit(${p.id})">‚úèÔ∏è Redigera</button>`;
        actions+=`<button class="btn btn-success" onclick="event.stopPropagation();quickMarkSold(${p.id})">‚úì S√•ld</button>`;
      }
      actions+=`<button class="btn btn-danger" onclick="event.stopPropagation();promptDelete(${p.id})">üóëÔ∏è Ta bort</button>`;
    }else{
      actions+=`<button class="btn btn-danger" onclick="event.stopPropagation();unfavorite(${p.id});setProfileTab('fav');">Ta bort favorit</button>`;
    }

    return `
      <div class="panel ${isSold?'sold':''}" style="${isSold?'opacity:0.7;':''}">
        <div class="item" onclick="${isSold?'':'openProduct('+p.id+')'}" style="cursor:${isSold?'default':'pointer'};border:none;background:transparent">
          <img class="thumb" src="${p.images[0]}" alt="" style="${isSold?'filter:grayscale(1)':''}" />
          <div class="item-main">
            <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
              <div class="item-title" style="${isSold?'text-decoration:line-through;opacity:0.6':''}">${escapeHtml(p.title)}</div>
              ${statusBadge}
            </div>
            <div class="item-sub" style="font-size:14px;margin-bottom:4px">
              <strong style="color:var(--primary-dark);font-size:16px">${p.price} kr</strong> ‚Ä¢ ${escapeHtml(p.location)} ‚Ä¢ ${escapeHtml(p.date)}
            </div>
            <div class="item-sub" style="margin-top:8px">${escapeHtml((p.description||'').slice(0,120))}${(p.description||'').length>120?'‚Ä¶':''}</div>
            <div class="item-actions" onclick="event.stopPropagation()">${actions}</div>
          </div>
        </div>
      </div>
    `;
  }

  /* PROFILE EDIT */
  function openEditProfile(){
    const u=getUser();
    if(!u){toast('Logga in f√∂r att redigera din profil.');openAuth('login');return;}
    const data=loadJSON(profileKey(u.id),{bio:'',image:''});
    document.getElementById('epBio').value=data.bio||'';

    const epPreview=document.getElementById('epPreview');
    const epInitials=document.getElementById('epInitials');
    if(data.image){
      epPreview.src=data.image;
      epPreview.classList.remove('hidden');
      epInitials.textContent='';
    }else{
      epPreview.classList.add('hidden');
      epInitials.textContent=initials(u.name);
    }

    document.getElementById('epImg').value='';
    show('editProfileModal');
  }

  function applyProfileExtras(){
    const u=getUser();
    if(!u) return;
    const data=loadJSON(profileKey(u.id),{bio:'',image:''});
    document.getElementById('profileBio').textContent=(data.bio||'').trim()||'Ingen beskrivning √§nnu.';

    const img=document.getElementById('profileAvatarImg');
    const ini=document.getElementById('profileAvatar');
    if(data.image){
      img.src=data.image;
      img.classList.remove('hidden');
      ini.classList.add('hidden');
    }else{
      img.classList.add('hidden');
      ini.classList.remove('hidden');
      ini.textContent=initials(u.name);
    }
  }

  function saveProfileEdits(){
    const u=getUser();
    if(!u) return;
    const bio=document.getElementById('epBio').value||'';
    const existing=loadJSON(profileKey(u.id),{bio:'',image:''});
    
    const file=(document.getElementById('epImg').files||[])[0];
    if(!file){
      saveJSON(profileKey(u.id),{...existing,bio});
      applyProfileExtras();
      hide('editProfileModal');
      toast('Profil uppdaterad!');
      return;
    }

    fileToDataUrl(file).then(url=>{
      saveJSON(profileKey(u.id),{bio,image:url});
      applyProfileExtras();
      hide('editProfileModal');
      toast('Profil uppdaterad!');
    }).catch(()=>toast('Kunde inte l√§sa bilden.'));
  }

  function removeProfileImage(){
    const u=getUser();
    if(!u) return;
    const existing=loadJSON(profileKey(u.id),{bio:'',image:''});
    existing.image='';
    saveJSON(profileKey(u.id),existing);
    document.getElementById('epPreview').classList.add('hidden');
    document.getElementById('epInitials').textContent=initials(u.name);
    document.getElementById('epImg').value='';
    applyProfileExtras();
    toast('Profilbild borttagen.');
  }

  /* FILTERS */
  function setCat(cat,el){
    activeCat=cat;
    document.querySelectorAll('.cat').forEach(b=>b.classList.remove('active'));
    el.classList.add('active');
    applyFilters();
  }

  function applyFilters(){
    const q=document.getElementById('q').value.trim().toLowerCase();
    const loc=document.getElementById('loc').value;
    const price=document.getElementById('price').value;

    let list=products.filter(p=>p.status!=='deleted');
    if(activeCat!=='all') list=list.filter(p=>p.category===activeCat);
    if(q) list=list.filter(p=>p.title.toLowerCase().includes(q)||p.category.toLowerCase().includes(q));
    if(loc) list=list.filter(p=>p.location===loc);

    if(price){
      list=list.filter(p=>{
        if(price==='0-100') return p.price<=100;
        if(price==='100-500') return p.price>100&&p.price<=500;
        if(price==='500-1000') return p.price>500&&p.price<=1000;
        if(price==='1000+') return p.price>1000;
        return true;
      });
    }

    renderProducts(list);
  }

  /* PRODUCTS */
  function renderProducts(list){
    const grid=document.getElementById('products');
    const empty=document.getElementById('empty');

    if(!list.length){grid.innerHTML='';empty.classList.add('show');return;}
    empty.classList.remove('show');

    grid.innerHTML=list.map(p=>{
      const f=isFavorited(p.id);
      const isSold=p.status==='sold';
      return `
        <div class="card ${isSold?'sold':''}" ${isSold?'':'onclick="openProduct('+p.id+')"'}>
          <div class="img-wrap">
            <img src="${p.images[0]}" alt="${escapeHtml(p.title)}" loading="lazy" style="${isSold?'filter:grayscale(1)':''}" />
            ${isSold?'<div style="position:absolute;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:24px;letter-spacing:2px">S√ÖLD</div>':''}
            <div class="tag">üìç ${escapeHtml(p.location)}</div>
            <button class="fav ${f?'active':''}" aria-label="Favorit" onclick="event.stopPropagation();toggleFavorite(${p.id},this)">${f?'‚ù§Ô∏è':'ü§ç'}</button>
          </div>
          <div class="body">
            <div class="p-top">
              <div class="p-title" style="${isSold?'text-decoration:line-through;opacity:0.6':''}">${escapeHtml(p.title)}</div>
              <div class="p-price" style="${isSold?'opacity:0.6':''}">${p.price} kr</div>
            </div>
            <div class="p-meta">
              <div class="seller">
                <div class="seller-badge">${escapeHtml(p.sellerAvatar)}</div>
                <span>${escapeHtml(p.seller)}</span>
              </div>
              <span>${escapeHtml(p.date)}</span>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function openProduct(id){
    currentProduct=products.find(p=>p.id===id);
    if(!currentProduct) return;

    pmIdx=0;
    document.getElementById('pmTitle').textContent=currentProduct.title;
    document.getElementById('pmPrice').textContent=currentProduct.price+' kr';
    document.getElementById('pmMeta').innerHTML=`<span>üìç ${currentProduct.location}</span><span>‚Ä¢</span><span>${currentProduct.date}</span><span>‚Ä¢</span><span>${currentProduct.category}</span>`;
    document.getElementById('pmSeller').textContent=currentProduct.seller;
    document.getElementById('pmSellerAva').textContent=currentProduct.sellerAvatar;
    document.getElementById('pmSellerLine').textContent='Annons: '+currentProduct.short;
    document.getElementById('pmDesc').textContent=currentProduct.description||'Ingen beskrivning.';

    // Status handling
    const isSold=currentProduct.status==='sold';
    const statusBadge=document.getElementById('pmStatus');
    statusBadge.style.display='inline-flex';
    statusBadge.className='status-badge '+(isSold?'status-sold':'status-active');
    statusBadge.textContent=isSold?'S√ÖLD':'AKTIV';

    // Owner actions
    const u=getUser();
    const isOwner=u&&u.id===currentProduct.userId;
    document.getElementById('pmOwnerActions').classList.toggle('hidden',!isOwner);
    document.getElementById('pmMessageBtn').style.display=isOwner?'none':'inline-flex';
    
    // Update sold button state
    const soldBtn=document.getElementById('pmSoldBtn');
    if(isSold){
      soldBtn.textContent='‚Ü© √Öngra s√•ld';
      soldBtn.classList.remove('btn-success');
      soldBtn.classList.add('btn-soft');
    }else{
      soldBtn.textContent='‚úì Markera som s√•ld';
      soldBtn.classList.add('btn-success');
      soldBtn.classList.remove('btn-soft');
    }

    syncModalFavoriteButton();
    renderProductImages();
    show('productModal');
  }

  function syncModalFavoriteButton(){
    const btn=document.getElementById('pmFavBtn');
    const fav=currentProduct?isFavorited(currentProduct.id):false;
    btn.innerHTML=fav?'‚ù§Ô∏è Favoritmarkerad':'ü§ç L√§gg till favorit';
    btn.classList.toggle('btn-danger',fav);
    btn.classList.toggle('btn-soft',!fav);
  }

  function renderProductImages(){
    const main=document.getElementById('pmImg');
    const thumbs=document.getElementById('pmThumbs');
    const imgs=currentProduct.images||[];
    pmIdx=Math.max(0,Math.min(pmIdx,imgs.length-1));
    main.src=imgs[pmIdx];
    thumbs.innerHTML=imgs.map((src,idx)=>`<img src="${src}" class="${idx===pmIdx?'active':''}" onclick="setPmImg(${idx})" alt="" />`).join('');
  }

  function setPmImg(idx){pmIdx=idx;renderProductImages();}

  /* EDIT & DELETE FUNCTIONS */
  function openEdit(id){
    const p=products.find(x=>x.id===id);
    if(!p) return;
    const u=getUser();
    if(!u||u.id!==p.userId){toast('Du kan endast redigera dina egna annonser.');return;}
    
    isEditing=true;
    document.getElementById('sId').value=p.id;
    document.getElementById('sTitle').value=p.title;
    document.getElementById('sPrice').value=p.price;
    document.getElementById('sCat').value=p.category;
    document.getElementById('sLoc').value=p.location;
    document.getElementById('sDesc').value=p.description||'';
    document.getElementById('sellModalTitle').textContent='Redigera annons';
    document.getElementById('publishBtn').textContent='Spara √§ndringar';
    
    sellImgs=[...p.images];
    renderSellPreview();
    hide('productModal');
    show('sellModal');
  }

  function editCurrentProduct(){
    if(!currentProduct) return;
    openEdit(currentProduct.id);
  }

  function markAsSold(){
    if(!currentProduct) return;
    const u=getUser();
    if(!u||u.id!==currentProduct.userId){toast('Endast s√§ljaren kan markera som s√•ld.');return;}
    
    if(currentProduct.status==='sold'){
      // Unmark
      currentProduct.status='active';
      toast('Annons markerad som aktiv igen.');
    }else{
      currentProduct.status='sold';
      toast('Grattis! Annons markerad som s√•ld.');
    }
    saveJSON(LS_PRODUCTS,products);
    hide('productModal');
    applyFilters();
    refreshProfileStats();
    if(!document.getElementById('profilePage').classList.contains('hidden')) setProfileTab('ads');
  }

  function quickMarkSold(id){
    const p=products.find(x=>x.id===id);
    if(!p) return;
    p.status='sold';
    saveJSON(LS_PRODUCTS,products);
    toast('Annons markerad som s√•ld!');
    refreshProfileStats();
    setProfileTab('ads');
    applyFilters();
  }

  function promptDelete(id){
    deleteTargetId=id;
    show('deleteModal');
  }

  function deleteCurrentProduct(){
    if(!currentProduct) return;
    promptDelete(currentProduct.id);
    hide('productModal');
  }

  function confirmDelete(){
    if(!deleteTargetId) return;
    const reason=document.getElementById('deleteReason').value;
    const idx=products.findIndex(p=>p.id===deleteTargetId);
    
    if(idx>-1){
      if(reason==='sold'){
        products[idx].status='sold';
        toast('Annons markerad som s√•ld.');
      }else{
        products[idx].status='deleted';
        products[idx].deleteReason=reason;
        toast('Annons borttagen.');
      }
      saveJSON(LS_PRODUCTS,products);
      applyFilters();
      refreshProfileStats();
      if(!document.getElementById('profilePage').classList.contains('hidden')) setProfileTab('ads');
    }
    
    hide('deleteModal');
    deleteTargetId=null;
  }

  /* FAVORITES */
  function loadFavorites(){
    const u=getUser();
    if(!u) return [];
    return loadJSON(favKey(u.id),[]);
  }

  function saveFavorites(ids){
    const u=getUser();
    if(!u) return;
    saveJSON(favKey(u.id),ids);
  }

  function isFavorited(productId){
    return loadFavorites().includes(productId);
  }

  function toggleFavorite(productId,btn){
    const u=getUser();
    if(!u){toast('Logga in f√∂r att spara favoriter.');openAuth('login');return;}

    let ids=loadFavorites();
    const willBeFav=!ids.includes(productId);
    if(willBeFav){
      ids.push(productId);
      toast('Sparad i favoriter! ‚ù§Ô∏è');
    }else{
      ids=ids.filter(x=>x!==productId);
      toast('Borttagen fr√•n favoriter.');
    }
    saveFavorites(ids);

    if(btn){
      btn.classList.toggle('active',willBeFav);
      btn.textContent=willBeFav?'‚ù§Ô∏è':'ü§ç';
    }
    if(currentProduct&&currentProduct.id===productId) syncModalFavoriteButton();

    refreshProfileStats();
    applyFilters();

    if(!document.getElementById('profilePage').classList.contains('hidden')){
      const favTabActive=document.getElementById('tabFav').classList.contains('active');
      if(favTabActive) setProfileTab('fav');
    }
  }

  function toggleFavoriteFromModal(){
    if(!currentProduct)return;
    toggleFavorite(currentProduct.id,null);
  }
  
  function unfavorite(productId){
    const u=getUser();
    if(!u)return;
    saveFavorites(loadFavorites().filter(x=>x!==productId));
    refreshProfileStats();
    applyFilters();
  }

  /* PUBLIC SELLER PROFILE */
  function openSellerProfileFromModal(){
    if(!currentProduct)return;
    openSellerProfile(currentProduct.seller,currentProduct.sellerAvatar);
  }

  function openSellerProfile(name,ava){
    document.getElementById('sellerTitle').textContent=name;
    document.getElementById('sellerName').textContent=name;
    document.getElementById('sellerAva').textContent=ava||initials(name);

    const stats=getSellerStats(name);
    document.getElementById('sellerStars').innerHTML=renderStars(stats.avg);
    document.getElementById('sellerCounts').textContent=`${stats.count} omd√∂men ‚Ä¢ ${stats.ads} annonser`;

    renderSellerReviews(name);

    const ads=products.filter(p=>p.seller===name&&p.status!=='deleted');
    const box=document.getElementById('sellerAds');
    box.innerHTML=ads.length?ads.map(p=>{
      const isSold=p.status==='sold';
      return `<div class="panel ${isSold?'sold':''}" style="${isSold?'opacity:0.6':''};cursor:${isSold?'default':'pointer'}" onclick="${isSold?'':'hide(\'sellerModal\');openProduct('+p.id+');'}">
        <div class="item" style="border:none;background:transparent">
          <img class="thumb" src="${p.images[0]}" alt="" style="${isSold?'filter:grayscale(1)':''}" />
          <div class="item-main">
            <div class="item-title" style="${isSold?'text-decoration:line-through':''}">${escapeHtml(p.title)} ${isSold?'<span style="color:var(--danger);font-size:12px;margin-left:8px">(S√ÖLD)</span>':''}</div>
            <div class="item-sub">${p.price} kr ‚Ä¢ ${escapeHtml(p.location)}</div>
            ${!isSold?`<div class="item-actions"><button class="btn btn-primary" onclick="event.stopPropagation();hide('sellerModal');openProduct(${p.id});messageSeller();">Skriv till s√§ljare</button></div>`:''}
          </div>
        </div>
      </div>`;
    }).join(''):`<div class="panel panel-pad" style="text-align:center;color:var(--text-secondary)">Inga aktiva annonser fr√•n denna s√§ljare.</div>`;

    show('sellerModal');
  }

  /* SELL */
  function openSell(){
    const u=getUser();
    if(!u){toast('Logga in f√∂r att s√§lja.');openAuth('signup');return;}
    resetSellForm();
    show('sellModal');
  }

  function wireSellUpload(){
    document.getElementById('sImgs').addEventListener('change',async()=>{
      sellImgs=[];
      const files=Array.from(document.getElementById('sImgs').files||[]).slice(0,6);
      if(!files.length){renderSellPreview();return;}
      try{
        sellImgs=await Promise.all(files.map(fileToDataUrl));
        renderSellPreview();
      }catch{
        sellImgs=[];
        toast('Kunde inte l√§sa bilderna.');
        renderSellPreview();
      }
    });
  }

  function renderSellPreview(){
    document.getElementById('sPreview').innerHTML=sellImgs.map((src,idx)=>`<div class="preview-item"><img src="${src}" alt="" /><button onclick="removeSellImg(${idx})" title="Ta bort">‚úï</button></div>`).join('');
  }

  function removeSellImg(idx){sellImgs.splice(idx,1);renderSellPreview();}

  function publish(){
    const u=getUser();
    if(!u){toast('Logga in f√∂r att publicera.');openAuth('login');return;}

    const editId=document.getElementById('sId').value;
    const title=document.getElementById('sTitle').value.trim();
    const priceRaw=document.getElementById('sPrice').value;
    const category=document.getElementById('sCat').value;
    const location=document.getElementById('sLoc').value;
    const description=document.getElementById('sDesc').value.trim();

    if(!title||!priceRaw) return toast('Fyll i titel och pris.');
    const price=parseInt(priceRaw,10);
    if(!Number.isFinite(price)||price<0) return toast('Ogiltigt pris.');
    if(sellImgs.length<1) return toast('L√§gg till minst 1 bild.');

    if(editId){
      // Edit existing
      const idx=products.findIndex(p=>p.id===parseInt(editId));
      if(idx===-1) return toast('Annonsen hittades inte.');
      if(products[idx].userId!==u.id) return toast('Du kan endast redigera egna annonser.');
      
      products[idx]={...products[idx],title,short:title.length>22?title.slice(0,22)+'‚Ä¶':title,price,category,location,description:description||'Ingen beskrivning.',images:[...sellImgs]};
      saveJSON(LS_PRODUCTS,products);
      hide('sellModal');
      toast('Annons uppdaterad!');
    }else{
      // Create new
      const p={
        id:nextId(products),
        title,
        short:title.length>22?title.slice(0,22)+'‚Ä¶':title,
        price,
        category,
        location,
        images:[...sellImgs],
        seller:u.name,
        sellerAvatar:initials(u.name),
        userId:u.id,
        date:'Just nu',
        description:description||'Ingen beskrivning.',
        status:'active'
      };
      products.unshift(p);
      saveJSON(LS_PRODUCTS,products);
      hide('sellModal');
      toast('Annons publicerad! üéâ');
    }
    
    applyFilters();
    refreshProfileStats();
    if(!document.getElementById('profilePage').classList.contains('hidden')) setProfileTab('ads');
  }

  function resetSellForm(){
    isEditing=false;
    document.getElementById('sId').value='';
    document.getElementById('sTitle').value='';
    document.getElementById('sPrice').value='';
    document.getElementById('sDesc').value='';
    document.getElementById('sLoc').value='Stockholm';
    document.getElementById('sCat').value='leksaker';
    document.getElementById('sImgs').value='';
    document.getElementById('sellModalTitle').textContent='Ny annons';
    document.getElementById('publishBtn').textContent='Publicera';
    sellImgs=[];
    renderSellPreview();
  }

  /* CHAT */
  function loadUserData(){
    const u=getUser();
    if(!u){conversations=[];currentChat=null;renderConversations();updateBadge();return;}
    conversations=loadJSON(convKey(u.id),seedConversations());
    saveJSON(convKey(u.id),conversations);
    currentChat=null;
    renderConversations();
    updateBadge();
  }

  function seedConversations(){
    return [{
      id:1,
      productId:1,
      with:'Anna S.',
      avatar:'AS',
      product:'Bugaboo Cameleon 3',
      lastMessage:'Hej! √Ñr vagnen fortfarande till salu?',
      time:'10:30',
      messages:[
        {text:'Hej! √Ñr vagnen fortfarande till salu?',sent:true,time:'10:30'},
        {text:'Hej! Ja, den √§r kvar üòä',sent:false,time:'10:31'}
      ]
    }];
  }

  function saveConversations(){
    const u=getUser();
    if(!u) return;
    saveJSON(convKey(u.id),conversations);
    updateBadge();
    refreshProfileStats();
  }

  function openChatPanel(){
    const u=getUser();
    if(!u){toast('Logga in f√∂r att chatta.');openAuth('login');return;}
    show('chatOverlay');
    show('chat');
    ensureChatLayout();
    renderConversations();
  }

  function closeChatPanel(){
    hide('chatOverlay');
    hide('chat');
    backToConversations();
  }
  
  function isChatOpen(){return document.getElementById('chat').classList.contains('show');}

  function ensureChatLayout(){
    const isMobile=window.innerWidth<=768;
    const main=document.getElementById('chatMain');
    if(isMobile){
      if(currentChat) main.classList.add('active');
      else main.classList.remove('active');
    }else{
      main.classList.add('active');
    }
  }

  function renderConversations(){
    const list=document.getElementById('convList');
    const u=getUser();
    if(!u){
      list.innerHTML='<div style="padding:20px;text-align:center;color:var(--text-secondary)">Logga in f√∂r att se meddelanden.</div>';
      return;
    }
    if(!conversations.length){
      list.innerHTML='<div style="padding:20px;text-align:center;color:var(--text-secondary)">Inga konversationer √§n.</div>';
      return;
    }

    list.innerHTML=conversations.map(c=>`
      <div class="conv ${currentChat&&currentChat.id===c.id?'active':''}" onclick="openChat(${c.id})">
        <div class="seller-badge">${escapeHtml(c.avatar)}</div>
        <div style="min-width:0;flex:1">
          <div style="display:flex;justify-content:space-between;gap:8px;margin-bottom:2px">
            <div class="n">${escapeHtml(c.with)}</div>
            <div class="t">${escapeHtml(c.time)}</div>
          </div>
          <div class="p">${escapeHtml(c.product)} ‚Ä¢ ${escapeHtml(c.lastMessage)}</div>
        </div>
      </div>
    `).join('');
  }

  function openChat(id){
    currentChat=conversations.find(c=>c.id===id);
    if(!currentChat) return;

    document.getElementById('chatEmpty').classList.add('hidden');
    document.getElementById('chatActive').classList.remove('hidden');
    document.getElementById('chatWith').textContent=currentChat.with;
    document.getElementById('chatAva').textContent=currentChat.avatar;
    renderMessages();
    renderConversations();
    ensureChatLayout();
    
    // Focus input on desktop
    if(window.innerWidth>768){
      setTimeout(()=>document.getElementById('msgIn').focus(),100);
    }
  }

  function backToConversations(){
    currentChat=null;
    document.getElementById('chatEmpty').classList.remove('hidden');
    document.getElementById('chatActive').classList.add('hidden');
    renderConversations();
    ensureChatLayout();
  }

  function renderMessages(){
    const box=document.getElementById('msgs');
    if(!currentChat){box.innerHTML='';return;}
    box.innerHTML=currentChat.messages.map(m=>`<div class="msg ${m.sent?'sent':'recv'}">${escapeHtml(m.text)}<div class="time">${escapeHtml(m.time)}</div></div>`).join('');
    box.scrollTop=box.scrollHeight;
  }

  function onEnter(e){if(e.key==='Enter') sendMsg();}

  function sendMsg(){
    if(!currentChat) return;
    const input=document.getElementById('msgIn');
    const text=input.value.trim();
    if(!text) return;
    const t=timeNow();

    currentChat.messages.push({text,sent:true,time:t});
    currentChat.lastMessage=text;
    currentChat.time=t;
    input.value='';
    saveConversations();
    renderMessages();
    renderConversations();

    // Simulate reply
    setTimeout(()=>{
      const replies=['Hej! Ja, den finns kvar üòä','Absolut! N√§r vill du h√§mta?','Toppen ‚Äî jag kan m√∂tas upp i eftermiddag.','Jag kan s√§nka lite om du h√§mtar idag.'];
      const r=replies[Math.floor(Math.random()*replies.length)];
      const t2=timeNow();
      currentChat.messages.push({text:r,sent:false,time:t2});
      currentChat.lastMessage=r;
      currentChat.time=t2;
      saveConversations();
      renderMessages();
      renderConversations();
      if(!isChatOpen()) updateBadge();
    },1200);
  }

  function updateBadge(){
    const b=document.getElementById('msgBadge');
    const u=getUser();
    if(!u){b.style.display='none';return;}
    const count=conversations.length;
    if(count>0){b.textContent=count;b.style.display='flex';}
    else b.style.display='none';
  }

  function messageSeller(){
    const u=getUser();
    if(!u){toast('Logga in f√∂r att kontakta s√§ljaren.');openAuth('login');return;}
    if(!currentProduct) return;
    if(currentProduct.userId===u.id){toast('Detta √§r din egen annons.');return;}
    if(currentProduct.status==='sold'){toast('Denna vara √§r redan s√•ld.');return;}

    let conv=conversations.find(c=>c.productId===currentProduct.id);
    if(!conv){
      conv={
        id:nextId(conversations),
        productId:currentProduct.id,
        with:currentProduct.seller,
        avatar:currentProduct.sellerAvatar,
        product:currentProduct.short,
        lastMessage:'Hej! Jag √§r intresserad av '+currentProduct.short,
        time:'Nyss',
        messages:[{text:'Hej! Jag √§r intresserad av '+currentProduct.short,sent:true,time:'Nyss'}]
      };
      conversations.unshift(conv);
      saveConversations();
    }

    hide('productModal');
    openChatPanel();
    openChat(conv.id);
  }

  /* REVIEWS */
  function loadReviews(sellerName){return loadJSON(reviewsKey(sellerName),[]);}
  function saveReviews(sellerName,revs){saveJSON(reviewsKey(sellerName),revs);}

  function getSellerStats(sellerName){
    const revs=loadReviews(sellerName);
    const count=revs.length;
    const sum=revs.reduce((a,r)=>a+(Number(r.rating)||0),0);
    const avg=count?sum/count:0;
    const ads=products.filter(p=>p.seller===sellerName&&p.status!=='deleted').length;
    return {count,avg,ads};
  }

  function renderStars(avg){
    const v=Math.max(0,Math.min(5,avg||0));
    const full=Math.floor(v+1e-6);
    let html='';
    for(let i=1;i<=5;i++){
      const on=i<=full;
      html+=`<span class="star ${on?'':'muted'}">‚òÖ</span>`;
    }
    const label=v?`${v.toFixed(1)}/5`:'Inga omd√∂men';
    return `<span class="stars" title="${label}">${html}</span><span style="font-size:13px;color:var(--text-secondary);font-weight:600;margin-left:8px">${v?label:'Inga omd√∂men'}</span>`;
  }

  function renderSellerReviews(sellerName){
    const u=getUser();
    const revBox=document.getElementById('sellerReviews');
    const form=document.getElementById('sellerReviewForm');

    const revs=loadReviews(sellerName);
    revBox.innerHTML=revs.length?revs.slice().reverse().map(r=>{
      const filled=Math.max(0,Math.min(5,Number(r.rating)||0));
      const stars='‚òÖ'.repeat(filled)+'<span class="star muted">‚òÖ</span>'.repeat(5-filled);
      return `<div class="panel" style="margin-bottom:12px">
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
          <div style="font-weight:700">${escapeHtml(r.author||'Anonym')}</div>
          <div class="stars">${stars}</div>
        </div>
        <div style="color:var(--text);line-height:1.6">${escapeHtml(r.text||'')}</div>
        <div style="font-size:12px;color:var(--text-secondary);margin-top:8px;font-weight:500">${escapeHtml(r.date||'')}</div>
      </div>`;
    }).join(''):`<div style="text-align:center;padding:20px;color:var(--text-secondary)">Inga omd√∂men √§nnu.</div>`;

    if(!u){
      form.innerHTML='<div style="text-align:center;color:var(--text-secondary);margin-bottom:12px">Logga in f√∂r att l√§mna omd√∂me</div><button class="btn btn-primary" style="width:100%" onclick="openAuth(\'login\')">Logga in</button>';
      window.__activeSellerForReview=null;
      return;
    }

    form.innerHTML=`
      <div style="font-weight:700;margin-bottom:12px">L√§mna omd√∂me</div>
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px">
        <label style="font-weight:600">Betyg:</label>
        <select id="reviewRating" style="width:auto;min-width:100px">
          <option value="5">5 ‚≠ê</option>
          <option value="4">4 ‚≠ê</option>
          <option value="3">3 ‚≠ê</option>
          <option value="2">2 ‚≠ê</option>
          <option value="1">1 ‚≠ê</option>
        </select>
      </div>
      <textarea id="reviewText" rows="3" placeholder="Din kommentar..." style="margin-bottom:12px;resize:vertical"></textarea>
      <button class="btn btn-primary" onclick="submitSellerReview()" style="width:100%">Skicka omd√∂me</button>
    `;
    window.__activeSellerForReview=sellerName;
  }

  function submitSellerReview(){
    const sellerName=window.__activeSellerForReview;
    if(!sellerName) return;
    const u=getUser();
    if(!u){toast('Logga in f√∂r att betygs√§tta.');openAuth('login');return;}

    const rating=parseInt((document.getElementById('reviewRating')||{}).value||'5',10);
    const text=(document.getElementById('reviewText')||{}).value||'';
    if(!text.trim()) return toast('Skriv en kommentar.');

    const revs=loadReviews(sellerName);
    revs.push({author:u.name,rating:Math.max(1,Math.min(5,rating)),text:text.trim(),date:new Date().toLocaleDateString('sv-SE')});
    saveReviews(sellerName,revs);

    const stats=getSellerStats(sellerName);
    document.getElementById('sellerStars').innerHTML=renderStars(stats.avg);
    document.getElementById('sellerCounts').textContent=`${stats.count} omd√∂men ‚Ä¢ ${stats.ads} annonser`;

    renderSellerReviews(sellerName);
    toast('Omd√∂me sparat! ‚≠ê');
  }

  /* MODALS */
  function closeOnBackdrop(e){if(e.target===e.currentTarget) hide(e.currentTarget.id);}
  function closeAllModals(){
    ['productModal','authModal','sellModal','sellerModal','editProfileModal','deleteModal'].forEach(hide);
  }
  function show(id){
    const el=document.getElementById(id);
    el.classList.add('show');
    if(window.innerWidth<=768) document.body.style.overflow='hidden';
  }
  function hide(id){
    const el=document.getElementById(id);
    el.classList.remove('show');
    if(!document.querySelector('.modal.show')) document.body.style.overflow='';
  }

  /* TOAST */
  function toast(msg){
    const t=document.getElementById('toast');
    t.textContent=msg;
    t.classList.add('show');
    clearTimeout(window.__toastT);
    window.__toastT=setTimeout(()=>t.classList.remove('show'),3000);
  }

  /* UTILS */
  function initials(name){
    const parts=String(name||'').trim().split(' ').filter(Boolean);
    if(!parts.length) return '??';
    const a=parts[0][0]||'';
    const b=(parts.length>1?(parts[parts.length-1][0]||''):(parts[0][1]||''));
    return (a+b).toUpperCase();
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}
  function uid(){return 'u_'+Math.random().toString(16).slice(2)+Date.now().toString(16);}
  function nextId(arr){return arr.length?Math.max(...arr.map(x=>x.id))+1:1;}

  function loadJSON(key,fallback){
    try{return JSON.parse(localStorage.getItem(key)||JSON.stringify(fallback));}
    catch{return fallback;}
  }

  function saveJSON(key,val){localStorage.setItem(key,JSON.stringify(val));}

  function fileToDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>resolve(String(r.result));
      r.onerror=()=>reject(new Error('read'));
      r.readAsDataURL(file);
    });
  }

  function timeNow(){
    const d=new Date();
    const hh=String(d.getHours()).padStart(2,'0');
    const mm=String(d.getMinutes()).padStart(2,'0');
    return hh+':'+mm;
  }

  /* SEED */
  function seedProducts(){
    return [
      {id:1,title:'Bugaboo Cameleon 3 - Svart',short:'Bugaboo Cameleon 3',price:2500,category:'barnvagn',location:'Stockholm',images:['https://images.unsplash.com/photo-1566004100631-35d015d6a491?w=800&q=80','https://images.unsplash.com/photo-1520975916090-3105956dac38?w=800&q=80'],seller:'Anna S.',sellerAvatar:'AS',userId:'seed_anna',date:'Idag',description:'V√§l-sk√∂tt Bugaboo Cameleon 3 i svart f√§rg. Inkluderar liggdel, sittdel och regnskydd. R√∂kfritt hem.',status:'active'},
      {id:2,title:'Britax Max-Way Bilbarnstol 9-25kg',short:'Britax Bilbarnstol',price:1200,category:'bilbarnstol',location:'G√∂teborg',images:['https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=800&q=80','https://images.unsplash.com/photo-1520975958221-34b7b7a5f4ac?w=800&q=80'],seller:'Johan P.',sellerAvatar:'JP',userId:'seed_johan',date:'Ig√•r',description:'S√§ker och bekv√§m stol. Aldrig varit med om olycka. Instruktioner ing√•r.',status:'active'},
      {id:3,title:'LEGO Duplo Stor L√•da - 100+ bitar',short:'LEGO Duplo',price:350,category:'leksaker',location:'Malm√∂',images:['https://images.unsplash.com/photo-1585366119957-e9730b6d0f60?w=800&q=80','https://images.unsplash.com/photo-1587654780291-39c9404d746b?w=800&q=80'],seller:'Maria L.',sellerAvatar:'ML',userId:'seed_maria',date:'2 dagar sedan',description:'Stor samling LEGO Duplo. Alla bitar hela och rena. Perfekt f√∂r 1‚Äì5 √•r.',status:'active'},
      {id:4,title:'IKEA Sundvik Spj√§ls√§ng med madrass',short:'IKEA Sundvik',price:800,category:'m√∂bler',location:'Uppsala',images:['https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800&q=80','https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=800&q=80'],seller:'Erik N.',sellerAvatar:'EN',userId:'seed_erik',date:'3 dagar sedan',description:'Vit spj√§ls√§ng med justerbar botten. Madrass ing√•r. Mindre skav men stabil.',status:'active'},
      {id:5,title:'Polarn O. Pyret Vinteroverall 92cl',short:'Vinteroverall 92',price:450,category:'kl√§der',location:'Stockholm',images:['https://images.unsplash.com/photo-1519238263530-99bdd11df2ea?w=800&q=80','https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=800&q=80'],seller:'Sofia K.',sellerAvatar:'SK',userId:'seed_sofia',date:'Idag',description:'Varm och sk√∂n overall. Anv√§nd en s√§song. Reflexdetaljer.',status:'active'}
    ];
  }
</script>
</body>
</html>
